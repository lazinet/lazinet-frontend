<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET ACS Checker (03/12/2025)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist:wght@300..700&family=Instrument+Sans:wght@400..700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root { --primary-color: #FFFFFF; --bg-color: #0F162C; --accent-color: #3F82FB; --text-color: #FFFFFF; --error-color: rgb(230,87,87); --success-color: #34c759; --default-font: "Instrument Sans", sans-serif; --divider-color: #FFFFFF1A; }
        body { font-family: var(--default-font); background: var(--bg-color); color: var(--text-color); }
        .container { max-width: 600px; margin: auto; padding: 20px; text-align: center; }
        #result { padding: 20px; border-radius: 10px; margin: 20px 0; display: none; animation: fadeIn 0.5s; }
        .valid { background: rgba(52,199,89,0.1); border: 1px solid var(--success-color); }
        .invalid { background: rgba(230,87,87,0.1); border: 1px solid var(--error-color); }
        video, canvas, input { max-width: 100%; border-radius: 5px; background: rgba(255,255,255,0.1); border: 1px solid var(--divider-color); color: var(--text-color); }
        button { background: var(--accent-color); color: var(--primary-color); border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; }
        .loading { display: none; color: var(--accent-color); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { #fileInput, #textInput { display: none; } #camera { display: block; } video { width: 100%; } }
        @media (min-width: 769px) { #camera { display: none; } #fileInput, #textInput { display: block; } }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">LAZINET ACS - Xác Thực Sản Phẩm</h1>
        <p class="mb-4">Quét QR hoặc nhập mã để kiểm tra hàng thật/giả.</p>
        
        <div id="textInput">
            <input type="text" id="acsInput" class="form-control mb-3" placeholder="Nhập mã ACS (ví dụ: ACS1A2B3C4D5E)">
            <button class="btn" onclick="checkByText()">Kiểm Tra</button>
        </div>
        <div id="fileInput">
            <input type="file" id="imageFile" class="form-control mb-3" accept="image/*">
            <button class="btn" onclick="checkByFile()">Tải Ảnh QR</button>
        </div>
        
        <div id="camera">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <button class="btn" onclick="startCamera()">Bật Camera</button>
            <button class="btn btn-secondary" onclick="stopCamera()">Dừng</button>
        </div>
        
        <div class="loading mt-3" id="loading">Đang kiểm tra...</div>
        <div id="result"></div>
    </div>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2-D-PeiOqhGZ4Pb8Ut0JnYA2BUqRjX8xdR1ZY240W5MpRPTh8auhsU7hq_B1DT2Nq4Q/exec'; // ← THAY BẰNG URL THỰC TẾ TỪ DEPLOY (từ Configs BaseURL)
        let stream = null;
        
        // Check text
        async function checkByText() {
            const code = document.getElementById('acsInput').value.trim();
            if (!code) return alert('Nhập mã ACS!');
            showLoading(true);
            await checkCode(code);
            showLoading(false);
        }
        
        // Check file
        async function checkByFile() {
            const file = document.getElementById('imageFile').files[0];
            if (!file) return alert('Chọn file ảnh QR!');
            showLoading(true);
            const img = new Image();
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                const acsCode = code ? new URL(code.data).searchParams.get('acs-code') || '' : '';
                if (acsCode) await checkCode(acsCode); else alert('Không đọc được QR!');
                showLoading(false);
            };
            img.src = URL.createObjectURL(file);
        }
        
        // Camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();
                requestAnimationFrame(scanQR);
            } catch (err) { alert('Camera không khả dụng: ' + err.message); }
        }
        function stopCamera() { if (stream) stream.getTracks().forEach(track => track.stop()); stream = null; }
        async function scanQR() {
            if (!stream) return;
            const video = document.getElementById('video');
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    const acsCode = new URL(code.data).searchParams.get('acs-code') || '';
                    if (acsCode) {
                        showLoading(true);
                        await checkCode(acsCode);
                        showLoading(false);
                        stopCamera();
                        return;
                    }
                }
            }
            requestAnimationFrame(scanQR);
        }
        
        // Fetch với 'cors' mode (fix lỗi opaque)
        async function checkCode(code) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout
                const response = await fetch(`${SCRIPT_URL}?acs-code=${encodeURIComponent(code)}`, {
                    method: 'GET',
                    mode: 'cors',  // ← FIX: Chuyển sang 'cors' để đọc JSON thật (valid/invalid)
                    credentials: 'omit',
                    signal: controller.signal
                });
                clearTimeout(timeout);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();  // Bây giờ đọc được body
                showResult(data);
                
            } catch (err) {
                console.error('Fetch error:', err);
                // Fallback KHÔNG assume valid: Show lỗi chung (không phân biệt thật/giả)
                showResult({ 
                    valid: false, 
                    message: err.name === 'AbortError' ? 'Timeout - Thử lại sau!' : 
                             (err.message.includes('CORS') ? 'CORS error: Host HTML trên server cùng domain.' : 
                              'Lỗi kết nối. Kiểm tra SCRIPT_URL hoặc liên hệ LAZINET.')
                });
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showResult(data) {
            const result = document.getElementById('result');
            if (data.valid) {
                result.innerHTML = `
                    <div class="valid">
                        <h2>${data.title || 'Sản Phẩm LAZINET'}</h2>
                        <p>${data.description || 'Mô tả sản phẩm chính hãng.'}</p>
                        <p><strong>${data.affirmation || 'HÀNG THẬT!'}</strong></p>
                        <p>Quét: ${data.scans || 0} lần | Trạng thái: ${data.status || 'Active'}</p>
                        <a href="${data.productUrl || 'https://lazinet.com'}" class="btn mt-2">Xem Sản Phẩm</a>
                    </div>
                `;
            } else {
                result.innerHTML = `<div class="invalid"><h2>${data.message || 'Mã không hợp lệ - Hàng NHÁI!'}</h2></div>`;
            }
            result.style.display = 'block';
            result.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>