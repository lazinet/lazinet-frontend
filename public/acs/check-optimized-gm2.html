<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator & Scanner Tích Hợp</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load QRCode.js library for Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Load jsQR library for Scanning/Decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.1.0/dist/jsQR.min.js"></script>
    
    <style>
        /* Thiết lập font Inter mặc định và giao diện nền */
        body { font-family: 'Inter', sans-serif; }
        .container-layout {
            min-height: 100vh;
            background-color: #f3f4f6;
            padding: 1.5rem 1rem;
        }
        /* Đảm bảo khung QR không bị tràn */
        #qrcode img {
            margin: 0 auto;
        }
        /* Ẩn input file mặc định */
        #qrFileInput {
            display: none;
        }
        /* Custom style cho nút Tải ảnh/Chụp hình */
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out;
        }
    </style>
</head>
<body class="container-layout flex justify-center items-start lg:items-center">

    <div id="appContainer" class="w-full max-w-5xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100 transition-all duration-300">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
            Công Cụ Quét, Tạo & Kiểm Tra Mã QR
        </h1>
        <p class="text-sm text-center text-gray-500 mb-8">
            Tự động tạo mã, tự động kiểm tra và quét/giải mã ảnh.
        </p>

        <!-- Bố cục 2 cột (hoặc xếp chồng trên mobile) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Cột 1: Tạo Mã & Kiểm Tra Backend -->
            <div class="space-y-6 p-4 border border-gray-200 rounded-lg bg-white shadow-md">
                <h2 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">1. Tạo Mã QR & Kiểm Tra</h2>
                
                <!-- Form nhập liệu -->
                <div class="space-y-4">
                    <label for="code" class="block text-sm font-medium text-gray-700">Chuỗi Mã (Text to QR)</label>
                    <input 
                        type="text" 
                        id="code" 
                        placeholder="Nhập mã ở đây (ví dụ: LAZINET-1234)" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                        maxlength="50"
                        oninput="debounceGenerateAndSubmit()"
                        onkeydown="if(event.key === 'Enter') submitCode()"
                    >
                </div>

                <!-- Khu vực hiển thị QR Code -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
                    <h3 class="text-lg font-medium text-gray-700 mb-4">Mã QR Code</h3>
                    <div id="qrcode" class="flex justify-center items-center p-2">
                        <!-- QR Code sẽ được render tại đây -->
                        <p id="qrPlaceholder" class="text-gray-400 italic">Mã QR sẽ xuất hiện khi bạn nhập chuỗi.</p>
                    </div>
                    <p id="qrCodeValue" class="text-xs mt-2 text-gray-500 break-all h-4"></p>
                </div>

                <!-- Nút Submit và Loading -->
                <button 
                    id="submitBtn"
                    onclick="submitCode()"
                    class="w-full flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-blue-400"
                    disabled
                >
                    <svg id="loadingSpinner" class="hidden animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="buttonText">Kiểm Tra Mã Hợp Lệ (Backend)</span>
                </button>

                <!-- Khu vực hiển thị kết quả Backend -->
                <div id="resultBox" class="hidden p-4 text-left rounded-lg transition duration-300 ease-in-out">
                    <p id="resultElement" class="text-lg font-bold text-center mb-1"></p>
                    <div id="resultDetailsArea" class="space-y-1 text-sm text-gray-700">
                        <p id="resultCodeText"><span class="font-medium">Mã đã kiểm tra:</span> <span class="font-bold"></span></p>
                        <p id="resultStatusText"><span class="font-medium">Trạng thái:</span> <span></span></p>
                        <p id="resultTimeText"><span class="font-medium">Thời gian kiểm tra:</span> <span></span></p>
                        <p id="resultLinkText"><span class="font-medium">Link sản phẩm:</span> <a href="https://lazinet.com/lazinet-support-pricing.html" target="_blank" class="text-blue-500 hover:underline">https://lazinet.com/lazinet-support-pricing.html</a></p>
                    </div>
                </div>
            </div>

            <!-- Cột 2: Quét Mã QR (Scanner) -->
            <div class="space-y-6 p-4 border border-gray-200 rounded-lg bg-white shadow-md">
                <h2 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">2. Quét & Tải Ảnh QR</h2>

                <!-- Nút Tải ảnh/Chụp hình -->
                <input type="file" id="qrFileInput" accept="image/*" capture="camera" onchange="decodeQR(event)">
                <label for="qrFileInput" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                    </svg>
                    Tải Ảnh QR Code / Chụp Hình
                </label>

                <!-- Khu vực hiển thị ảnh được tải lên (hoặc không gian trực quan) -->
                <div id="scannerArea" class="relative w-full h-64 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex justify-center items-center text-center overflow-hidden">
                    <img id="scannedImagePreview" class="max-w-full max-h-full object-contain hidden" alt="Preview ảnh QR">
                    <canvas id="qrCanvas" class="hidden w-full h-full"></canvas>
                    <p id="scannerPlaceholder" class="text-gray-400 italic p-4">
                        Tải lên ảnh (PNG/JPG) chứa QR Code để giải mã chuỗi mã. Mã sẽ tự động được điền và kiểm tra.
                    </p>
                </div>

                <!-- Kết quả quét -->
                <div id="scanResultBox" class="hidden p-4 text-center rounded-lg border border-gray-300 bg-gray-50">
                    <p class="text-sm font-medium text-gray-700">Chuỗi mã được quét thành công:</p>
                    <p id="scanResultText" class="text-base font-bold text-green-600 break-all mt-1"></p>
                </div>
                
                <!-- Khu vực thông báo lỗi Scanner -->
                <div id="scanErrorBox" class="hidden p-4 text-center rounded-lg border border-red-300 bg-red-100">
                    <p id="scanErrorText" class="text-sm font-bold text-red-700"></p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // Cấu hình chung và khởi tạo DOM
        let qrcodeInstance = null;
        let debounceTimer; // Timer cho debounce
        const DEBOUNCE_DELAY = 500; // 0.5 giây
        
        const inputCode = document.getElementById('code');
        const qrcodeDiv = document.getElementById('qrcode');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const qrCodeValue = document.getElementById('qrCodeValue');
        const submitBtn = document.getElementById('submitBtn');
        const resultBox = document.getElementById('resultBox');
        const resultElement = document.getElementById('resultElement');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        
        // Cấu hình Scanner DOM
        const qrFileInput = document.getElementById('qrFileInput');
        const scannedImagePreview = document.getElementById('scannedImagePreview');
        const scannerPlaceholder = document.getElementById('scannerPlaceholder');
        const qrCanvas = document.getElementById('qrCanvas');
        const scanResultBox = document.getElementById('scanResultBox');
        const scanResultText = document.getElementById('scanResultText');
        const scanErrorBox = document.getElementById('scanErrorBox');
        const scanErrorText = document.getElementById('scanErrorText');

        // Chi tiết kết quả mới
        const resultCodeText = document.querySelector('#resultDetailsArea #resultCodeText span:last-child');
        const resultStatusText = document.querySelector('#resultDetailsArea #resultStatusText span:last-child');
        const resultTimeText = document.querySelector('#resultDetailsArea #resultTimeText span:last-child');

        // URL backend TỐT 
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxHdbTVB5bNvSTRZqORVjdgb1mk7NUzyxlkY41btZBNNCqqoqHRqcKvBRxBdzvRZHiv/exec';

        // --- HÀM HỖ TRỢ ---

        /**
         * Debounce cho việc tạo và kiểm tra QR.
         */
        function debounceGenerateAndSubmit() {
            const code = inputCode.value.trim();
            generateQR(code); // Luôn cập nhật QR
            
            clearTimeout(debounceTimer);
            
            if (code.length > 0) {
                // Tự động submit sau DEBOUNCE_DELAY ms
                debounceTimer = setTimeout(() => {
                    submitCode();
                }, DEBOUNCE_DELAY);
            } else {
                resultBox.classList.add('hidden');
                submitBtn.disabled = true; 
            }
        }

        /**
         * Định dạng ngày giờ hiện tại.
         */
        function formatCurrentTime() {
            return new Date().toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // --- CHỨC NĂNG TẠO VÀ KIỂM TRA QR ---

        /**
         * Tạo hoặc cập nhật QR Code ngay lập tức khi người dùng nhập.
         * @param {string} code Chuỗi mã cần tạo.
         */
        function generateQR(code) {
            code = code || inputCode.value.trim();
            qrCodeValue.textContent = code;
            
            if (code.length > 0) {
                qrPlaceholder.classList.add('hidden');
                submitBtn.disabled = false;
                
                if (qrcodeInstance) {
                    qrcodeDiv.innerHTML = '';
                    qrcodeInstance = null;
                }

                try {
                    qrcodeInstance = new QRCode(qrcodeDiv, {
                        text: code,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                } catch (e) {
                    console.error("Lỗi khi tạo QR Code:", e);
                }

            } else {
                submitBtn.disabled = true;
                if (qrcodeInstance) {
                    qrcodeDiv.innerHTML = ''; 
                    qrcodeInstance = null;
                }
                qrPlaceholder.classList.remove('hidden'); 
            }
        }

        /**
         * Gửi mã đến Google Apps Script để kiểm tra.
         */
        async function submitCode() {
            const code = inputCode.value.trim();
            
            // Ngăn chặn submit nếu không có mã hoặc đang loading
            if (!code || loadingSpinner.classList.contains('animate-spin')) {
                return;
            }

            // Xóa debounce timer nếu submit được gọi thủ công (bằng nút hoặc Enter)
            clearTimeout(debounceTimer); 

            toggleLoading(true);
            resultBox.classList.add('hidden');

            try {
                // Sử dụng text/plain để bypass CORS preflight request (đã được xác nhận là hoạt động)
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify({ code: code })
                });
                
                if (!response.ok) {
                    throw new Error(`Lỗi mạng, trạng thái: ${response.status}`);
                }
                
                const data = await response.json();
                handleResponse(data, code); // Truyền code vào để hiển thị

            } catch (error) {
                console.error("Lỗi Fetch hoặc Backend:", error);
                displayMessage(`⚠️ Lỗi Kết Nối/Xử Lý`, 'error', code, `Chi tiết: ${error.message}. Vui lòng kiểm tra console.`);
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Xử lý kết quả trả về từ Apps Script.
         * @param {Object} data Dữ liệu JSON từ backend.
         * @param {string} code Chuỗi mã được gửi đi (từ frontend).
         */
        function handleResponse(data, code) {
            if (data.error) {
                displayMessage(`❌ LỖI HỆ THỐNG`, 'error', code, `Chi tiết: ${data.error}`);
            } else if (data.valid) {
                // SỬA LỖI: Luôn lấy code từ frontend và statusDetail cố định
                displayMessage('✅ MÃ HỢP LỆ!', 'success', code, `Xác nhận: Mã hợp lệ.`);
            } else {
                displayMessage('❌ MÃ KHÔNG HỢP LỆ!', 'invalid', code, `Xác nhận: Mã không hợp lệ.`);
            }
        }

        /**
         * Hiển thị thông báo kết quả kiểm tra Backend.
         */
        function displayMessage(title, type, code, statusDetail = '') {
            resultBox.classList.remove('hidden');
            resultElement.textContent = title;
            
            // Cập nhật chi tiết kết quả
            resultCodeText.textContent = code;
            resultStatusText.textContent = statusDetail;
            resultTimeText.textContent = formatCurrentTime();

            let baseClasses = 'p-4 rounded-lg transition duration-300 ease-in-out';
            
            switch (type) {
                case 'success':
                    resultElement.className = 'text-lg text-green-700 font-bold text-center mb-1';
                    resultBox.className = `${baseClasses} border border-green-300 bg-green-100`;
                    break;
                case 'error': // Lỗi hệ thống/kết nối
                    resultElement.className = 'text-lg text-red-700 font-bold text-center mb-1';
                    resultBox.className = `${baseClasses} border border-red-300 bg-red-100`;
                    break;
                case 'invalid': // Mã không hợp lệ/không tìm thấy
                    resultElement.className = 'text-lg text-red-600 font-bold text-center mb-1';
                    resultBox.className = `${baseClasses} border border-red-300 bg-red-100`;
                    break;
                default:
                    resultElement.className = 'text-lg text-yellow-700 font-bold text-center mb-1';
                    resultBox.className = `${baseClasses} border border-yellow-300 bg-yellow-100`;
                    break;
            }
        }

        /**
         * Bật/Tắt trạng thái loading cho nút Submit.
         */
        function toggleLoading(isLoading) {
            // Nếu đang load, vô hiệu hóa input
            inputCode.disabled = isLoading;
            submitBtn.disabled = isLoading || !inputCode.value.trim();
            
            if (isLoading) {
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // --- CHỨC NĂNG QUÉT (SCANNER) ---

        /**
         * Xử lý sự kiện tải file ảnh/chụp hình.
         */
        function decodeQR(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Đặt lại trạng thái Scanner
            scanErrorBox.classList.add('hidden');
            scanResultBox.classList.add('hidden');
            scannerPlaceholder.classList.add('hidden');
            scannedImagePreview.classList.add('hidden');
            qrCanvas.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Hiển thị ảnh preview
                    scannedImagePreview.src = e.target.result;
                    scannedImagePreview.classList.remove('hidden');
                    
                    try {
                        processImageForQR(img);
                    } catch (err) {
                        displayScanError("Lỗi xử lý ảnh: " + err.message);
                    }
                };
                img.onerror = () => {
                    displayScanError("Không thể tải ảnh. Vui lòng thử lại.");
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * Dùng Canvas và jsQR để giải mã chuỗi mã QR từ ảnh.
         * @param {Image} img Đối tượng Image đã tải.
         */
        function processImageForQR(img) {
            const context = qrCanvas.getContext('2d');
            
            // Thiết lập kích thước Canvas bằng kích thước ảnh để đảm bảo chất lượng quét
            qrCanvas.width = img.naturalWidth;
            qrCanvas.height = img.naturalHeight;
            
            context.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
            
            const imageData = context.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
            
            // Sử dụng jsQR để quét
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code && code.data) {
                // Hiển thị kết quả quét thành công
                scanResultBox.classList.remove('hidden');
                scanResultText.textContent = code.data;

                // Tự động điền và kiểm tra ngay lập tức
                inputCode.value = code.data;
                generateQR(code.data); // Tạo QR Code mới ngay lập tức
                submitCode(); // Tự động kiểm tra backend

                // Cuộn lên để người dùng thấy kết quả
                inputCode.focus(); 
            } else {
                displayScanError("Không tìm thấy QR Code hợp lệ trong ảnh.");
            }
        }

        /**
         * Hiển thị thông báo lỗi khi quét QR.
         */
        function displayScanError(message) {
            scanErrorBox.classList.remove('hidden');
            scanErrorText.textContent = message;
            scannerPlaceholder.classList.remove('hidden');
            scannedImagePreview.classList.add('hidden');
            scanResultBox.classList.add('hidden');
        }


        // Khởi tạo ban đầu
        window.onload = () => {
             // Kích hoạt generateQR lần đầu để thiết lập trạng thái nút và placeholder
            generateQR(); 
        };

    </script>
</body>
</html>