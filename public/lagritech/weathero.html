<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <title>Ứng dụng Thời tiết Cà Phê - LAZINET</title>
    <meta name="description"
        content="Theo dõi thời tiết tối ưu cho cây cà phê tại Việt Nam với bản đồ tương tác, dự báo chi tiết, và khuyến nghị nông nghiệp từ LAZINET.">
    <meta name="keywords"
        content="thời tiết cà phê, dự báo thời tiết Việt Nam, nông nghiệp cà phê, LAZINET, thời tiết nông nghiệp">
    <meta name="author" content="LAZINET">
    <meta name="robots" content="index, follow">
    <!-- Open Graph -->
    <meta property="og:title" content="Ứng dụng Thời tiết Cà Phê - LAZINET">
    <meta property="og:description"
        content="Ứng dụng thời tiết giúp nông dân cà phê theo dõi thời tiết, dự báo, và nhận khuyến nghị tối ưu từ LAZINET.">
    <meta property="og:image" content="https://lazinet.com/assets/img/lazinet_LogoFullv2.png">
    <meta property="og:url" content="https://lazinet.com">
    <meta property="og:type" content="website">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://lazinet.com/assets/img/lazinet_LogoOnly.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lazinet-orange': '#FF6F00',
                        'lazinet-blue': '#0000FF',
                        'lazinet-green': '#00FF00'
                    }
                }
            }
        }
    </script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet plugins CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Plotly JS -->
    <!-- <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script> -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map {
            height: 500px;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-container {
            overflow-x: auto;
        }

        .icon-hover:hover {
            color: #FF6F00;
            transform: scale(1.2);
        }

        .measure-control {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>');
        }

        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
        }

        @media (min-width: 1024px) {
            #map {
                height: calc(100% - 1.5rem);
            }
        }

        @media (max-width: 1023px) {
            #map {
                height: 50vh;
            }

            .map-container {
                overflow: visible;
            }
        }

        .custom-arrow {
            font-size: 0.8rem;
            line-height: 1;
            width: 1.2rem;
            height: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .leaflet-control-geocoder-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><g transform="translate(15, 15), scale(0.7)"><g id="SVGRepo_iconCarrier"><path d="M36.277 13.297c-6.698 0-12.185 5.471-12.185 12.15c0 2.588.825 4.994 2.224 6.971l8.473 11.494c1.187 1.55 1.978 1.256 2.965-.082l9.348-12.75a6.87 6.87 0 0 0 .464-1.074c.577-1.41.897-2.95.897-4.559c0-6.679-5.487-12.15-12.186-12.15zm0 5.693c3.607 0 6.477 2.86 6.477 6.457s-2.87 6.46-6.477 6.46s-6.476-2.863-6.476-6.46c0-3.596 2.87-6.457 6.476-6.457z" fill="%23FF6F00"/><path d="M37.18.178c-9.53 0-19.061 3.623-26.309 10.87c-14.495 14.496-14.495 38.123 0 52.618C24.44 77.234 45.97 78.032 60.557 66.193l3.576 3.577a3.956 5.958 45 0 0 .646 3.613L90.73 99.334a3.956 5.958 45 0 0 7.01-1.416a3.956 5.958 45 0 0 1.416-7.01l-25.95-25.951a3.956 5.958 45 0 0-3.616-.646l-3.576-3.577c11.839-14.587 11.043-36.117-2.526-49.685C56.241 3.8 46.71.178 37.18.178zm0 8.217c7.397 0 14.795 2.834 20.463 8.501a28.875 28.875 0 0 1 0 40.924a28.875 28.875 0 0 1-40.924 0a28.875 28.875 0 0 1 0-40.924c5.667-5.667 13.064-8.501 20.46-8.501z" fill="blue"/><path d="M29.727 52.003L19.439 55.38a25.527 25.527 0 0 0 16.102 7.119z" fill="%23FF6F00"/><path d="M62.492 41.253l-25.476 8.36l6.705 12.1a25.637 25.637 0 0 0 9.828-5.054a25.543 25.543 0 0 0 8.943-15.406z" fill="%23FF6F00"/><path d="M11.674 34.38a25.53 25.53 0 0 0 2.94 14.65l9.52-3.123z" fill="%23FF6F00"/><path d="M60.002 25.146l-5.303 10.732l7.916-2.596a25.486 25.486 0 0 0-2.613-8.136z" fill="%23FF6F00"/></g></g></svg>');
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <header class="bg-white text-blue shadow-md">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row items-center justify-between py-3 md:py-4">
            <!-- Logo - Hiển thị trên mọi kích thước -->
            <div class="w-full md:w-1/5 flex justify-center md:justify-start mb-2 md:mb-0">
                <a href="https://lazinet.com/" target="_blank" class="flex-shrink-0">
                    <img src="https://lazinet.com/assets/img/lazinet_LogoFullv2.png" 
                         alt="LAZINET Logo" 
                         class="h-10 md:h-12 lg:h-14 object-contain">
                </a>
            </div>

            <!-- Tiêu đề chính - Điều chỉnh cho mobile -->
            <div class="w-full md:w-3/5 flex justify-center px-2">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-center text-lazinet-blue whitespace-nowrap">
                    Ứng dụng Thời tiết Cà Phê - 
                    <span class="text-lazinet-orange">LAZI</span>NET
                </h1>
            </div>

            <!-- Tagline - Ẩn trên mobile -->
            <div class="hidden md:flex md:w-1/5 justify-end">
                <span class="text-sm lg:text-base xl:text-lg font-semibold text-lazinet-orange whitespace-nowrap">
                    CÔNG NGHỆ HIỆU QUẢ
                </span>
            </div>
        </div>
    </div>
</header>

    <div class="container mx-auto p-4">
        <p class="text-center text-gray-600 mb-6">Nhấp vào bản đồ để chọn vị trí và xem thông tin thời tiết</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Map -->
            <div class="lg:col-span-2 map-container">
                <div id="map" class="rounded-lg shadow-lg"></div>
            </div>

            <!-- Sidebar -->
            <div id="sidebar" class="space-y-4">
                <!-- Location Card -->
                <div id="location-card" class="card bg-white p-6 rounded-lg shadow-md fade-in">
                    <h2 class="text-xl font-semibold text-lazinet-orange mb-4 flex items-center">
                        <i class="bi bi-geo-alt-fill mr-2 icon-hover transition-transform"></i> THÔNG TIN VỊ TRÍ
                    </h2>
                    <ul class="space-y-2">
                        <li id="address" class="text-gray-700 flex items-center">
                            <i class="bi bi-map-fill mr-2 text-lazinet-blue"></i>
                            <span class="ml-2"><span></span></span>
                        </li>
                        <li id="lat" class="text-gray-700 flex items-center">
                            <i class="bi bi-geo-alt mr-2 text-lazinet-blue"></i>
                            <strong>Vĩ độ:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="lon" class="text-gray-700 flex items-center">
                            <i class="bi bi-geo-alt mr-2 text-lazinet-blue"></i>
                            <strong>Kinh độ:</strong> <span class="ml-2"><span></span></span>
                        </li>
                    </ul>
                </div>

                <!-- Weather Card -->
                <div id="weather-card" class="card bg-white p-6 rounded-lg shadow-md fade-in">
                    <h2 class="text-xl font-semibold text-lazinet-orange mb-4 flex items-center">
                        <i class="bi bi-cloud-fill mr-2 icon-hover transition-transform"></i> THỜI TIẾT HIỆN TẠI
                    </h2>
                    <ul class="space-y-2">
                        <li id="weather-location" class="text-gray-700 flex items-center">
                            <i class="bi bi-map-fill mr-2 text-lazinet-blue"></i>
                            <strong>Địa điểm:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-time" class="text-gray-700 flex items-center">
                            <i class="bi bi-clock-fill mr-2 text-lazinet-blue"></i>
                            <strong>Thời gian:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-condition" class="text-gray-700 flex items-center">
                            <i class="bi bi-cloud-sun-fill mr-2 text-lazinet-blue"></i>
                            <strong>Mô tả:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-temp" class="text-gray-700 flex items-center">
                            <i class="bi bi-thermometer-half mr-2 text-lazinet-blue"></i>
                            <strong>Nhiệt độ:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-humidity" class="text-gray-700 flex items-center">
                            <i class="bi bi-droplet-fill mr-2 text-lazinet-blue"></i>
                            <strong>Độ ẩm:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-precip" class="text-gray-700 flex items-center">
                            <i class="bi bi-cloud-rain-fill mr-2 text-lazinet-blue"></i>
                            <strong>Lượng mưa:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-wind" class="text-gray-700 flex items-center">
                            <i class="bi bi-wind mr-2 text-lazinet-blue"></i>
                            <strong>Mức gió:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-cloud" class="text-gray-700 flex items-center">
                            <i class="bi bi-clouds-fill mr-2 text-lazinet-blue"></i>
                            <strong>Mây phủ:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-vis" class="text-gray-700 flex items-center">
                            <i class="bi bi-eye-fill mr-2 text-lazinet-blue"></i>
                            <strong>Tầm nhìn:</strong> <span class="ml-2"><span></span></span>
                        </li>
                        <li id="weather-uv" class="text-gray-700 flex items-center">
                            <i class="bi bi-sun-fill mr-2 text-lazinet-blue"></i>
                            <strong>Tử ngoại (UV):</strong> <span class="ml-2"><span></span></span>
                        </li>
                    </ul>
                </div>

                <!-- Recommendations Card -->
                <div id="recommendations-card" class="card bg-white p-6 rounded-lg shadow-md fade-in">
                    <h2 class="text-xl font-semibold text-lazinet-orange mb-4 flex items-center">
                        <i class="bi bi-leaf-fill mr-2 icon-hover transition-transform"></i> KHUYẾN NGHỊ CHO CÀ PHÊ
                    </h2>
                    <ul id="recommendations">
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div id="chart-card" class="card bg-white p-4 md:p-6 rounded-lg shadow-md mt-4 md:mt-6 fade-in">
            <h2 class="text-lg md:text-xl font-semibold text-lazinet-orange mb-3 md:mb-4 flex items-center">
                <i class="bi bi-graph-up mr-2 icon-hover transition-transform"></i> BIỂU ĐỒ THỜI TIẾT
            </h2>
            <div class="chart-container">
                <canvas id="weather-chart"></canvas>
            </div>
        </div>

        <!-- Forecast Table -->
        <div id="table-card" class="card bg-white p-6 rounded-lg shadow-md mt-6 fade-in">
            <h2 class="text-xl font-semibold text-lazinet-orange mb-4 flex items-center">
                <i class="bi bi-table mr-2 icon-hover transition-transform"></i> DỰ BÁO THỜI TIẾT
            </h2>
            <div class="table-container">
                <table id="forecast-table" class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-lazinet-orange text-white">
                            <th class="py-2 px-4 border-b text-left">Thời gian</th>
                            <th class="py-2 px-4 border-b text-left">Nhiệt độ (°C)</th>
                            <th class="py-2 px-4 border-b text-left">Độ ẩm (%)</th>
                            <th class="py-2 px-4 border-b text-left">Lượng mưa (mm/h)</th>
                            <th class="py-2 px-4 border-b text-left">Thời tiết</th>
                        </tr>
                    </thead>
                    <tbody id="forecast-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-6 fade-in" role="alert">
            <span id="error-text"></span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet plugins JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>

    <script>
        // Initialize map
        const map = L.map('map', {
            center: [17.002871, 107.052361],
            zoom: 6,
            minZoom: 4,
            maxZoom: 18,
            // maxBounds: [[8.0, 102.0], [23.0, 110.0]],
            worldCopyJump: true
        });

        // Base maps
        const baseMaps = {
            "Bản đồ Mặc định": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                // attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            "Vệ tinh": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                // attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            "Giao thông": L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=a61706a0e2424a7b9e1b6d5a8d7a1b1c', {
                // attribution: '&copy; <a href="https://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            "Địa hình": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                // attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            }),
            // "Google": L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            // subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            // })

        };

        

        // Overlay maps (agricultural data) - Phiên bản đã sửa lỗi
        // Nếu bạn muốn thêm các lớp độ sâu khác (ví dụ 5-15cm), chỉ cần thay đổi tham số layers:
        // L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/phh2o.map", {
        //     layers: 'phh2o_5-15cm_mean',
        //     các option khác
        // })

        const overlayMaps = {
                "Độ pH đất": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/phh2o.map", {
                    layers: 'phh2o_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Hàm lượng Nitơ (cg/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/nitrogen.map", {
                    layers: 'nitrogen_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Mật độ Carbon hữu cơ (hg/m³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/ocd.map", {
                    layers: 'ocd_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Khả năng trao đổi cation, mmol(c)/kg": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/cec.map", {
                    layers: 'cec_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),

                // Thuộc tính vật lý
                "Độ chặt đất (cg/cm³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/bdod.map", {
                    layers: 'bdod_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Đất sét (g/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/clay.map", {
                    layers: 'clay_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Cát (g/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/sand.map", {
                    layers: 'sand_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
                "Đá vụn (cm³/dm³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/cfvo.map", {
                    layers: 'cfvo_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
                }),
            };

        // Hàm lấy dữ liệu đất tại vị trí click
        async function getSoilDataAtPoint(lat, lng) {
            try {
                const response = await fetch(`https://rest.soilgrids.org/soilgrids/v2.0/properties/query?lon=${lng}&lat=${lat}&property=phh2o&property=nitrogen&property=soc&property=ocd&property=ocs&property=cec&depth=0-5cm&value=mean`);
                const data = await response.json();

                if (data.properties) {
                    return {
                        ph: data.properties.phh2o.mean / 10,
                        nitrogen: data.properties.nitrogen.mean,
                        soc: data.properties.soc.mean,
                        ocd: data.properties.ocd.mean,
                        ocs: data.properties.ocs.mean,
                        cec: data.properties.cec.mean
                    };
                }
                return null;
            } catch (error) {
                console.error("Lỗi khi lấy dữ liệu đất:", error);
                return null;
            }
        }

        // Xử lý sự kiện click bản đồ
        map.on('click', async function (e) {
            const soilData = await getSoilDataAtPoint(e.latlng.lat, e.latlng.lng);

            if (soilData) {
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(`
                        <b>Thông số đất</b><br>
                        Độ pH: ${soilData.ph.toFixed(1)}<br>
                        Nitơ: ${soilData.nitrogen} cg/kg<br>
                        Carbon hữu cơ: ${soilData.soc} dg/kg<br>
                        Mật độ Carbon: ${soilData.ocd} hg/m³<br>
                        Dự trữ Carbon: ${soilData.ocs} t/ha<br>
                        CEC: ${soilData.cec} mmol(c)/kg
                    `)
                    .openOn(map);
            } else {
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent("Không thể lấy dữ liệu đất tại vị trí này")
                    .openOn(map);
            }
        });

        // Add default base map
        baseMaps["Bản đồ Mặc định"].addTo(map);

        // Add layer control
        // L.control.layers(baseMaps, overlayMaps, {
        //     position: 'bottomright',
        //     collapsed: false,
        //     autoZIndex: true
        // }).addTo(map);

        

        // // Tùy chỉnh CSS sau khi thêm control
        // const layerControl = document.querySelector('.leaflet-control-layers');
        // if (layerControl) {
        //     layerControl.style.width = 'clamp(120px, 24vw, 240px)';
        //     layerControl.style.fontSize = 'clamp(6px, 1.2vw, 12px)';
        //     layerControl.style.backgroundColor = '#f8f9fa';
        //     layerControl.style.borderRadius = '5px';
        //     layerControl.style.padding = '8px';
        //     layerControl.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';

        //     // Thêm min-width và max-width để đảm bảo khả năng đọc
        //     layerControl.style.minWidth = '150px';
        //     layerControl.style.maxWidth = '250px';

        //     // Đảm bảo text không bị tràn
        //     layerControl.style.overflow = 'hidden';
        //     layerControl.style.textOverflow = 'ellipsis';
        // }

        // Tạo một custom control cho logo
        L.Control.Logo = L.Control.extend({
            onAdd: function (map) {
                const img = L.DomUtil.create('img');
                img.src = 'https://lazinet.com/assets/img/lazinet_LogoFullv2.png'; // Thay bằng URL logo
                img.style.width = '150px'; // Điều chỉnh kích thước
                img.style.height = 'auto';
                img.style.padding = '5px';
                img.style.background = 'rgba(255,255,255,0.5)'; // Nền trong suốt
                return img;
            }
        });

        // Thêm logo vào bản đồ
        new L.Control.Logo({
            position: 'bottomleft' // Vị trí: góc trái dưới
        }).addTo(map);

        // Add marker
        let marker = L.marker([17.002871, 107.052361]).addTo(map);
        let currentLatLng = marker.getLatLng();

        // Function to handle map click
        function handleMapClick(e) {
            currentLatLng = e.latlng;
            if (marker) {
                marker.setLatLng(currentLatLng)
                    .setPopupContent("Đang tải dữ liệu thời tiết...")
                    .openPopup();
            } else {
                marker = L.marker(currentLatLng).addTo(map)
                    .bindPopup("Đang tải dữ liệu thời tiết...")
                    .openPopup();
            }
            fetchWeatherData(currentLatLng.lat, currentLatLng.lng);
        }

        // Add click event to map
        map.on('click', handleMapClick);

        // Add search control
        const geocoder = L.Control.geocoder({
            position: 'topright',
            placeholder: 'Tìm kiếm địa điểm...',
            errorMessage: 'Không tìm thấy địa điểm.',
            showResultIcons: true,
            collapsed: false,
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function (e) {
            const { center, name } = e.geocode;
            currentLatLng = center;
            if (marker) {
                marker.setLatLng(center)
                    .setPopupContent(`<b>${name}</b><br>Đang tải dữ liệu...`)
                    .openPopup();
            } else {
                marker = L.marker(center).addTo(map)
                    .bindPopup(`<b>${name}</b><br>Đang tải dữ liệu...`)
                    .openPopup();
            }
            map.setView(center, 15);
            fetchWeatherData(center.lat, center.lng);
        });

        // Add layer control (ẩn/hiện bằng cách click vào icon layers ở góc dưới bên phải)
        L.control.layers(baseMaps, overlayMaps, {
            position: 'topright',
            collapsed: true
        }).addTo(map);

        // Add locate control
        L.control.locate({
            position: 'topleft',
            strings: {
                title: "Định vị vị trí của tôi",
                popup: "Bạn đang ở trong bán kính {distance} mét từ điểm này",
                outsideMapBoundsMsg: "Bạn dường như nằm ngoài phạm vi bản đồ"
            },
            locateOptions: {
                maxZoom: 15,
                enableHighAccuracy: true
            },
            onLocationError: function (err) {
                showError(`Lỗi định vị: ${err.message}`);
            },
            onLocationFound: function (e) {
                currentLatLng = e.latlng;
                if (marker) {
                    marker.setLatLng(e.latlng)
                        .setPopupContent("Vị trí của bạn<br>Đang tải dữ liệu...")
                        .openPopup();
                } else {
                    marker = L.marker(e.latlng).addTo(map)
                        .bindPopup("Vị trí của bạn<br>Đang tải dữ liệu...")
                        .openPopup();
                }
                fetchWeatherData(e.latlng.lat, e.latlng.lng);
            }
        }).addTo(map);

        // Add measure control
        L.control.measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#FF6F00',
            completedColor: '#0000FF',
            popupOptions: {
                className: 'leaflet-measure-resultpopup',
                autoPanPadding: [10, 10]
            }
        }).addTo(map);

        // Threshold mapping function
        function thresMap(x, thresList) {
            for (let i = 0; i < thresList.length; i += 2) {
                const value_low = thresList[i];
                const text = thresList[i + 1];
                const value_high = i + 2 < thresList.length ? thresList[i + 2] : Infinity;
                if (value_low <= x && x < value_high) {
                    return text;
                }
            }
            return null;
        }

        // Thresholds
        const nhietDoThres = [
            -10, "Nhiệt độ thấp cực đoan, cây cà phê dễ bị tổn hại hoặc chết.",
            5, "Nhiệt độ lạnh, giảm sinh trưởng, đặc biệt trong giai đoạn ra hoa.",
            15, "Nhiệt độ hài hòa, phù hợp cho cây cà phê sinh trưởng tốt.",
            25, "Trời ấm, phù hợp cho cây cà phê phát triển.",
            35, "Trời nóng, cần tưới nước nếu nắng nóng kéo dài.", 70
        ];
        const doAmThres = [
            0, "Độ ẩm thấp, cây cà phê mất nước nhanh, cần tưới gấp!",
            40, "Độ ẩm thấp, giảm quang hợp, cần theo dõi tưới nước.",
            60, "Độ ẩm tối ưu, cây cà phê hấp thụ nước và dinh dưỡng hiệu quả.",
            90, "Độ ẩm cao, quả cà phê dễ bị nấm mốc.", 100
        ];
        const luongMuaThres = [
            0, "Không mưa, cần tưới nước định kỳ.",
            0.1, "Mưa nhỏ, tốt cho cây cà phê.",
            1, "Mưa tốt, lưu ý đắp gốc bảo vệ cây con.",
            2, "Mưa to, cần thoát nước và bù phân.",
            4, "Mưa xối xả, cây cà phê dễ bị úng, cần thoát nước gấp.", 100
        ];
        const mucGioThres = [
            0, "Gió nhẹ, không gây hại.",
            20, "Gió vừa, kiểm tra cây con và hoa quả.",
            40, "Gió mạnh, cây cà phê dễ rụng lá, cần che chắn.",
            60, "Gió giật mạnh, cây có thể nghiêng ngã, cần chống đỡ.",
            80, "Bão tố, cây cà phê dễ bật gốc, cần xử lý khẩn cấp.", 500
        ];
        const uvThres = [
            0, "UV an toàn.",
            3, "UV nhẹ, cần mũ nón khi làm việc ngoài trời.",
            5, "UV cao, hạn chế ra ngoài từ 11h-15h.",
            7, "UV rất cao, tránh ra ngoài từ 10h-16h.",
            11, "UV cực cao, tránh ra ngoài hoàn toàn.", 500
        ];


        // Chart.js instance
        let weatherChart = null;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('weather-chart').getContext('2d');
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 25 }, (_, i) => ((i + 6) % 24)),
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            data: [],
                            borderColor: '#FF6F00',
                            backgroundColor: 'rgba(255, 111, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Lượng mưa (mm/h)',
                            data: [],
                            borderColor: '#0000FF',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            borderWidth: 1,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Biểu đồ thời tiết 24 giờ',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Giờ trong ngày'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nhiệt độ (°C)'
                            },
                            min: 0,
                            max: 40,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Lượng mưa (mm/h)'
                            },
                            min: 0,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    annotation: {
                        annotations: []
                    }
                }
            });
        }

        // Update chart data
        function updateChart(tempData, precipData, location) {
            if (!weatherChart) initChart();
            
            weatherChart.data.labels = Array.from({ length: 25 }, (_, i) => ((i + 6) % 24));
            weatherChart.data.datasets[0].data = tempData;
            weatherChart.data.datasets[1].data = precipData;
            
            // Find peaks for annotations
            const maxTemp = Math.max(...tempData);
            const maxTempIndex = tempData.indexOf(maxTemp);
            const maxPrecip = Math.max(...precipData);
            const maxPrecipIndex = precipData.indexOf(maxPrecip);
            
            // Update chart title with current date and location
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('vi-VN', options);
            weatherChart.options.plugins.title.text = `Biểu đồ thời tiết ngày ${today} tại ${location}`;
            
            weatherChart.update();
            document.getElementById('chart-card').classList.remove('hidden');
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // Fetch address
        async function latlon2Adress(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lon=${lon}&lat=${lat}&format=json&zoom=18&addressdetails=1`, {
                    headers: { 'User-Agent': 'Mozilla/5.0' }
                });
                if (!response.ok) {
                    throw new Error('Không thể truy cập API địa chỉ');
                }
                const data = await response.json();
                let detail = data.address.state || '';
                const keys = ['city', 'county', 'city_district', 'town', 'suburb', 'village', 'road', 'neighbourhood'];
                for (const key of keys) {
                    if (data.address[key]) {
                        detail = data.address[key];
                        break;
                    }
                }
                return [detail, data.display_name || ''];
            } catch (e) {
                showError(`Lỗi khi truy cập API địa chỉ: ${e.message}`);
                return ['', ''];
            }
        }

        // Sync map height with sidebar
        function syncMapHeight() {
            if (window.innerWidth >= 1024) {
                const sidebar = document.getElementById('sidebar');
                const mapDiv = document.getElementById('map');
                mapDiv.style.height = `${sidebar.offsetHeight}px`;
                map.invalidateSize();
            }
        }

        // Fetch weather data
        async function fetchWeatherData(lat, lon) {
            try {
                // Update marker
                const [diaChi, fullAddress] = await latlon2Adress(lat, lon);
                if (marker) {
                    marker.setPopupContent(`<b>Địa chỉ: ${diaChi}</b><br>Vĩ độ: ${lat.toFixed(6)}<br>Kinh độ: ${lon.toFixed(6)}`)
                        .openPopup();
                }

                // Update location card
                document.querySelector('#address span').textContent = fullAddress || 'Không xác định';
                document.querySelector('#lat span').textContent = lat.toFixed(6);
                document.querySelector('#lon span').textContent = lon.toFixed(6);
                document.getElementById('location-card').classList.remove('hidden');

                // Fetch weather data
                const apiKey = '5f1bd39bf15c4f4694a145604251202';
                const url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${lat},${lon}&days=3&aqi=yes&alerts=yes&lang=vi`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error: ${response.status} - ${await response.text()}`);
                }
                const data = await response.json();

                // Update weather card
                document.querySelector('#weather-location span').textContent = diaChi;
                document.querySelector('#weather-time span').textContent = data.current.last_updated;
                document.querySelector('#weather-condition span').textContent = data.current.condition.text;
                document.querySelector('#weather-temp span').textContent = `${data.current.temp_c} °C`;
                document.querySelector('#weather-humidity span').textContent = `${data.current.humidity} %`;
                document.querySelector('#weather-precip span').textContent = `${data.current.precip_mm} mm/h`;
                document.querySelector('#weather-wind span').textContent = `${data.current.wind_kph} km/h`;
                document.querySelector('#weather-cloud span').textContent = `${data.current.cloud} %`;
                document.querySelector('#weather-vis span').textContent = `${data.current.vis_km} km`;
                document.querySelector('#weather-uv span').textContent = data.current.uv;
                document.getElementById('weather-card').classList.remove('hidden');

                // Update recommendations
                const recommendations = document.getElementById('recommendations');
                recommendations.innerHTML = '';
                if (data.alerts.alert && data.alerts.alert.length > 0) {
                    const li = document.createElement('li');
                    li.innerHTML = '<i class="bi bi-exclamation-triangle-fill mr-2 text-lazinet-orange"></i> Có cảnh báo thời tiết bất thường, kiểm tra chi tiết để xử lý.';
                    recommendations.appendChild(li);
                }

                const nd0 = data.forecast.forecastday[0].day.maxtemp_c;
                const da0 = data.forecast.forecastday[0].day.avghumidity;
                const lm0 = (data.forecast.forecastday[0].day.totalprecip_mm / 24).toFixed(1);
                const mg0 = data.forecast.forecastday[0].day.maxwind_kph;
                const uv0 = data.forecast.forecastday[0].day.uv;

                [thresMap(nd0, nhietDoThres), thresMap(da0, doAmThres), thresMap(lm0, luongMuaThres),
                thresMap(mg0, mucGioThres), thresMap(uv0, uvThres)].forEach(text => {
                    if (text) {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="bi bi-arrow-right mr-2 text-white bg-lazinet-blue rounded-full p-1 custom-arrow"></i> ${text}`;
                        recommendations.appendChild(li);
                    }
                });
                document.getElementById('recommendations-card').classList.remove('hidden');

                // Update chart
                const nhietDo = [
                    ...data.forecast.forecastday[0].hour.map(h => h.temp_c),
                    ...data.forecast.forecastday[1].hour.slice(0, 7).map(h => h.temp_c)
                ].slice(6, 31);
                const luongMua = [
                    ...data.forecast.forecastday[0].hour.map(h => h.precip_mm),
                    ...data.forecast.forecastday[1].hour.slice(0, 7).map(h => h.precip_mm)
                ].slice(6, 31);
                updateChart(nhietDo, luongMua, diaChi);

                // Update forecast table
                const tbody = document.getElementById('forecast-table-body');
                tbody.innerHTML = '';
                const periods = [
                    {
                        time: 'Sáng',
                        temp: (nhietDo.slice(0, 6).reduce((a, b) => a + b, 0) / 6).toFixed(1),
                        humidity: Math.round(data.forecast.forecastday[0].hour.slice(6, 12).reduce((a, b) => a + b.humidity, 0) / 6),
                        precip: (luongMua.slice(0, 6).reduce((a, b) => a + b, 0) / 6).toFixed(2),
                        condition: [...new Set(data.forecast.forecastday[0].hour.slice(6, 12).map(h => h.condition.text))].join(', ')
                    },
                    {
                        time: 'Chiều',
                        temp: (nhietDo.slice(6, 12).reduce((a, b) => a + b, 0) / 6).toFixed(1),
                        humidity: Math.round(data.forecast.forecastday[0].hour.slice(12, 18).reduce((a, b) => a + b.humidity, 0) / 6),
                        precip: (luongMua.slice(6, 12).reduce((a, b) => a + b, 0) / 6).toFixed(2),
                        condition: [...new Set(data.forecast.forecastday[0].hour.slice(12, 18).map(h => h.condition.text))].join(', ')
                    },
                    {
                        time: 'Tối',
                        temp: (nhietDo.slice(12, 18).reduce((a, b) => a + b, 0) / 6).toFixed(1),
                        humidity: Math.round(data.forecast.forecastday[0].hour.slice(18, 24).reduce((a, b) => a + b.humidity, 0) / 6),
                        precip: (luongMua.slice(12, 18).reduce((a, b) => a + b, 0) / 6).toFixed(2),
                        condition: [...new Set(data.forecast.forecastday[0].hour.slice(18, 24).map(h => h.condition.text))].join(', ')
                    },
                    {
                        time: 'Đêm',
                        temp: (nhietDo.slice(18, 24).reduce((a, b) => a + b, 0) / 6).toFixed(1),
                        humidity: Math.round((
                            data.forecast.forecastday[0].hour.slice(0, 6).reduce((a, b) => a + b.humidity, 0) +
                            data.forecast.forecastday[1].hour.slice(0, 6).reduce((a, b) => a + b.humidity, 0)
                        ) / 12),
                        precip: (luongMua.slice(18, 24).reduce((a, b) => a + b, 0) / 6).toFixed(2),
                        condition: [...new Set([
                            ...data.forecast.forecastday[0].hour.slice(0, 6).map(h => h.condition.text),
                            ...data.forecast.forecastday[1].hour.slice(0, 6).map(h => h.condition.text)
                        ])].join(', ')
                    },
                    {
                        time: 'Ngày MAI',
                        temp: `${data.forecast.forecastday[1].day.mintemp_c}-${data.forecast.forecastday[1].day.maxtemp_c}`,
                        humidity: data.forecast.forecastday[1].day.avghumidity,
                        precip: (data.forecast.forecastday[1].day.totalprecip_mm / 24).toFixed(1),
                        condition: data.forecast.forecastday[1].day.condition.text
                    },
                    {
                        time: 'Ngày MỐT',
                        temp: `${data.forecast.forecastday[2].day.mintemp_c}-${data.forecast.forecastday[2].day.maxtemp_c}`,
                        humidity: data.forecast.forecastday[2].day.avghumidity,
                        precip: (data.forecast.forecastday[2].day.totalprecip_mm / 24).toFixed(1),
                        condition: data.forecast.forecastday[2].day.condition.text
                    }
                ];
                periods.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-lazinet-orange', 'hover:bg-opacity-10');
                    tr.innerHTML = `
                        <td class="py-2 px-4 border-b">${p.time}</td>
                        <td class="py-2 px-4 border-b">${p.temp}</td>
                        <td class="py-2 px-4 border-b">${p.humidity}</td>
                        <td class="py-2 px-4 border-b">${p.precip}</td>
                        <td class="py-2 px-4 border-b">${p.condition}</td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('table-card').classList.remove('hidden');

                // Sync map height
                syncMapHeight();
            } catch (e) {
                showError(`Lỗi khi lấy dữ liệu thời tiết: ${e.message}`);
                if (marker) {
                    marker.setPopupContent(`<b>Lỗi khi tải dữ liệu thời tiết</b><br>${e.message}`)
                        .openPopup();
                }
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchWeatherData(17.002871, 107.052361);
            syncMapHeight();
        });

        // Resize listener
        window.addEventListener('resize', function() {
            syncMapHeight();
            if (weatherChart) {
                weatherChart.resize();
            }
        });
    </script>
</body>

</html>