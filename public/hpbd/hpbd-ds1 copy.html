<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET Birthday Card Creator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #187752;
            --secondary: #B91C1C;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            margin: 0; 
            padding: 0; 
            background: var(--bg-light); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
            height: 100%;
            background: #fff;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .preview-area {
            flex-grow: 1;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #e2e8f0;
            position: relative;
            overflow: hidden;
            padding: 20px;
        }

        /* --- UI COMPONENTS --- */
        h2 { 
            font-size: 1.1rem; 
            color: var(--primary); 
            margin: 0 0 10px 0; 
            border-bottom: 2px solid var(--secondary); 
            padding-bottom: 5px; 
        }
        
        .control-group { 
            margin-bottom: 12px; 
        }
        
        label { 
            display: block; 
            font-size: 0.8rem; 
            font-weight: 700; 
            margin-bottom: 4px; 
            color: #4b5563; 
        }
        
        select, input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }
        
        select:focus, input:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 2px rgba(24, 119, 82, 0.1); 
        }
        
        textarea { 
            resize: vertical; 
            min-height: 70px; 
        }

        .btn {
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            width: 100%; 
            padding: 8px; 
            border: none; 
            border-radius: 6px;
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.2s; 
            gap: 6px; 
            font-size: 0.9rem;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: #145c40; 
        }
        
        .btn-outline { 
            background: #fff; 
            border: 1px solid var(--primary); 
            color: var(--primary); 
            margin-top: 5px;
        }
        
        .btn-outline:hover { 
            background: #f0fdf4; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 10px; 
            margin-top: 10px; 
        }

        /* --- THE CARD --- */
        #card-container {
            width: 100%;
            max-width: 700px;
            background-color: white;
            background-size: cover;
            background-position: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
        }
        
        /* Effect Canvas */
        #effect-layer {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 10;
            border-radius: 8px;
        }

        /* Card Internals */
        .card-header { 
            padding: 30px; 
            text-align: center; 
            background: rgba(255,255,255,0.85); 
            backdrop-filter: blur(3px); 
            border-radius: 8px 8px 0 0; 
        }
        
        .card-logo { 
            max-height: 80px; 
            width: auto; 
            margin-bottom: 10px; 
        }
        
        .card-title { 
            font-size: 2rem; 
            color: var(--primary); 
            margin: 5px 0; 
            text-transform: uppercase; 
            font-weight: 800; 
            line-height: 1.2; 
            text-shadow: 1px 1px 0px #fff;
        }
        
        .card-recipient { 
            font-size: 1.5rem; 
            color: var(--secondary); 
            margin: 0; 
            font-weight: 700;
        }
        
        .card-body { 
            padding: 25px 40px; 
            background: rgba(255,255,255,0.9); 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }
        
        .card-wish { 
            font-size: 1rem; 
            line-height: 1.6; 
            text-align: justify; 
            white-space: pre-wrap; 
            color: #333; 
        }
        
        .history-box { 
            background: #f8fafc; 
            border-left: 4px solid var(--primary); 
            padding: 12px; 
            border-radius: 0 6px 6px 0;
            font-size: 0.85rem; 
            color: #555; 
            display: none; 
            margin-top: 10px;
        }
        
        .history-box h4 { 
            margin: 0 0 8px 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 0.9rem;
        }
        
        .history-box ul { 
            margin: 0; 
            padding-left: 20px; 
        }
        
        .history-box li { 
            margin-bottom: 4px; 
        }

        .card-footer { 
            padding: 15px; 
            background: var(--primary); 
            color: white; 
            text-align: center; 
            margin-top: auto; 
            border-radius: 0 0 8px 8px; 
        }
        
        .footer-sig-name { 
            font-weight: bold; 
            font-size: 1rem; 
        }
        
        .footer-sig-title { 
            font-style: italic; 
            font-size: 0.8rem; 
            opacity: 0.9; 
            margin-bottom: 8px; 
        }
        
        .footer-links { 
            font-size: 0.75rem; 
            opacity: 0.8; 
        }
        
        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid var(--primary); 
            border-radius: 50%;
            width: 18px; 
            height: 18px; 
            animation: spin 0.8s linear infinite; 
            display: none;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Status Message */
        .status-message {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }
        
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Responsive */
        @media (max-width: 900px) {
            body { 
                flex-direction: column; 
                overflow-y: auto; 
                height: auto; 
            }
            
            .sidebar { 
                width: 100%; 
                height: auto; 
                border-bottom: 1px solid var(--border); 
                border-right: none; 
            }
            
            .preview-area { 
                width: 100%; 
                padding: 10px; 
                min-height: auto; 
            }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>üéâ Thi·∫øt l·∫≠p thi·ªáp</h2>
            <div class="loader" id="main-loader"></div>
        </div>

        <!-- Status Message Area -->
        <div id="status-area"></div>

        <div class="control-group">
            <label>1. Ng∆∞·ªùi nh·∫≠n (Sinh nh·∫≠t h√¥m nay)</label>
            <select id="recipient-select" onchange="loadRecipient()">
                <option value="">-- T·ª± nh·∫≠p tay --</option>
            </select>
        </div>

        <div class="control-group">
            <label>2. L·ªùi ch√∫c</label>
            <select id="wish-preset" onchange="applyWishPreset()">
                <option value="">-- Ch·ªçn m·∫´u c√¢u --</option>
            </select>
            <textarea id="wish-text" placeholder="N·ªôi dung l·ªùi ch√∫c..." style="margin-top:5px;" oninput="updateCardUI()"></textarea>
            <button class="btn btn-outline" onclick="generateNewWish()" id="btn-gen-wish">
                <i class="bi bi-stars"></i> AI vi·∫øt l·∫°i l·ªùi ch√∫c
            </button>
        </div>

        <div class="control-group">
            <label>3. S·ª± ki·ªán ng√†y n√†y</label>
            <button class="btn btn-outline" onclick="fetchHistoryEvents()" id="btn-history">
                <i class="bi bi-clock-history"></i> L·∫•y s·ª± ki·ªán l·ªãch s·ª≠
            </button>
        </div>

        <div class="control-group">
            <label>4. H√¨nh n·ªÅn</label>
            <select id="bg-select" onchange="changeBackground(this.value)">
                <option value="">M·∫∑c ƒë·ªãnh</option>
            </select>
            <input type="text" id="bg-url" placeholder="D√°n link ·∫£nh kh√°c..." onchange="changeBackground(this.value)" style="margin-top:5px;">
        </div>

        <div class="control-group">
            <label>5. Hi·ªáu ·ª©ng</label>
            <select id="effect-select" onchange="changeEffect(this.value)">
                <option value="none">Kh√¥ng hi·ªáu ·ª©ng</option>
                <option value="confetti">üéâ Tung hoa (Confetti)</option>
                <option value="balloons">üéà B√≥ng bay (Particles)</option>
                <option value="snow">‚ú® Sao r∆°i (Sparkles)</option>
            </select>
        </div>
        
        <div class="control-group" style="border-top:1px dashed #ccc; padding-top:10px;">
            <label>Th√¥ng tin t√πy ch·ªânh</label>
            <input type="text" id="inp-name" placeholder="T√™n (VD: Anh Nam)" oninput="updateCardUI()">
            <input type="text" id="inp-company" placeholder="C√¥ng ty" oninput="updateCardUI()" style="margin-top:5px;">
        </div>

        <div style="margin-top: auto;">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportImage()"><i class="bi bi-download"></i> T·∫£i ·∫¢nh</button>
                <button class="btn btn-primary" style="background:var(--secondary)" onclick="exportPDF()"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div id="card-container">
            <canvas id="effect-layer"></canvas>

            <div class="card-header">
                <img id="card-logo" src="" alt="" class="card-logo" style="display:none;">
                <h1 class="card-title">HAPPY BIRTHDAY</h1>
                <h2 id="card-recipient-name" class="card-recipient">Kh√°ch h√†ng th√¢n thi·∫øt</h2>
                <div id="card-recipient-company" style="color:#555; margin-top:5px; font-weight:600;"></div>
            </div>

            <div class="card-body">
                <div id="card-wish-content" class="card-wish">
                    Ch√∫c m·ª´ng sinh nh·∫≠t! Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi tr√†n ƒë·∫ßy ni·ªÅm vui, s·ª©c kh·ªèe v√† th√†nh c√¥ng r·ª±c r·ª°.
                </div>
                
                <div id="history-section" class="history-box">
                    <h4><i class="bi bi-calendar-check"></i> S·ª± ki·ªán ng√†y n√†y:</h4>
                    <div id="history-content"></div>
                </div>
            </div>

            <div class="card-footer">
                <div id="sig-name" class="footer-sig-name"></div>
                <div id="sig-title" class="footer-sig-title"></div>
                <div id="footer-contact" class="footer-links"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // URL c·ªßa backend ƒëang ch·∫°y ƒë∆∞·ª£c
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwJBU1yGXhmlr0tHl8zipF1y6AafbRjdDklKdCC08hfcZnAG7ZWqCv-G4gFEF1tNMQ3Dw/exec';

        // Global Data
        let globalSettings = {};
        let todayBirthdays = [];
        
        // Effects Global Vars
        let currentEffectInterval = null;
        let myConfetti = null;

        // --- INITIALIZATION ---
        window.addEventListener('load', async () => {
            console.log("üéÇ LAZINET Birthday Card Creator ƒëang kh·ªüi ƒë·ªông...");
            
            const loader = document.getElementById('main-loader');
            loader.style.display = 'block';
            
            try {
                // Load settings v√† birthdays song song
                await Promise.all([
                    loadSettings(),
                    loadBirthdays()
                ]);
                
                showStatus("‚úÖ Kh·ªüi t·∫°o th√†nh c√¥ng!", "success");
                console.log("‚úÖ App ƒë√£ s·∫µn s√†ng!");
            } catch (err) {
                console.error("‚ùå L·ªói kh·ªüi t·∫°o:", err);
                showStatus("‚ùå L·ªói kh·ªüi t·∫°o: " + err.message, "error");
            } finally {
                loader.style.display = 'none';
            }
        });

        // --- UTILITY FUNCTIONS ---
        function showStatus(message, type = "info") {
            const statusArea = document.getElementById('status-area');
            
            // X√≥a status c≈© sau 5 gi√¢y
            setTimeout(() => {
                if (statusArea.firstChild) {
                    statusArea.removeChild(statusArea.firstChild);
                }
            }, 5000);
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            statusArea.insertBefore(statusDiv, statusArea.firstChild);
        }

        // --- API FUNCTIONS (FIXED) ---
        async function callAPI(action, data = null) {
            console.log(`üì° G·ªçi API: ${action}`, data || '');
            
            try {
                const payload = data ? { action, data } : { action };
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log(`üì® API Response raw:`, responseText);
                
                const result = JSON.parse(responseText);
                console.log(`üìä API ${action} result:`, result);
                
                return result;
                
            } catch (error) {
                console.error(`‚ùå API ${action} error:`, error);
                return { 
                    success: false, 
                    message: `L·ªói k·∫øt n·ªëi: ${error.message}` 
                };
            }
        }

        async function loadSettings() {
            showStatus("‚è≥ ƒêang t·∫£i c·∫•u h√¨nh h·ªá th·ªëng...", "info");
            
            const result = await callAPI('getPublicConfig');
            
            if (result.success) {
                globalSettings = result.data;
                console.log("‚úÖ Settings loaded:", globalSettings);
                applyInitialSettings();
                showStatus("‚úÖ ƒê√£ t·∫£i c·∫•u h√¨nh h·ªá th·ªëng", "success");
            } else {
                showStatus(`‚ùå L·ªói t·∫£i c·∫•u h√¨nh: ${result.message}`, "error");
                // V·∫´n ti·∫øp t·ª•c v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh
                globalSettings = {};
            }
        }

        async function loadBirthdays() {
            showStatus("‚è≥ ƒêang t·∫£i danh s√°ch sinh nh·∫≠t h√¥m nay...", "info");
            
            const result = await callAPI('getTodayBirthdays');
            
            if (result.success) {
                todayBirthdays = Array.isArray(result.data) ? result.data : [];
                console.log("‚úÖ Birthdays loaded:", todayBirthdays);
                populateRecipientSelect();
                
                if (todayBirthdays.length > 0) {
                    showStatus(`‚úÖ T√¨m th·∫•y ${todayBirthdays.length} ng∆∞·ªùi c√≥ sinh nh·∫≠t h√¥m nay`, "success");
                } else {
                    showStatus("‚ÑπÔ∏è H√¥m nay kh√¥ng c√≥ sinh nh·∫≠t n√†o", "info");
                }
            } else {
                showStatus(`‚ùå L·ªói t·∫£i danh s√°ch sinh nh·∫≠t: ${result.message}`, "error");
                todayBirthdays = [];
            }
        }

        async function generateNewWish() {
            const btn = document.getElementById('btn-gen-wish');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loader" style="display:inline-block; margin-right:5px;"></span> AI ƒëang vi·∫øt...';
            
            showStatus("ü§ñ AI ƒëang vi·∫øt l·ªùi ch√∫c m·ªõi...", "info");
            
            const userData = {
                title: "",
                name: document.getElementById('inp-name').value || "Qu√Ω kh√°ch",
                company: document.getElementById('inp-company').value || "",
                preference: "T·∫°o l·ªùi ch√∫c m·ªõi m·∫ª, ·∫•n t∆∞·ª£ng, ch√¢n th√†nh"
            };

            const result = await callAPI('generateWish', userData);
            
            if (result.success) {
                const aiWish = result.data;
                document.getElementById('wish-text').value = aiWish;
                document.getElementById('card-wish-content').innerText = aiWish;
                showStatus("‚úÖ AI ƒë√£ t·∫°o l·ªùi ch√∫c m·ªõi th√†nh c√¥ng!", "success");
            } else {
                showStatus(`‚ùå L·ªói AI: ${result.message}`, "error");
            }
            
            btn.disabled = false;
            btn.innerHTML = originalText;
        }

        async function fetchHistoryEvents() {
            const box = document.getElementById('history-section');
            const content = document.getElementById('history-content');
            const btn = document.getElementById('btn-history');
            
            box.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; padding:10px;"><span class="loader" style="display:inline-block;"></span> ƒêang t·∫£i s·ª± ki·ªán l·ªãch s·ª≠...</div>';
            btn.disabled = true;
            
            showStatus("‚è≥ ƒêang t·∫£i s·ª± ki·ªán l·ªãch s·ª≠...", "info");
            
            const result = await callAPI('getHistoryEvents');
            
            if (result.success) {
                content.innerHTML = result.data;
                showStatus("‚úÖ ƒê√£ t·∫£i s·ª± ki·ªán l·ªãch s·ª≠", "success");
            } else {
                content.innerHTML = `<div style="color:red; padding:10px;">
                    <i class="bi bi-exclamation-triangle"></i> L·ªói: ${result.message}
                </div>`;
                showStatus(`‚ùå L·ªói t·∫£i s·ª± ki·ªán: ${result.message}`, "error");
            }
            
            btn.disabled = false;
        }

        // --- UI FUNCTIONS ---
        function applyInitialSettings() {
            const s = globalSettings;
            console.log("Applying settings:", s);
            
            // √Åp d·ª•ng m√†u s·∫Øc
            if (s['Style-PrimaryColor']) {
                document.documentElement.style.setProperty('--primary', s['Style-PrimaryColor']);
            }
            if (s['Style-SecondaryColor']) {
                document.documentElement.style.setProperty('--secondary', s['Style-SecondaryColor']);
            }

            // Logo
            if (s['Signature-Logo-URL']) {
                const logo = document.getElementById('card-logo');
                logo.src = s['Signature-Logo-URL'];
                logo.style.display = 'inline-block';
                logo.onerror = () => {
                    console.warn("Logo kh√¥ng t·∫£i ƒë∆∞·ª£c:", s['Signature-Logo-URL']);
                    logo.style.display = 'none';
                };
            }
            
            // Th√¥ng tin ng∆∞·ªùi g·ª≠i
            document.getElementById('sig-name').textContent = s['Signature-Name'] || 'ƒê·ªôi ng≈© LAZINET';
            document.getElementById('sig-title').textContent = s['Signature-Organization-Full'] || '';
            
            // Th√¥ng tin li√™n h·ªá footer
            const hotline = s['Footer-Hotline'] ? `Hotline: ${s['Footer-Hotline']}` : '';
            const web = s['Signature-Organization-HREF'] ? `Web: ${s['Signature-Organization-HREF']}` : '';
            document.getElementById('footer-contact').textContent = [hotline, web].filter(Boolean).join(' | ');

            // Background Dropdown
            const bgSel = document.getElementById('bg-select');
            bgSel.innerHTML = '<option value="">M·∫∑c ƒë·ªãnh</option>';
            
            // Th√™m t·∫•t c·∫£ background t·ª´ settings
            Object.keys(s).forEach(key => {
                if (key.startsWith('Background-') && s[key]) {
                    const labelPart = key.split('-')[1];
                    const opt = document.createElement('option');
                    opt.value = s[key];
                    opt.textContent = `H√¨nh n·ªÅn ${labelPart}`;
                    bgSel.appendChild(opt);
                }
            });
            
            // √Åp d·ª•ng background m·∫∑c ƒë·ªãnh n·∫øu c√≥
            if (s['Background-00']) {
                changeBackground(s['Background-00']);
            }

            // Wish Presets Dropdown
            const wishSel = document.getElementById('wish-preset');
            wishSel.innerHTML = '<option value="">-- Ch·ªçn m·∫´u c√¢u --</option>';
            
            Object.keys(s).forEach(key => {
                if (key.startsWith('Wish-') && s[key]) {
                    const labelPart = key.split('-')[1];
                    const opt = document.createElement('option');
                    opt.value = s[key];
                    opt.textContent = `M·∫´u c√¢u ch√∫c ${labelPart}`;
                    wishSel.appendChild(opt);
                }
            });
            
            // √Åp d·ª•ng m·∫´u l·ªùi ch√∫c m·∫∑c ƒë·ªãnh
            if (s['Wish-00']) {
                document.getElementById('wish-text').value = s['Wish-00'];
                document.getElementById('card-wish-content').textContent = s['Wish-00'];
            }
            
            // C·∫≠p nh·∫≠t UI card v·ªõi th√¥ng tin m·∫∑c ƒë·ªãnh
            updateCardUI();
        }

        function populateRecipientSelect() {
            const sel = document.getElementById('recipient-select');
            
            // Gi·ªØ option "T·ª± nh·∫≠p tay"
            sel.innerHTML = '<option value="">-- T·ª± nh·∫≠p tay --</option>';
            
            if (todayBirthdays.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = '-- Kh√¥ng c√≥ sinh nh·∫≠t h√¥m nay --';
                opt.disabled = true;
                sel.appendChild(opt);
                return;
            }
            
            // Th√™m t·ª´ng ng∆∞·ªùi v√†o dropdown
            todayBirthdays.forEach((person, index) => {
                const opt = document.createElement('option');
                opt.value = person.id || index;
                opt.textContent = `${person.title || ''} ${person.name || ''} (${person.company || 'Kh√¥ng c√≥ c√¥ng ty'})`.trim();
                sel.appendChild(opt);
            });
        }

        function loadRecipient() {
            const sel = document.getElementById('recipient-select');
            const selectedId = sel.value;
            
            if (!selectedId) {
                // N·∫øu ch·ªçn "T·ª± nh·∫≠p tay", x√≥a c√°c field
                document.getElementById('inp-name').value = '';
                document.getElementById('inp-company').value = '';
                document.getElementById('wish-text').value = '';
                updateCardUI();
                return;
            }
            
            // T√¨m ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn
            const person = todayBirthdays.find(p => 
                (p.id && p.id.toString() === selectedId) || 
                (todayBirthdays.indexOf(p).toString() === selectedId)
            );
            
            if (person) {
                document.getElementById('inp-name').value = `${person.title || ''} ${person.name || ''}`.trim();
                document.getElementById('inp-company').value = person.company || '';
                
                // N·∫øu ng∆∞·ªùi n√†y c√≥ l·ªùi ch√∫c ri√™ng, d√πng n√≥
                if (person.wish && person.wish.trim().length > 5) {
                    document.getElementById('wish-text').value = person.wish;
                }
                
                updateCardUI();
                showStatus(`‚úÖ ƒê√£ ch·ªçn: ${person.name}`, "success");
            }
        }

        function updateCardUI() {
            const name = document.getElementById('inp-name').value || 'Kh√°ch h√†ng th√¢n thi·∫øt';
            const company = document.getElementById('inp-company').value || '';
            const wish = document.getElementById('wish-text').value || 
                'Ch√∫c m·ª´ng sinh nh·∫≠t! Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi tr√†n ƒë·∫ßy ni·ªÅm vui, s·ª©c kh·ªèe v√† th√†nh c√¥ng r·ª±c r·ª°.';
            
            document.getElementById('card-recipient-name').textContent = name;
            document.getElementById('card-recipient-company').textContent = company;
            document.getElementById('card-wish-content').textContent = wish;
        }

        function applyWishPreset() {
            const selectedWish = document.getElementById('wish-preset').value;
            if (selectedWish) {
                document.getElementById('wish-text').value = selectedWish;
                document.getElementById('card-wish-content').textContent = selectedWish;
                showStatus("‚úÖ ƒê√£ √°p d·ª•ng m·∫´u l·ªùi ch√∫c", "success");
            }
        }

        function changeBackground(url) {
            const cardContainer = document.getElementById('card-container');
            
            if (url && url.trim() !== '') {
                // Th·ª≠ t·∫£i ·∫£nh tr∆∞·ªõc ƒë·ªÉ ki·ªÉm tra
                const testImg = new Image();
                testImg.onload = function() {
                    cardContainer.style.backgroundImage = `url('${url}')`;
                    showStatus("‚úÖ ƒê√£ thay ƒë·ªïi h√¨nh n·ªÅn", "success");
                };
                testImg.onerror = function() {
                    cardContainer.style.backgroundImage = 'none';
                    showStatus("‚ùå Kh√¥ng th·ªÉ t·∫£i h√¨nh n·ªÅn t·ª´ URL n√†y", "error");
                };
                testImg.src = url;
            } else {
                cardContainer.style.backgroundImage = 'none';
            }
        }

        // --- EFFECTS FUNCTIONS ---
        function changeEffect(type) {
            const canvas = document.getElementById('effect-layer');
            const ctx = canvas.getContext('2d');
            
            // D·ªçn d·∫πp hi·ªáu ·ª©ng c≈©
            if (currentEffectInterval) {
                clearInterval(currentEffectInterval);
                currentEffectInterval = null;
            }
            
            if (myConfetti) {
                myConfetti.reset();
                myConfetti = null;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc canvas
            const card = document.getElementById('card-container');
            canvas.width = card.offsetWidth;
            canvas.height = card.offsetHeight;
            
            if (type === 'none') {
                // Kh√¥ng hi·ªáu ·ª©ng
                showStatus("‚úÖ ƒê√£ t·∫Øt hi·ªáu ·ª©ng", "success");
                return;
            }
            
            if (type === 'confetti') {
                runConfetti(canvas);
                showStatus("üéâ B·∫≠t hi·ªáu ·ª©ng tung hoa", "success");
            } else if (type === 'balloons') {
                runParticles(ctx, canvas.width, canvas.height, 'balloons');
                showStatus("üéà B·∫≠t hi·ªáu ·ª©ng b√≥ng bay", "success");
            } else if (type === 'snow') {
                runParticles(ctx, canvas.width, canvas.height, 'snow');
                showStatus("‚ú® B·∫≠t hi·ªáu ·ª©ng sao r∆°i", "success");
            }
        }

        function runConfetti(canvas) {
            myConfetti = confetti.create(canvas, {
                resize: true,
                useWorker: false
            });
            
            // Hi·ªáu ·ª©ng confetti ban ƒë·∫ßu
            myConfetti({
                particleCount: 150,
                spread: 160,
                origin: { y: 0.5 },
                gravity: 0.8,
                scalar: 1.2
            });
            
            // Confetti ƒë·ªãnh k·ª≥ m·ªói 3 gi√¢y
            currentEffectInterval = setInterval(() => {
                myConfetti({
                    particleCount: 50,
                    spread: 100,
                    origin: { y: 0.6 },
                    gravity: 0.8,
                    scalar: 0.8
                });
            }, 3000);
        }

        function runParticles(ctx, w, h, type) {
            const particles = [];
            const count = type === 'snow' ? 60 : 40;
            
            // T·∫°o particles
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: type === 'snow' ? Math.random() * 3 + 1 : Math.random() * 6 + 3,
                    speed: Math.random() * 2 + 1,
                    sway: Math.random() * 0.5 - 0.25,
                    color: type === 'snow' 
                        ? `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`
                        : `hsla(${Math.random() * 360}, 80%, 60%, 0.8)`
                });
            }
            
            function draw() {
                ctx.clearRect(0, 0, w, h);
                
                particles.forEach(p => {
                    ctx.beginPath();
                    ctx.fillStyle = p.color;
                    
                    if (type === 'snow') {
                        // V·∫Ω h√¨nh tr√≤n cho tuy·∫øt
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    } else {
                        // V·∫Ω h√¨nh tr√≤n cho b√≥ng bay
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    }
                    
                    ctx.fill();
                });
                
                update();
            }
            
            function update() {
                particles.forEach(p => {
                    // Di chuy·ªÉn xu·ªëng
                    p.y += p.speed;
                    
                    // L·∫Øc l∆∞ nh·∫π
                    p.x += p.sway;
                    
                    // Reset khi ch·∫°m ƒë√°y
                    if (p.y > h) {
                        p.y = -10;
                        p.x = Math.random() * w;
                    }
                    
                    // Gi·ªØ trong khung ngang
                    if (p.x < -10) p.x = w + 10;
                    if (p.x > w + 10) p.x = -10;
                });
            }
            
            currentEffectInterval = setInterval(draw, 40);
        }

        // --- EXPORT FUNCTIONS ---
        function exportImage() {
            const element = document.getElementById('card-container');
            const canvas = document.getElementById('effect-layer');
            const originalDisplay = canvas.style.display;
            
            // T·∫°m ·∫©n hi·ªáu ·ª©ng canvas khi export
            canvas.style.display = 'none';
            
            showStatus("‚è≥ ƒêang t·∫°o ·∫£nh...", "info");
            
            html2canvas(element, { 
                scale: 2, 
                useCORS: true,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `LAZINET-Birthday-Card-${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png", 1.0);
                link.click();
                
                canvas.style.display = originalDisplay;
                showStatus("‚úÖ ƒê√£ t·∫£i xu·ªëng ·∫£nh th√†nh c√¥ng!", "success");
            }).catch(error => {
                console.error("Export image error:", error);
                canvas.style.display = originalDisplay;
                showStatus("‚ùå L·ªói khi t·∫°o ·∫£nh: " + error.message, "error");
            });
        }

        function exportPDF() {
            const element = document.getElementById('card-container');
            const canvas = document.getElementById('effect-layer');
            const originalDisplay = canvas.style.display;
            
            canvas.style.display = 'none';
            
            showStatus("‚è≥ ƒêang t·∫°o PDF...", "info");
            
            html2canvas(element, { 
                scale: 2, 
                useCORS: true,
                backgroundColor: null
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`LAZINET-Birthday-Card-${Date.now()}.pdf`);
                
                canvas.style.display = originalDisplay;
                showStatus("‚úÖ ƒê√£ t·∫£i xu·ªëng PDF th√†nh c√¥ng!", "success");
            }).catch(error => {
                console.error("Export PDF error:", error);
                canvas.style.display = originalDisplay;
                showStatus("‚ùå L·ªói khi t·∫°o PDF: " + error.message, "error");
            });
        }

        // --- RESIZE HANDLER ---
        window.addEventListener('resize', () => {
            // C·∫≠p nh·∫≠t l·∫°i k√≠ch th∆∞·ªõc canvas khi resize
            const canvas = document.getElementById('effect-layer');
            const card = document.getElementById('card-container');
            
            if (canvas && card) {
                canvas.width = card.offsetWidth;
                canvas.height = card.offsetHeight;
                
                // Re-apply effect if active
                const effectType = document.getElementById('effect-select').value;
                if (effectType !== 'none') {
                    changeEffect(effectType);
                }
            }
        });

        // --- DEBUG MODE ---
        // M·ªü Console (F12) v√† g·ªçi debugInfo() ƒë·ªÉ xem th√¥ng tin
        window.debugInfo = function() {
            console.group("üîç DEBUG INFO");
            console.log("Global Settings:", globalSettings);
            console.log("Today Birthdays:", todayBirthdays);
            console.log("Current Effect:", document.getElementById('effect-select').value);
            console.log("Card Recipient:", document.getElementById('card-recipient-name').textContent);
            console.log("GAS URL:", GAS_URL);
            console.groupEnd();
            
            showStatus("üìä ƒê√£ in th√¥ng tin debug ra Console (F12)", "info");
        };

    </script>
</body>
</html>