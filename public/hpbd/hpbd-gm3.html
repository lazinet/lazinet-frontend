<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET Birthday Creator</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --p-color: #187752; /* Primary */
            --s-color: #B91C1C; /* Secondary */
            --bg-body: #eef2f6;
            --panel-w: 360px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Be Vietnam Pro', sans-serif; background: var(--bg-body); height: 100vh; overflow: hidden; display: flex; }

        /* --- LEFT SIDEBAR (SETTINGS) --- */
        .sidebar {
            width: var(--panel-w); background: #fff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 50; box-shadow: 2px 0 15px rgba(0,0,0,0.05);
        }
        .sb-header { padding: 20px; border-bottom: 1px solid #eee; text-align: center; }
        .sb-logo { height: 45px; object-fit: contain; }
        
        /* Tabs */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #666; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { color: var(--p-color); border-bottom-color: var(--p-color); background: #fff; }

        /* Tab Content */
        .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
        .tab-content.active { display: block; animation: fadein 0.3s; }
        @keyframes fadein { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        /* Controls */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; color: #444; text-transform: uppercase; }
        .form-control, .form-select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--p-color); outline: none; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 5px; }
        .btn-p { background: var(--p-color); color: white; }
        .btn-s { background: var(--s-color); color: white; }
        .btn-o { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Effect Cards */
        .fx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .fx-item { padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; cursor: pointer; font-size: 0.8rem; }
        .fx-item:hover { background: #f5f5f5; }
        .fx-item.active { border-color: var(--p-color); background: rgba(24, 119, 82, 0.1); color: var(--p-color); font-weight: bold; }

        /* --- RIGHT PREVIEW --- */
        .preview { flex: 1; background: #333; display: flex; align-items: center; justify-content: center; position: relative; overflow: auto; padding: 40px; }
        
        /* CARD CONTAINER */
        .card-wrap {
            width: 800px; min-height: 1000px; background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 0;
            position: relative; overflow: hidden;
            transform-origin: center top; transition: transform 0.3s;
        }

        /* LAYERS */
        .layer-bg { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; z-index: 1; }
        .layer-fx { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 2; pointer-events: none; }
        .layer-content { position: relative; z-index: 3; padding: 50px; height: 100%; display: flex; flex-direction: column; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); }

        /* CARD ELEMENTS */
        .c-header { text-align: center; margin-bottom: 30px; }
        .c-logo { height: 70px; margin-bottom: 15px; }
        .c-title { font-size: 2.8rem; font-weight: 800; color: var(--s-color); text-transform: uppercase; margin: 0; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        
        .c-recipient { text-align: center; border-top: 3px solid var(--p-color); border-bottom: 3px solid var(--p-color); padding: 20px; margin-bottom: 30px; }
        .r-name { font-size: 2.2rem; font-weight: 700; color: var(--p-color); }
        .r-meta { font-size: 1.1rem; color: #555; margin-top: 5px; }

        .c-wish {
            background: #fff; border-left: 6px solid var(--s-color); padding: 25px;
            font-family: 'Quicksand', sans-serif; font-size: 1.3rem; line-height: 1.6;
            text-align: justify; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .c-history { background: #f0f9ff; border: 1px dashed var(--p-color); padding: 20px; border-radius: 10px; font-size: 0.95rem; margin-bottom: 30px; }
        .h-title { font-weight: 700; color: var(--p-color); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .h-list ul { margin: 0; padding-left: 20px; }

        .c-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; }
        .s-name { font-size: 1.4rem; font-weight: 700; color: var(--p-color); }
        .s-org { font-size: 1rem; color: #666; }
        .f-ads { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .f-ads img { height: 70px; border-radius: 6px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }

        /* --- EFFECTS (T√°i s·ª≠ d·ª•ng) --- */
        /* Balloon */
        .balloon-box { position: absolute; animation: float 6s infinite ease-in-out; }
        .balloon { width: 40px; height: 50px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff, currentColor); }
        .string { width: 1px; height: 60px; background: #555; margin: 0 auto; opacity: 0.5; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }

        /* Tech Grid */
        .tech-grid {
            background-image: linear-gradient(rgba(24,119,82,0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(24,119,82,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Flower */
        .flower { position: absolute; font-size: 24px; animation: fall 2.5s linear forwards; z-index: 100; pointer-events: none; }
        @keyframes fall { to { transform: translateY(800px) rotate(360deg); opacity: 0; } }

        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .app-layout { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; }
            .preview { padding: 10px; min-height: 80vh; }
            .card-wrap { transform: scale(0.6); margin-top: -200px; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--p-color)"></i>
        <p style="margin-top:10px; font-weight:600;">ƒêang k·∫øt n·ªëi LAZINET...</p>
    </div>

    <div class="app-layout">
        <div class="sidebar">
            <div class="sb-header">
                <img id="sb-logo" src="" alt="LAZINET">
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">Professional Card Creator</div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="setTab('info')">Th√¥ng tin</div>
                <div class="tab" onclick="setTab('design')">Thi·∫øt k·∫ø</div>
                <div class="tab" onclick="setTab('export')">Xu·∫•t file</div>
            </div>

            <div id="tab-info" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Ng∆∞·ªùi nh·∫≠n (H√¥m nay)</label>
                    <select id="sel-recipient" class="form-select" onchange="loadRecipient()">
                        <option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Chi ti·∫øt</label>
                    <input id="inp-title" class="form-control" placeholder="Danh x∆∞ng" oninput="render()">
                    <input id="inp-name" class="form-control" style="margin-top:5px" placeholder="H·ªç t√™n" oninput="render()">
                    <input id="inp-comp" class="form-control" style="margin-top:5px" placeholder="C√¥ng ty" oninput="render()">
                </div>

                <div class="form-group">
                    <label class="form-label">L·ªùi ch√∫c</label>
                    <select id="sel-wish" class="form-select" onchange="pickWish()">
                        <option value="">-- M·∫´u l·ªùi ch√∫c --</option>
                    </select>
                    <button class="btn btn-s" style="margin-top:5px" onclick="aiWish()"><i class="fas fa-magic"></i> AI Vi·∫øt M·ªõi</button>
                    <textarea id="inp-wish" class="form-control" style="margin-top:5px" rows="4" oninput="render()"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">S·ª± ki·ªán l·ªãch s·ª≠</label>
                    <div style="display:flex; gap:5px">
                        <input id="inp-date" class="form-control" readonly>
                        <button class="btn btn-p" style="width:auto" onclick="loadHistory()"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
            </div>

            <div id="tab-design" class="tab-content">
                <div class="form-group">
                    <label class="form-label">H√¨nh n·ªÅn</label>
                    <select id="sel-bg" class="form-select" onchange="setBg()">
                        <option value="def">M·∫∑c ƒë·ªãnh</option>
                    </select>
                    <input id="inp-bg-url" class="form-control" style="margin-top:5px" placeholder="URL ·∫£nh..." onchange="setBg('url')">
                </div>

                <div class="form-group">
                    <label class="form-label">Hi·ªáu ·ª©ng n·ªÅn</label>
                    <div class="fx-grid">
                        <div class="fx-item active" onclick="setFx(this, 'bg', 'none')">None</div>
                        <div class="fx-item" onclick="setFx(this, 'bg', 'tech')">Tech Grid</div>
                        <div class="fx-item" onclick="setFx(this, 'bg', 'balloon')">Balloons</div>
                        <div class="fx-item" onclick="setFx(this, 'bg', 'stars')">Stars</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Hi·ªáu ·ª©ng Click</label>
                    <div class="fx-grid">
                        <div class="fx-item active" onclick="setFx(this, 'clk', 'none')">None</div>
                        <div class="fx-item" onclick="setFx(this, 'clk', 'confetti')">Confetti</div>
                        <div class="fx-item" onclick="setFx(this, 'clk', 'flower')">Flowers</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ng∆∞·ªùi g·ª≠i</label>
                    <input id="inp-sig-name" class="form-control" placeholder="T√™n" oninput="render()">
                    <input id="inp-sig-org" class="form-control" style="margin-top:5px" placeholder="T·ªï ch·ª©c" oninput="render()">
                </div>
            </div>

            <div id="tab-export" class="tab-content">
                <button class="btn btn-p" onclick="exportImg()"><i class="fas fa-image"></i> T·∫£i ·∫£nh (PNG)</button>
                <button class="btn btn-s" onclick="exportPdf()"><i class="fas fa-file-pdf"></i> T·∫£i PDF</button>
                
                <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
                
                <label class="form-label">C·∫•u h√¨nh API</label>
                <input id="api-url" class="form-control" placeholder="Script URL...">
                <button class="btn btn-o" onclick="saveApi()">L∆∞u API</button>
            </div>
        </div>

        <div class="preview" onclick="doClickFx(event)">
            <div id="card" class="card-wrap">
                <div id="lyr-bg" class="layer-bg"></div>
                <div id="lyr-fx" class="layer-fx"></div>
                
                <div class="layer-content">
                    <div class="c-header">
                        <img id="out-logo" class="c-logo">
                        <h1 class="c-title">CH√öC M·ª™NG SINH NH·∫¨T</h1>
                    </div>

                    <div class="c-recipient">
                        <div class="r-name"><span id="out-title"></span> <span id="out-name">ABC</span></div>
                        <div class="r-meta">
                            <span id="out-comp">LAZINET</span> | <i class="far fa-calendar-alt"></i> <span id="out-dob">01/01</span>
                        </div>
                    </div>

                    <div class="c-wish">
                        <span id="out-wish">...</span>
                    </div>

                    <div class="c-history">
                        <div class="h-title"><i class="fas fa-star"></i> S·ª∞ KI·ªÜN L·ªäCH S·ª¨</div>
                        <div id="out-history" class="h-list">...</div>
                    </div>

                    <div class="c-footer">
                        <p>Th√¢n m·∫øn,</p>
                        <div id="out-sig-name" class="s-name"></div>
                        <div id="out-sig-org" class="s-org"></div>
                        <div class="f-ads">
                            <img id="ad1"> <img id="ad2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API = "https://script.google.com/macros/s/AKfycbxLAmO9YXhO9DsKdU6V7Fk7ka3CueQxQfOvQQ6z_-1kFnF_nitDgeCVLxr_oiaWr_WnhQ/exec"; // Thay URL
        let data = { config: {}, list: [] };
        let fx = { bg: 'none', clk: 'none' };

        // INIT
        window.onload = () => {
            const s = localStorage.getItem('gas_api');
            if(s) { API = s; document.getElementById('api-url').value = s; }
            
            const d = new Date();
            document.getElementById('inp-date').value = `${d.getDate()}/${d.getMonth()+1}`;
            document.getElementById('out-dob').innerText = `${d.getDate()}/${d.getMonth()+1}`;
            
            fetchData();
        };

        async function fetchData() {
            try {
                const r = await fetch(API, { method:'POST', body:JSON.stringify({action:'getInitData'}) });
                const j = await r.json();
                if(j.status !== 'success') throw j.message;
                
                data = j.data;
                initUI();
                document.getElementById('loader').style.display='none';
            } catch(e) { alert('L·ªói: '+e); document.getElementById('loader').style.display='none'; }
        }

        function initUI() {
            const c = data.config;
            const root = document.documentElement.style;
            root.setProperty('--p-color', c['Style-PrimaryColor']);
            root.setProperty('--s-color', c['Style-SecondaryColor']);

            // Recipient List
            const s = document.getElementById('sel-recipient');
            data.list.forEach((p,i) => s.add(new Option(`${p.name} (${p.company})`, i)));

            // Wishes & BGs
            const w = document.getElementById('sel-wish');
            for(let i=0;i<=10;i++) { if(c[`Wish-0${i}`]) w.add(new Option(`M·∫´u ${i}`, c[`Wish-0${i}`])); }
            
            const b = document.getElementById('sel-bg');
            for(let i=1;i<=10;i++) { if(c[`Background-0${i}`]) b.add(new Option(`N·ªÅn ${i}`, c[`Background-0${i}`])); }

            // Defaults
            document.getElementById('sb-logo').src = c['Signature-Logo-URL'];
            document.getElementById('out-logo').src = c['Signature-Logo-URL'];
            document.getElementById('inp-sig-name').value = c['Signature-Name'];
            document.getElementById('inp-sig-org').value = c['Signature-Organization-Full'];
            document.getElementById('inp-wish').value = c['Wish-00'];
            document.getElementById('ad1').src = c['Content-Image1-URL'];
            document.getElementById('ad2').src = c['Content-Image2-URL'];
            
            setBg('def');
            render();
            loadHistory();
        }

        // ACTIONS
        function setTab(id) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
        }

        function render() {
            const v = id => document.getElementById(id).value;
            document.getElementById('out-title').innerText = v('inp-title');
            document.getElementById('out-name').innerText = v('inp-name') || "T√äN NG∆Ø·ªúI NH·∫¨N";
            document.getElementById('out-comp').innerText = v('inp-comp');
            document.getElementById('out-wish').innerText = v('inp-wish');
            document.getElementById('out-sig-name').innerText = v('inp-sig-name');
            document.getElementById('out-sig-org').innerText = v('inp-sig-org');
        }

        function loadRecipient() {
            const i = document.getElementById('sel-recipient').value;
            if(i==="") return;
            const p = data.list[i];
            document.getElementById('inp-title').value = p.title;
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-comp').value = p.company;
            if(p.wish) document.getElementById('inp-wish').value = p.wish;
            render();
        }

        function setBg(type='sel') {
            let u = type==='sel' ? document.getElementById('sel-bg').value : document.getElementById('inp-bg-url').value;
            if(u === 'def') u = data.config['Background-00'];
            document.getElementById('lyr-bg').style.backgroundImage = `url('${u}')`;
        }

        // AI
        async function aiWish() {
            const btn = event.target; btn.innerHTML = '...';
            const i = document.getElementById('sel-recipient').value;
            const p = {
                title: document.getElementById('inp-title').value,
                name: document.getElementById('inp-name').value,
                company: document.getElementById('inp-comp').value,
                pref: i!=="" ? data.list[i].pref : "",
                id: i!=="" ? data.list[i].id : null
            };
            
            const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'generateAIWish', ...p})});
            const j = await r.json();
            document.getElementById('inp-wish').value = j.data;
            render();
            btn.innerHTML = '<i class="fas fa-magic"></i> AI Vi·∫øt M·ªõi';
        }

        async function loadHistory() {
            const d = document.getElementById('inp-date').value;
            const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'getHistoryEvents', date:d})});
            const j = await r.json();
            document.getElementById('out-history').innerHTML = j.data;
        }

        // EFFECTS
        function setFx(el, cat, val) {
            el.parentElement.querySelectorAll('.fx-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            fx[cat] = val;
            
            if(cat === 'bg') {
                const l = document.getElementById('lyr-fx');
                l.innerHTML = ''; l.className = 'layer-fx';
                if(val === 'tech') {
                    l.classList.add('tech-grid');
                } else if(val === 'balloon') {
                    const c = ['red','blue','gold','purple'];
                    for(let i=0; i<6; i++) {
                        l.innerHTML += `<div class="balloon-box" style="left:${i*15+5}%; animation-delay:${i*0.5}s">
                        <div class="balloon" style="color:${c[i%4]}"></div><div class="string"></div></div>`;
                    }
                }
            }
        }

        function doClickFx(e) {
            if(fx.clk === 'confetti') {
                confetti({ particleCount:100, spread:70, origin:{x:e.clientX/window.innerWidth, y:e.clientY/window.innerHeight} });
            } else if(fx.clk === 'flower') {
                const f = document.createElement('div');
                f.className = 'flower'; f.innerText = 'üå∏';
                f.style.left = e.clientX+'px'; f.style.top = e.clientY+'px';
                document.body.appendChild(f);
                setTimeout(()=>f.remove(), 2500);
            }
        }

        // EXPORT
        function exportImg() {
            const c = document.getElementById('card');
            c.style.transform = 'none';
            html2canvas(c, {scale:2}).then(cv => {
                const a = document.createElement('a');
                a.download = 'card.png'; a.href = cv.toDataURL(); a.click();
                c.style.transform = 'scale(0.6)';
            });
        }

        function exportPdf() {
            const c = document.getElementById('card');
            c.style.transform = 'none';
            html2canvas(c, {scale:2}).then(cv => {
                const p = new jspdf.jsPDF('p','px',[cv.width,cv.height]);
                p.addImage(cv.toDataURL(), 'PNG', 0,0,cv.width,cv.height);
                p.save('card.pdf');
                c.style.transform = 'scale(0.6)';
            });
        }

        function saveApi() {
            localStorage.setItem('gas_api', document.getElementById('api-url').value);
            alert('ƒê√£ l∆∞u!');
        }
    </script>
</body>
</html>