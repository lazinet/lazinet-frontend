<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET Birthday Card Creator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #187752;
            --secondary: #B91C1C;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Be Vietnam Pro', sans-serif; margin: 0; padding: 0; background: var(--bg-light); height: 100vh; overflow: hidden; display: flex; }

        /* --- LAYOUT --- */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
            height: 100%;
            background: #fff;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .preview-area {
            flex-grow: 1;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #e2e8f0;
            position: relative;
            overflow: hidden;
            padding: 20px;
        }

        /* --- UI COMPONENTS --- */
        h2 { font-size: 1.1rem; color: var(--primary); margin: 0 0 10px 0; border-bottom: 2px solid var(--secondary); padding-bottom: 5px; }
        
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; color: #4b5563; }
        
        select, input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }
        select:focus, input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24, 119, 82, 0.1); }
        
        textarea { resize: vertical; min-height: 70px; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 100%; padding: 8px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 600; transition: 0.2s; gap: 6px; font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #145c40; }
        .btn-outline { background: #fff; border: 1px solid var(--primary); color: var(--primary); margin-top: 5px;}
        .btn-outline:hover { background: #f0fdf4; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }

        /* --- THE CARD --- */
        #card-container {
            width: 100%;
            max-width: 700px;
            background-color: white;
            background-size: cover;
            background-position: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            /* overflow: hidden; */ /* B·ªè overflow hidden ƒë·ªÉ hi·ªÉn th·ªã b√≥ng ƒë·ªï ƒë·∫πp h∆°n, handle effect b·∫±ng canvas ri√™ng */
            display: flex;
            flex-direction: column;
            border-radius: 8px;
        }
        
        /* Effect Canvas n·∫±m ƒë√® l√™n card */
        #effect-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            border-radius: 8px;
        }

        /* Card Internals */
        .card-header { padding: 30px; text-align: center; background: rgba(255,255,255,0.85); backdrop-filter: blur(3px); border-radius: 8px 8px 0 0; }
        .card-logo { max-height: 80px; width: auto; margin-bottom: 10px; }
        .card-title { font-size: 2rem; color: var(--primary); margin: 5px 0; text-transform: uppercase; font-weight: 800; line-height: 1.2; text-shadow: 1px 1px 0px #fff;}
        .card-recipient { font-size: 1.5rem; color: var(--secondary); margin: 0; font-weight: 700;}
        
        .card-body { padding: 25px 40px; background: rgba(255,255,255,0.9); flex-grow: 1; display: flex; flex-direction: column; gap: 15px;}
        .card-wish { font-size: 1rem; line-height: 1.6; text-align: justify; white-space: pre-wrap; color: #333; }
        
        .history-box { 
            background: #f8fafc; border-left: 4px solid var(--primary); padding: 12px; border-radius: 0 6px 6px 0;
            font-size: 0.85rem; color: #555; display: none; margin-top: 10px;
        }
        .history-box h4 { margin: 0 0 8px 0; color: var(--primary); display: flex; align-items: center; gap: 5px; font-size: 0.9rem;}
        .history-box ul { margin: 0; padding-left: 20px; }
        .history-box li { margin-bottom: 4px; }

        .card-footer { padding: 15px; background: var(--primary); color: white; text-align: center; margin-top: auto; border-radius: 0 0 8px 8px; }
        .footer-sig-name { font-weight:bold; font-size: 1rem; }
        .footer-sig-title { font-style:italic; font-size: 0.8rem; opacity: 0.9; margin-bottom: 8px; }
        .footer-links { font-size: 0.75rem; opacity: 0.8; }
        
        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%;
            width: 18px; height: 18px; animation: spin 0.8s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; height: auto; border-bottom: 1px solid var(--border); border-right: none; }
            .preview-area { width: 100%; padding: 10px; min-height: auto; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>üéâ Thi·∫øt l·∫≠p thi·ªáp</h2>
            <div class="loader" id="main-loader"></div>
        </div>

        <div class="control-group">
            <label>1. Ng∆∞·ªùi nh·∫≠n (Sinh nh·∫≠t h√¥m nay)</label>
            <select id="recipient-select" onchange="loadRecipient()">
                <option value="">-- T·ª± nh·∫≠p tay --</option>
            </select>
        </div>

        <div class="control-group">
            <label>2. L·ªùi ch√∫c</label>
            <select id="wish-preset" onchange="applyWishPreset()">
                <option value="">-- Ch·ªçn m·∫´u c√¢u --</option>
            </select>
            <textarea id="wish-text" placeholder="N·ªôi dung l·ªùi ch√∫c..." style="margin-top:5px;" oninput="updateCardUI()"></textarea>
            <button class="btn btn-outline" onclick="generateNewWish()" id="btn-gen-wish">
                <i class="bi bi-stars"></i> AI vi·∫øt l·∫°i l·ªùi ch√∫c
            </button>
        </div>

        <div class="control-group">
            <label>3. S·ª± ki·ªán ng√†y n√†y</label>
            <button class="btn btn-outline" onclick="fetchHistoryEvents()" id="btn-history">
                <i class="bi bi-clock-history"></i> L·∫•y s·ª± ki·ªán l·ªãch s·ª≠
            </button>
        </div>

        <div class="control-group">
            <label>4. H√¨nh n·ªÅn</label>
            <select id="bg-select" onchange="changeBackground(this.value)">
                <option value="">M·∫∑c ƒë·ªãnh</option>
            </select>
            <input type="text" id="bg-url" placeholder="D√°n link ·∫£nh kh√°c..." onchange="changeBackground(this.value)" style="margin-top:5px;">
        </div>

        <div class="control-group">
            <label>5. Hi·ªáu ·ª©ng</label>
            <select id="effect-select" onchange="changeEffect(this.value)">
                <option value="none">Kh√¥ng hi·ªáu ·ª©ng</option>
                <option value="confetti">üéâ Tung hoa (Confetti)</option>
                <option value="balloons">üéà B√≥ng bay (Particles)</option>
                <option value="snow">‚ú® Sao r∆°i (Sparkles)</option>
            </select>
        </div>
        
        <div class="control-group" style="border-top:1px dashed #ccc; padding-top:10px;">
            <label>Th√¥ng tin t√πy ch·ªânh</label>
            <input type="text" id="inp-name" placeholder="T√™n (VD: Anh Nam)" oninput="updateCardUI()">
            <input type="text" id="inp-company" placeholder="C√¥ng ty" oninput="updateCardUI()" style="margin-top:5px;">
        </div>

        <div style="margin-top: auto;">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportImage()"><i class="bi bi-download"></i> T·∫£i ·∫¢nh</button>
                <button class="btn btn-primary" style="background:var(--secondary)" onclick="exportPDF()"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div id="card-container">
            <canvas id="effect-layer"></canvas>

            <div class="card-header">
                <img id="card-logo" src="" alt="" class="card-logo" style="display:none;">
                <h1 class="card-title">HAPPY BIRTHDAY</h1>
                <h2 id="card-recipient-name" class="card-recipient">Kh√°ch h√†ng th√¢n thi·∫øt</h2>
                <div id="card-recipient-company" style="color:#555; margin-top:5px; font-weight:600;"></div>
            </div>

            <div class="card-body">
                <div id="card-wish-content" class="card-wish">
                    Ch√∫c m·ª´ng sinh nh·∫≠t! Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi tr√†n ƒë·∫ßy ni·ªÅm vui, s·ª©c kh·ªèe v√† th√†nh c√¥ng r·ª±c r·ª°.
                </div>
                
                <div id="history-section" class="history-box">
                    <h4><i class="bi bi-calendar-check"></i> S·ª± ki·ªán ng√†y n√†y:</h4>
                    <div id="history-content"></div>
                </div>
            </div>

            <div class="card-footer">
                <div id="sig-name" class="footer-sig-name"></div>
                <div id="sig-title" class="footer-sig-title"></div>
                <div id="footer-contact" class="footer-links"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // const GAS_URL = 'https://script.google.com/macros/s/AKfycbz1_22M1aNX5RsXPo_-ge-wfpZDBIOILHQ99j18u6FZkE5OG3kqGFOsXJqo3_ziSo4n7Q/exec'; // THAY URL M·ªöI C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxixifBOem1WWnJCZd1fTO7IKial-Wk9tLehHvP-d_y0znMmvloKjDWqV7bqoiJKTFWMA/exec';
        // const GAS_URL = 'https://script.google.com/macros/s/AKfycbwJBU1yGXhmlr0tHl8zipF1y6AafbRjdDklKdCC08hfcZnAG7ZWqCv-G4gFEF1tNMQ3Dw/exec';

        // Global Data
        let globalSettings = {};
        let todayBirthdays = [];
        
        // Effects Global Vars
        let currentEffectInterval = null;
        let myConfetti = null;

        // --- INIT ---
        window.addEventListener('load', async () => {
            const loader = document.getElementById('main-loader');
            loader.style.display = 'block';
            
            try {
                await Promise.all([loadSettings(), loadBirthdays()]);
            } catch (err) {
                console.error("Init Error", err);
            }
            
            loader.style.display = 'none';
        });

        // --- API CALLS ---
        async function loadSettings() {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getPublicConfig' })
                });
                const json = await response.json();
                if (json.success) {
                    globalSettings = json.data;
                    applyInitialSettings();
                } else {
                    console.error("Load settings failed:", json.message);
                }
            } catch (e) { console.error(e); }
        }

        async function loadBirthdays() {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getTodayBirthdays' })
                });
                const json = await response.json();
                if (json.success) {
                    todayBirthdays = json.data;
                    populateRecipientSelect();
                }
            } catch (e) { console.error(e); }
        }

        async function generateNewWish() {
            const btn = document.getElementById('btn-gen-wish');
            const originalText = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = '<span class="loader" style="display:inline-block; border-width:2px; width:14px; height:14px;"></span> ƒêang vi·∫øt...';

            const userData = {
                title: "",
                name: document.getElementById('inp-name').value,
                company: document.getElementById('inp-company').value,
                preference: "T·∫°o l·ªùi ch√∫c m·ªõi m·∫ª, ·∫•n t∆∞·ª£ng"
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'generateWish', data: userData })
                });
                const json = await response.json();
                if (json.success) {
                    document.getElementById('wish-text').value = json.data;
                    document.getElementById('card-wish-content').innerText = json.data;
                } else {
                    alert("L·ªói AI: " + json.message);
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi AI: " + e.message);
            } finally {
                btn.disabled = false; btn.innerHTML = originalText;
            }
        }

        async function fetchHistoryEvents() {
            const box = document.getElementById('history-section');
            const content = document.getElementById('history-content');
            const btn = document.getElementById('btn-history');
            
            box.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; padding:10px;"><span class="loader" style="display:inline-block;"></span> ƒêang t·∫£i...</div>';
            btn.disabled = true;

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getHistoryEvents' })
                });
                const json = await response.json();
                if (json.success) {
                    content.innerHTML = json.data;
                } else {
                    content.innerHTML = `<span style="color:red">L·ªói: ${json.message}</span>`;
                }
            } catch (e) {
                content.innerHTML = "L·ªói k·∫øt n·ªëi.";
            } finally {
                btn.disabled = false;
            }
        }

        // --- UI FUNCTIONS ---
        function applyInitialSettings() {
            const s = globalSettings;
            
            // Colors
            if(s['Style-PrimaryColor']) document.documentElement.style.setProperty('--primary', s['Style-PrimaryColor']);
            if(s['Style-SecondaryColor']) document.documentElement.style.setProperty('--secondary', s['Style-SecondaryColor']);

            // Header Info
            if(s['Signature-Logo-URL']) {
                const logo = document.getElementById('card-logo');
                logo.src = s['Signature-Logo-URL'];
                logo.style.display = 'inline-block';
            }
            
            // Footer Info
            document.getElementById('sig-name').innerText = s['Signature-Name'] || '';
            document.getElementById('sig-title').innerText = s['Signature-Organization-Full'] || '';
            
            const hotline = s['Footer-Hotline'] ? `Hotline: ${s['Footer-Hotline']}` : '';
            const web = s['Signature-Organization-HREF'] ? `Web: ${s['Signature-Organization-HREF']}` : '';
            document.getElementById('footer-contact').innerText = [hotline, web].filter(Boolean).join(' | ');

            // Background Dropdown Logic (Fixed)
            const bgSel = document.getElementById('bg-select');
            bgSel.innerHTML = `<option value="${s['Background-00'] || ''}">M·∫∑c ƒë·ªãnh</option>`;
            
            Object.keys(s).forEach(key => {
                if (key.startsWith('Background-') && key !== 'Background-00') {
                    // Extract number e.g. Background-01 -> 1
                    const labelPart = key.split('-')[1]; 
                    if(s[key]) {
                        const opt = document.createElement('option');
                        opt.value = s[key];
                        opt.text = `H√¨nh n·ªÅn ${labelPart}`;
                        bgSel.appendChild(opt);
                    }
                }
            });
            // Set default bg
            if(s['Background-00']) changeBackground(s['Background-00']);

            // Wish Dropdown
            const wishSel = document.getElementById('wish-preset');
            Object.keys(s).forEach(key => {
                if (key.startsWith('Wish-') && key !== 'Wish-MaxChar') {
                    const labelPart = key.split('-')[1];
                    const opt = document.createElement('option');
                    opt.value = s[key];
                    opt.text = `M·∫´u c√¢u ch√∫c ${labelPart}`;
                    wishSel.appendChild(opt);
                }
            });
            // Set default wish
            if(s['Wish-00']) {
                document.getElementById('wish-text').value = s['Wish-00'];
                document.getElementById('card-wish-content').innerText = s['Wish-00'];
            }
        }

        function populateRecipientSelect() {
            const sel = document.getElementById('recipient-select');
            todayBirthdays.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.title} ${p.name} (${p.company})`;
                sel.appendChild(opt);
            });
        }

        function loadRecipient() {
            const id = document.getElementById('recipient-select').value;
            const person = todayBirthdays.find(p => p.id == id);

            if (person) {
                document.getElementById('inp-name').value = `${person.title} ${person.name}`;
                document.getElementById('inp-company').value = person.company;
                
                if(person.wish && person.wish.length > 5) {
                    document.getElementById('wish-text').value = person.wish;
                }
                updateCardUI();
            }
        }

        function updateCardUI() {
            document.getElementById('card-recipient-name').innerText = document.getElementById('inp-name').value || 'Kh√°ch h√†ng';
            document.getElementById('card-recipient-company').innerText = document.getElementById('inp-company').value;
            document.getElementById('card-wish-content').innerText = document.getElementById('wish-text').value;
        }

        function applyWishPreset() {
            const val = document.getElementById('wish-preset').value;
            if(val) {
                document.getElementById('wish-text').value = val;
                document.getElementById('card-wish-content').innerText = val;
            }
        }

        function changeBackground(url) {
            if(url) {
                document.getElementById('card-container').style.backgroundImage = `url('${url}')`;
            } else {
                document.getElementById('card-container').style.backgroundImage = 'none';
            }
        }

        // --- EFFECTS (FIXED) ---
        function changeEffect(type) {
            const canvas = document.getElementById('effect-layer');
            const ctx = canvas.getContext('2d');
            
            // Clean up previous
            if(currentEffectInterval) {
                clearInterval(currentEffectInterval);
                currentEffectInterval = null;
            }
            if(myConfetti) {
                myConfetti.reset();
                myConfetti = null;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Resize canvas to match card
            const card = document.getElementById('card-container');
            canvas.width = card.offsetWidth;
            canvas.height = card.offsetHeight;

            if (type === 'confetti') {
                runConfetti(canvas);
            } else if (type === 'balloons') {
                runParticles(ctx, canvas.width, canvas.height, 'circle');
            } else if (type === 'snow') {
                runParticles(ctx, canvas.width, canvas.height, 'star');
            }
        }

        function runConfetti(canvas) {
            // FIX: useWorker: false to avoid InvalidStateError with existing context
            myConfetti = confetti.create(canvas, {
                resize: true,
                useWorker: false 
            });
            
            myConfetti({
                particleCount: 150,
                spread: 160,
                origin: { y: 0.5 },
                gravity: 0.8,
                scalar: 1.2
            });
        }

        function runParticles(ctx, w, h, shape) {
            const particles = [];
            const count = 40;
            
            for(let i=0; i<count; i++) {
                particles.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: Math.random() * 5 + 2,
                    d: Math.random() * count,
                    color: shape === 'star' ? '#FFD700' : `hsla(${Math.random()*360}, 80%, 60%, 0.8)`
                });
            }

            function draw() {
                ctx.clearRect(0, 0, w, h);
                for(let i = 0; i < count; i++) {
                    const p = particles[i];
                    ctx.beginPath();
                    ctx.fillStyle = p.color;
                    ctx.moveTo(p.x, p.y);
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2, true);
                    ctx.fill();
                }
                update();
            }

            function update() {
                for(let i = 0; i < count; i++) {
                    const p = particles[i];
                    // Simple gravity & sway
                    p.y += Math.cos(p.d) + 1 + p.r/2;
                    p.x += Math.sin(0); 

                    if(p.y > h) { // Reset to top
                        particles[i] = {
                            x: Math.random() * w, 
                            y: -10, 
                            r: p.r, 
                            d: p.d, 
                            color: p.color
                        };
                    }
                }
            }
            
            currentEffectInterval = setInterval(draw, 40);
        }

        // --- EXPORT ---
        function exportImage() {
            const element = document.getElementById('card-container');
            // T·∫°m th·ªùi t·∫Øt hi·ªáu ·ª©ng canvas khi ch·ª•p ƒë·ªÉ tr√°nh l·ªói taint
            const canvas = document.getElementById('effect-layer');
            const originalDisplay = canvas.style.display;
            canvas.style.display = 'none';

            html2canvas(element, { scale: 2, useCORS: true }).then(c => {
                const link = document.createElement('a');
                link.download = `Birthday-Card.png`;
                link.href = c.toDataURL("image/png");
                link.click();
                canvas.style.display = originalDisplay; // B·∫≠t l·∫°i hi·ªáu ·ª©ng
            });
        }

        function exportPDF() {
            const element = document.getElementById('card-container');
            const canvas = document.getElementById('effect-layer');
            const originalDisplay = canvas.style.display;
            canvas.style.display = 'none';

            html2canvas(element, { scale: 2, useCORS: true }).then(c => {
                const imgData = c.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (c.height * pdfWidth) / c.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Birthday-Card.pdf`);
                canvas.style.display = originalDisplay;
            });
        }
    </script>
</body>
</html>