<!DOCTYPE html>
<html lang="zxx">
<head>
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="Awaiken">
    <!-- Page Title (dynamic) -->
    <title id="dynamic-title">Netzon - Cyber Security Services HTML Template</title>
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">
    <!-- Google Fonts Css-->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100..800&amp;display=swap" rel="stylesheet">
    <!-- Bootstrap Css -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <!-- SlickNav Css -->
    <link href="assets/css/slicknav.min.css" rel="stylesheet">
    <!-- Swiper Css -->
    <link rel="stylesheet" href="assets/css/swiper-bundle.min.css">
    <!-- Font Awesome Icon Css-->
    <link href="assets/css/all.min.css" rel="stylesheet" media="screen">
    <!-- Animated Css -->
    <link href="assets/css/animate.css" rel="stylesheet">
    <!-- Magnific Popup Core Css File -->
    <link rel="stylesheet" href="assets/css/magnific-popup.css">
    <!-- Mouse Cursor Css File -->
    <link rel="stylesheet" href="assets/css/mousecursor.css">
    <!-- Main Custom Css -->
    <link href="assets/css/custom.css" rel="stylesheet" media="screen">
    <style>
        /* Custom Tooltip for Image Overlay (list mode) */
        .post-featured-image {
            position: relative;
            overflow: hidden;
        }
        .post-featured-image .image-tooltip {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 14px;
            line-height: 1.4;
            z-index: 10;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            max-height: 80%;
        }
        .post-featured-image .image-tooltip .tooltip-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }
        .post-featured-image .image-tooltip .tooltip-body {
            text-align: justify;
            hyphens: auto;
        }
        .post-featured-image:hover .image-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .post-featured-image figure {
            position: relative;
        }
        .post-featured-image img {
            transition: transform 0.3s ease;
        }
        .post-featured-image:hover img {
            transform: scale(1.05);
        }
        /* Single post styles */
        .post-byline {
            font-weight: bold;
            font-style: italic;
            margin-bottom: 20px;
            color: #333;
        }
        #post-image img {
            min-height: 300px;
            background-color: #f0f0f0;
        }
        .page-single-post {
            display: none; /* Ẩn ban đầu */
        }
        .page-blog .page-pagination {
            display: none; /* Ẩn pagination khi single */
        }
        /* Transition giữa list và single */
        .page-transition {
            transition: opacity 0.3s ease;
        }
        /* Force visible for single post image (override GSAP initial state) */
        #single-container .reveal {
            visibility: visible !important;
            opacity: 1 !important;
            transform: none !important;
        }
        #single-container .reveal img {
            transform: none !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body>

    <!-- Preloader Start -->
    <div class="preloader">
        <div class="loading-container">
            <div class="loading"></div>
            <div id="loading-icon"><img src="assets/img/logo-lazinet/lazinet_LogoOnly.svg" alt=""></div>
        </div>
    </div>
    <!-- Preloader End -->

    <!-- Page Blog Start (List Mode) -->
    <div class="page-blog page-transition" id="list-container">
        <div class="container">
            <div class="row" id="blog-list">
                <!-- Dynamic posts will be rendered here -->
            </div>
            <div class="col-lg-12">
                <!-- Page Pagination Start -->
                <div class="page-pagination wow fadeInUp" data-wow-delay="1s">
                    <ul class="pagination">
                        <li><a href="#"><i class="fa-solid fa-angle-left"></i></a></li>
                        <li class="active"><a href="#">1</a></li>
                        <li><a href="#">2</a></li>
                        <li><a href="#">3</a></li>
                        <li><a href="#"><i class="fa-solid fa-angle-right"></i></a></li>
                    </ul>
                </div>
                <!-- Page Pagination End -->
            </div>
        </div>
    </div>
    <!-- Page Blog End -->

    <!-- Page Single Post (Single Mode) -->
    <div class="page-single-post page-transition" id="single-container">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Post Featured Image Start -->
                    <div class="post-image" id="post-image">
                        <!-- Dynamic image -->
                    </div>
                    <!-- Post Featured Image End -->

                    <!-- Post Single Content Start -->
                    <div class="post-content">
                        <!-- Post Entry Start -->
                        <div class="post-entry" id="post-entry">
                            <!-- Dynamic content -->
                        </div>
                        <!-- Post Entry End -->

                        <!-- Post Tag Links Start -->
                        <div class="post-tag-links">
                            <div class="row align-items-center">
                                <div class="col-lg-8">
                                    <!-- Post Tags Start -->
                                    <div class="post-tags wow fadeInUp" data-wow-delay="0.5s" id="post-tags">
                                        <!-- Dynamic tags -->
                                    </div>
                                    <!-- Post Tags End -->
                                </div>

                                <div class="col-lg-4">
                                    <!-- Post Social Sharing Start -->
                                    <div class="post-social-sharing wow fadeInUp" data-wow-delay="0.5s">
                                        <ul id="social-share">
                                            <li><a href="#" id="share-fb"><i class="fa-brands fa-facebook-f"></i></a></li>
                                            <li><a href="#" id="share-li"><i class="fa-brands fa-linkedin-in"></i></a></li>
                                            <li><a href="#" id="share-ig"><i class="fa-brands fa-instagram"></i></a></li>
                                            <li><a href="#" id="share-tw"><i class="fa-brands fa-x-twitter"></i></a></li>
                                        </ul>
                                    </div>
                                    <!-- Post Social Links End -->
                                </div>
                            </div>
                        </div>
                        <!-- Post Tag Links End -->
                    </div>
                    <!-- Post Single Content End -->
                </div>
            </div>
        </div>
    </div>
    <!-- Page Single Post End -->

    <!-- Back to List Button (for single mode) -->
    <div id="back-to-list" style="display: none; position: fixed; top: 20px; left: 20px; z-index: 1000;">
        <a href="?" class="btn btn-primary">← Back to List</a>
    </div>

    <!-- Jquery Library File -->
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script src="assets/js/circle-progress.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/validator.min.js"></script>
    <script src="assets/js/jquery.slicknav.js"></script>
    <script src="assets/js/swiper-bundle.min.js"></script>
    <script src="assets/js/jquery.waypoints.min.js"></script>
    <script src="assets/js/jquery.counterup.min.js"></script>
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/SmoothScroll.js"></script>
    <script src="assets/js/parallaxie.js"></script>
    <script src="assets/js/gsap.min.js"></script>
    <script src="assets/js/magiccursor.js"></script>
    <script src="assets/js/SplitText.min.js"></script>
    <script src="assets/js/ScrollTrigger.min.js"></script>
    <script src="assets/js/jquery.mb.YTPlayer.min.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/function.js"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxdg67nrP0Bf4VJzDRa7JAH5i--Z0EbWFMDKUv1TLFwRQtkCpkL57mNx07D9Q53h-Udxg/exec';
    const BASE_IMG_URL = 'assets/img/';
    const PLACEHOLDER_IMG = 'assets/images/placeholder.jpg';  // Tạo file nếu cần

    let allBlogs = [];  // Cache data từ list để đồng bộ

    // Share links (cho single mode)
    function setupShareLinks() {
        const currentUrl = encodeURIComponent(window.location.href);
        const fb = document.getElementById('share-fb');
        const li = document.getElementById('share-li');
        const ig = document.getElementById('share-ig');
        const tw = document.getElementById('share-tw');
        if (fb) fb.href = `https://www.facebook.com/sharer/sharer.php?u=${currentUrl}`;
        if (li) li.href = `https://www.linkedin.com/sharing/share-offsite/?url=${currentUrl}`;
        if (ig) ig.href = `https://www.instagram.com/?url=${currentUrl}`;
        if (tw) tw.href = `https://twitter.com/intent/tweet?url=${currentUrl}&text=Check this out!`;
    }

    // Render single blog
    function renderSingleBlog(blog) {
        const titleEl = document.getElementById('dynamic-title');
        const metaEl = document.getElementById('dynamic-meta');
        if (titleEl) titleEl.textContent = `${blog.Title} - Lazinet`;
        if (metaEl) metaEl.setAttribute('content', blog['P1 (Intro)'] ? blog['P1 (Intro)'].substring(0, 150) + '...' : '');

        // Image - Fix: Exact same src as list, with detailed log
        const imgSubUrl = blog.Image_Sub_URL || '';
        const imgSrc = imgSubUrl ? BASE_IMG_URL + imgSubUrl : PLACEHOLDER_IMG;
        console.log('Single Blog - Raw Image_Sub_URL from data:', imgSubUrl);  // Check raw data from API/cache
        console.log('Single Blog - Full img src:', imgSrc);  // Should match list src exactly
        const postImageEl = document.getElementById('post-image');
        if (postImageEl) {
            // Option 1: Giữ animation nhưng force reveal (khuyến nghị - mượt mà)
            postImageEl.innerHTML = `
                <figure class="image-anime reveal">
                    <img src="${imgSrc}" alt="${blog.Title || 'Blog Image'}" loading="lazy" onerror="console.log('Image load error for src:', '${imgSrc}'); this.src='${PLACEHOLDER_IMG}'">
                </figure>
            `;
            
            // Force GSAP animation chạy ngay sau render (refresh ScrollTrigger)
            if (typeof ScrollTrigger !== 'undefined') {
                ScrollTrigger.refresh();  // Recalculate tất cả triggers sau khi DOM thay đổi
                // Optional: Force play animation cho reveal cụ thể nếu cần
                const revealContainer = postImageEl.querySelector('.reveal');
                if (revealContainer && revealContainer._gsap) {
                    revealContainer._gsap.restart(true);  // Restart animation nếu đã init
                }
            }
            
            // Force set to visible state ngay lập tức (override GSAP initial from state)
            if (typeof gsap !== 'undefined') {
                const revealContainer = postImageEl.querySelector('.reveal');
                if (revealContainer) {
                    gsap.set(revealContainer, { xPercent: 0, autoAlpha: 1 });
                    const image = revealContainer.querySelector('img');
                    if (image) {
                        gsap.set(image, { xPercent: 0, scale: 1, autoAlpha: 1 });
                    }
                }
            }
            
            // Option 2: Bỏ animation hoàn toàn ở single (nếu không muốn effect - uncomment dòng dưới, comment phần trên)
            // postImageEl.innerHTML = `<figure><img src="${imgSrc}" alt="${blog.Title || 'Blog Image'}" loading="lazy" onerror="console.log('Image load error for src:', '${imgSrc}'); this.src='${PLACEHOLDER_IMG}'"></figure>`;
        }

        // Content
        let entryHtml = `
            <p class="post-byline wow fadeInUp">By <strong><em>${blog.Author || 'Lazinet Team'}</em></strong> at <a href="${blog.Location_URL || '#'}"><strong><em>${blog.Location || 'N/A'}</em></strong></a> on <strong><em>${new Date(blog.Date).toLocaleDateString('vi-VN')}</em></strong></p>
            <p class="wow fadeInUp">${blog['P1 (Intro)'] || ''}</p>
            <p class="wow fadeInUp" data-wow-delay="0.2s">${blog['P2 (Main)'] || ''}</p>
        `;

        if (blog.Quote) {
            entryHtml += `<blockquote class="wow fadeInUp" data-wow-delay="0.4s"><p>${blog.Quote}</p></blockquote>`;
        }

        entryHtml += `
            <p class="wow fadeInUp" data-wow-delay="0.6s">${blog['P3 (End)'] || ''}</p>
            <h2 class="wow fadeInUp" data-wow-delay="0.8s">${blog.H2 || ''}</h2>
            <p class="wow fadeInUp" data-wow-delay="1s">${blog.P4 || ''}</p>
        `;

        // List items
        let listItems = [];
        for (let i = 1; i <= 6; i++) {
            const liKey = `Li${i}`;
            if (blog[liKey]) listItems.push(`<li>${blog[liKey]}</li>`);
        }
        if (listItems.length > 0) {
            entryHtml += `<ul class="wow fadeInUp" data-wow-delay="1.2s">${listItems.join('')}</ul>`;
        }

        entryHtml += `<p class="wow fadeInUp" data-wow-delay="1.4s">${blog.P5 || ''}</p>`;

        if (blog.External_Name && blog.External_Link) {
            entryHtml += `<p>Source: <a href="${blog.External_Link}" target="_blank">${blog.External_Name}</a></p>`;
        }

        if (blog.Notes) {
            entryHtml += `<p class="wow fadeInUp" data-wow-delay="1.6s"><em>${blog.Notes}</em></p>`;
        }

        const postEntryEl = document.getElementById('post-entry');
        if (postEntryEl) postEntryEl.innerHTML = entryHtml;

        // Tags
        let tagsHtml = '<span class="tag-links">Tags: ';
        let tags = [];
        for (let i = 1; i <= 6; i++) {
            const tagKey = `Tag${i}`;
            if (blog[tagKey]) tags.push(`<a href="#">${blog[tagKey]}</a>`);
        }
        if (tags.length > 0) {
            tagsHtml += tags.join(' ') + '</span>';
            const postTagsEl = document.getElementById('post-tags');
            if (postTagsEl) postTagsEl.innerHTML = tagsHtml;
        } else {
            const postTagsEl = document.getElementById('post-tags');
            if (postTagsEl) postTagsEl.innerHTML = '';
        }

        // Setup share
        setupShareLinks();

        // Re-init WOW
        new WOW().init();
        
        // Thêm: Refresh GSAP toàn bộ sau WOW (để chắc chắn)
        if (typeof ScrollTrigger !== 'undefined') {
            ScrollTrigger.refresh();
        }
    }

    // Load list
    function loadBlogList() {
        $.ajax({
            url: SCRIPT_URL + '?action=list',
            dataType: 'jsonp',
            success: function(blogs) {
                allBlogs = blogs;  // Cache cho đồng bộ
                console.log('List blogs loaded:', blogs);
                const row = document.getElementById('blog-list');
                if (row) row.innerHTML = '';  // Clear
                blogs.forEach((blog, index) => {
                    const delay = (index * 0.2) + 's';
                    const dateStr = blog['Date'] ? new Date(blog['Date']).toLocaleDateString('vi-VN') : '';
                    const locationStr = blog['Location'] || 'N/A';
                    const introFull = blog['P1 (Intro)'] || '';

                    const tooltipHtml = `
                        <div class="tooltip-header"><strong>${dateStr} - ${locationStr}</strong></div>
                        <div class="tooltip-body">${introFull}</div>
                    `;

                    const imgSubUrlList = blog.Image_Sub_URL || '';
                    const imgSrcList = imgSubUrlList ? BASE_IMG_URL + imgSubUrlList : PLACEHOLDER_IMG;
                    console.log('List Blog - Raw Image_Sub_URL:', imgSubUrlList);  // Debug list raw
                    console.log('List Blog - Full img src:', imgSrcList);  // So sánh với single

                    const postHtml = `
                        <div class="col-xl-4 col-md-6">
                            <div class="post-item wow fadeInUp" data-wow-delay="${delay}">
                                <div class="post-featured-image">
                                    <a href="?blog_id=${blog.Blog_ID}" data-cursor-text="View">
                                        <figure class="image-anime">
                                            <img src="${imgSrcList}" alt="${blog.Title}">
                                            <div class="image-tooltip">${tooltipHtml}</div>
                                        </figure>
                                    </a>
                                </div>
                                <div class="post-item-body">
                                    <div class="post-item-content">
                                        <h2><a href="?blog_id=${blog.Blog_ID}">${blog.Title}</a></h2>
                                    </div>
                                    <div class="post-item-btn">
                                        <a href="?blog_id=${blog.Blog_ID}" class="readmore-btn">read more</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    row.insertAdjacentHTML('beforeend', postHtml);
                });
                new WOW().init();
            },
            error: function() {
                console.error('Error loading blogs');
                const row = document.getElementById('blog-list');
                if (row) row.innerHTML = '<p>Error loading posts.</p>';
            }
        });
    }

    // Load single từ cache hoặc API
    function loadSingleBlog(blogId) {
        // Kiểm tra cache trước (đồng bộ, tránh gọi API nếu có)
        const cachedBlog = allBlogs.find(b => b.Blog_ID === blogId);
        if (cachedBlog && cachedBlog['P2 (Main)']) {  // Nếu cache có full data
            console.log('Using cached blog for single:', cachedBlog);
            renderSingleBlog(cachedBlog);
        } else {
            // Fetch full
            $.ajax({
                url: SCRIPT_URL + '?blog_id=' + blogId,
                dataType: 'jsonp',
                success: function(blog) {
                    console.log('Single blog loaded from API:', blog);
                    if (blog.error) {
                        alert('Blog not found');
                        window.location.href = '?';  // Back to list
                        return;
                    }
                    renderSingleBlog(blog);
                },
                error: function() {
                    console.error('Error loading single blog');
                    alert('Error loading post');
                    window.location.href = '?';
                }
            });
        }
    }

    // Main init
    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const blogId = urlParams.get('blog_id');

        if (blogId) {
            // Single mode
            const listContainer = document.getElementById('list-container');
            const singleContainer = document.getElementById('single-container');
            const backBtn = document.getElementById('back-to-list');
            if (listContainer) listContainer.style.display = 'none';
            if (singleContainer) singleContainer.style.display = 'block';
            if (backBtn) backBtn.style.display = 'block';
            
            // Delay nhỏ để DOM render, rồi load và refresh
            setTimeout(() => {
                loadSingleBlog(blogId);
                // Refresh GSAP sau khi show container
                if (typeof ScrollTrigger !== 'undefined') {
                    ScrollTrigger.refresh();
                }
                // Additional force refresh after a bit more time
                setTimeout(() => {
                    if (typeof ScrollTrigger !== 'undefined') {
                        ScrollTrigger.refresh();
                    }
                }, 500);
            }, 100);  // 100ms đủ để display block settle
        } else {
            // List mode
            const singleContainer = document.getElementById('single-container');
            const backBtn = document.getElementById('back-to-list');
            if (singleContainer) singleContainer.style.display = 'none';
            if (backBtn) backBtn.style.display = 'none';
            loadBlogList();
        }
    });
</script>
</body>
</html>