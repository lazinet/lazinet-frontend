<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Thời tiết cho Cà Phê - LAZINET</title>
    <meta name="description" content="Theo dõi thời tiết tối ưu cho cây cà phê tại Việt Nam với bản đồ tương tác, dự báo chi tiết, và khuyến nghị nông nghiệp từ LAZINET.">
    <meta name="keywords" content="thời tiết cà phê, dự báo thời tiết Việt Nam, nông nghiệp cà phê, LAZINET, thời tiết nông nghiệp">
    <meta name="author" content="LAZINET">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://lazinet.com/assets/img/lazinet_LogoOnly.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lazinet-orange': '#FF6F00',
                        'lazinet-blue': '#0000FF',
                        'lazinet-green': '#00FF00'
                    },
                    screens: {
                        'xs': '480px',
                        '3xl': '1920px'
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   
    <!-- Fullscreen Control CSS + JS -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.0.0/dist/Control.FullScreen.min.css" /> -->

    <!-- Thêm CSS và JS Marker đẹp -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>

    <!-- Thêm CSS và JS Vẽ đẹp -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        /* Base styles */
        #map {
            height: 400px;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .icon-hover:hover {
            color: #FF6F00;
            transform: scale(1.2);
        }

        /* Chart container */
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 111, 0, 0.3);
            border-radius: 50%;
            border-top-color: #FF6F00;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            #map {
                height: 500px;
            }
            
            .chart-container {
                height: 350px;
            }
        }

        @media (min-width: 1024px) {
            #map {
                height: calc(100vh - 250px);
            }
            
            .chart-container {
                height: 400px;
            }
        }

        @media (max-width: 767px) {
            #map {
                height: 350px;
            }
            
            .header-title h1 {
                font-size: 1.25rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .table-container {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 639px) {
            #map {
                height: 300px;
            }
            
            .header-title h1 {
                font-size: 1.1rem;
            }
        }

        /* Custom controls */
        .custom-arrow {
            font-size: 0.8rem;
            line-height: 1;
            width: 1.2rem;
            height: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .leaflet-control-geocoder-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><g transform="translate(15, 15), scale(0.7)"><g id="SVGRepo_iconCarrier"><path d="M36.277 13.297c-6.698 0-12.185 5.471-12.185 12.15c0 2.588.825 4.994 2.224 6.971l8.473 11.494c1.187 1.55 1.978 1.256 2.965-.082l9.348-12.75a6.87 6.87 0 0 0 .464-1.074c.577-1.41.897-2.95.897-4.559c0-6.679-5.487-12.15-12.186-12.15zm0 5.693c3.607 0 6.477 2.86 6.477 6.457s-2.87 6.46-6.477 6.46s-6.476-2.863-6.476-6.46c0-3.596 2.87-6.457 6.476-6.457z" fill="%23FF6F00"/><path d="M37.18.178c-9.53 0-19.061 3.623-26.309 10.87c-14.495 14.496-14.495 38.123 0 52.618C24.44 77.234 45.97 78.032 60.557 66.193l3.576 3.577a3.956 5.958 45 0 0 .646 3.613L90.73 99.334a3.956 5.958 45 0 0 7.01-1.416a3.956 5.958 45 0 0 1.416-7.01l-25.95-25.951a3.956 5.958 45 0 0-3.616-.646l-3.576-3.577c11.839-14.587 11.043-36.117-2.526-49.685C56.241 3.8 46.71.178 37.18.178zm0 8.217c7.397 0 14.795 2.834 20.463 8.501a28.875 28.875 0 0 1 0 40.924a28.875 28.875 0 0 1-40.924 0a28.875 28.875 0 0 1 0-40.924c5.667-5.667 13.064-8.501 20.46-8.501z" fill="blue"/><path d="M29.727 52.003L19.439 55.38a25.527 25.527 0 0 0 16.102 7.119z" fill="%23FF6F00"/><path d="M62.492 41.253l-25.476 8.36l6.705 12.1a25.637 25.637 0 0 0 9.828-5.054a25.543 25.543 0 0 0 8.943-15.406z" fill="%23FF6F00"/><path d="M11.674 34.38a25.53 25.53 0 0 0 2.94 14.65l9.52-3.123z" fill="%23FF6F00"/><path d="M60.002 25.146l-5.303 10.732l7.916-2.596a25.486 25.486 0 0 0-2.613-8.136z" fill="%23FF6F00"/></g></g></svg>');
        }
        .leaflet-control-layers-toggle {
            background-image: url("data:image/svg+xml,%3Csvg fill='%23000000' height='800px' width='800px' version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 48.698 48.698' xml:space='preserve'%3E%3Cg id='SVGRepo_bgCarrier' stroke-width='0'%3E%3C/g%3E%3Cg id='SVGRepo_tracerCarrier' stroke-linecap='round' stroke-linejoin='round'%3E%3C/g%3E%3Cg id='SVGRepo_iconCarrier'%3E%3Cpath d='M24.349,0L0.914,13.309l23.436,13.39l23.435-13.39L24.349,0z M8.996,13.319L24.349,4.6l15.354,8.719l-15.354,8.772 L8.996,13.319z' fill='blue'/%3E%3Cpolygon points='24.349,29.002 8.548,19.974 0.914,24.309 24.349,37.698 47.784,24.309 40.151,19.974 ' fill='%23FF6F00'/%3E%3Cpolygon points='24.349,40.002 8.548,30.974 0.914,35.309 24.349,48.698 47.784,35.309 40.151,30.974 ' fill='blue' /%3E%3C/g%3E%3C/svg%3E") !important;
            background-size: 30px 30px;
            background-position: center;
            background-repeat: no-repeat;
            width: 30px;
            height: 30px;
        }
        #map {
            border: 1px solid blue !important; /* Viền màu xanh dương */
            border-radius: 8px; /* Bo góc */
            box-shadow: 0 0 10px rgba(0, 0, 255, 0.3); /* Hiệu ứng đổ bóng */
        }
        
        /* Thay đổi icon measure control */
        .leaflet-control-measure-toggle {
            background-image: none !important; /* Ẩn icon mặc định */
            position: relative;
            width: 30px !important;
            height: 30px !important;
        }

        .leaflet-control-measure-toggle:before {
            content: "";
            display: block;
            width: 22px;
            height: 22px;
            background-image: url("data:image/svg+xml,%3Csvg fill='%23000000' height='800px' width='800px' version='1.1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 490 490'%3E%3Cpath d='M488.185,474.254l-330.001-470c-2.506-3.57-7.038-5.103-11.197-3.789S140,5.637,140,10v470c0,5.523,4.477,10,10,10h330 c3.731,0,7.152-2.078,8.873-5.388C490.594,481.301,490.328,477.307,488.185,474.254z M160,470v-30h30v-20h-30v-50h30v-20h-30v-50 h30v-20h-30v-50h30v-20h-30v-50h30v-20h-30V41.645L460.76,470H160z' fill='blue'/%3E%3Cpath d='M225,400h105c3.788,0,7.25-2.14,8.944-5.528c1.694-3.388,1.328-7.442-0.944-10.472L233,244 c-2.583-3.444-7.078-4.849-11.162-3.487C217.755,241.874,215,245.696,215,250v140C215,395.523,219.477,400,225,400z M235,280 l75,100h-75V280z' fill='%23FF6F00'/%3E%3Cpath d='M110,0H10C4.477,0,0,4.477,0,10v470c0,5.523,4.477,10,10,10h100c5.523,0,10-4.477,10-10V10C120,4.477,115.523,0,110,0z M100,470H20v-45h40v-20H20v-60h40v-20H20v-70h40v-20H20v-70h40v-20H20V85h40V65H20V20h80V470z' fill='blue'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Hiệu ứng khi hover */
        .leaflet-control-measure-toggle:hover {
            background-color: rgba(255, 111, 0, 0.2); /* Màu cam nhạt khi hover */
        }
        /* Giảm độ nổi của logo Leaflet mặc định */
        .leaflet-control-attribution {
        opacity: 0.1;
        /* background: rgba(255, 255, 255, 1) !important; */
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <!-- Header optimized for all devices -->
    <header class="bg-white text-blue shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-3 sm:px-4">
            <div class="flex flex-col xs:flex-row items-center justify-between py-2 sm:py-3 md:py-4">
                <!-- Logo -->
                <div class="w-full xs:w-auto flex justify-center xs:justify-start mb-2 xs:mb-0">
                    <a href="https://lazinet.com/" target="_blank" class="flex-shrink-0">
                        <img src="https://lazinet.com/assets/img/lazinet_LogoFullv2.png" 
                             alt="LAZINET Logo" 
                             class="h-10 sm:h-12 md:h-14 w-auto max-w-[180px] sm:max-w-[220px] object-contain">
                    </a>
                </div>

                <!-- Title - Responsive text and layout -->
                <div class="flex-1 text-center xs:text-left px-2 min-w-0">
<h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-lazinet-blue leading-tight text-center">                        <span class="whitespace-nowrap">ỨNG DỤNG THỜI TIẾT CHO CÀ PHÊ</span>
                        <!-- <span class="block xs:inline"> - <span class="text-lazinet-orange">LAZI</span>NET</span> -->
                    </h1>
                </div>

                <!-- Tagline - Hidden on smallest screens -->
                <div class="hidden sm:flex sm:w-auto justify-end ml-2 md:ml-4 whitespace-nowrap">
                    <span class="text-xs sm:text-sm md:text-base lg:text-lg font-semibold text-lazinet-orange">
                        CÔNG NGHỆ HIỆU QUẢ
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-3 sm:p-4">
        <p class="text-center text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">Nhấp vào bản đồ để chọn vị trí và xem thông tin thời tiết</p>

        <!-- Main content grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- Map section -->
            <div class="lg:col-span-2 map-container">
                <div id="map" class="rounded-lg shadow-lg"></div>
            </div>

            <!-- Sidebar with cards -->
            <div id="sidebar" class="space-y-4 sm:space-y-6">
                <!-- Location Card -->
                <div id="location-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md fade-in border border-[blue]">
                    <h2 class="text-lg sm:text-xl font-semibold text-lazinet-orange mb-3 sm:mb-4 flex items-center">
                        <i class="bi bi-geo-alt-fill mr-2 icon-hover transition-transform"></i> THÔNG TIN VỊ TRÍ
                    </h2>
                    <ul class="space-y-2 text-sm sm:text-base">
                        <li id="address" class="text-gray-700 flex items-start">
                            <i class="bi bi-map-fill mr-2 text-lazinet-blue mt-0.5"></i>
                            <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="lat" class="text-gray-700 flex items-center">
                            <i class="bi bi-geo-alt mr-2 text-lazinet-blue"></i>
                            <strong>Vĩ độ:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="lon" class="text-gray-700 flex items-center">
                            <i class="bi bi-geo-alt mr-2 text-lazinet-blue"></i>
                            <strong>Kinh độ:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                    </ul>
                </div>

                <!-- Weather Card -->
                <div id="weather-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md fade-in border border-[blue]">
                    <h2 class="text-lg sm:text-xl font-semibold text-lazinet-orange mb-3 sm:mb-4 flex items-center">
                        <i class="bi bi-cloud-fill mr-2 icon-hover transition-transform"></i> THỜI TIẾT HIỆN TẠI
                    </h2>
                    <ul class="space-y-2 text-sm sm:text-base">
                        <li id="weather-location" class="text-gray-700 flex items-start">
                            <i class="bi bi-map-fill mr-2 text-lazinet-blue mt-0.5"></i>
                            <strong>Địa điểm:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-time" class="text-gray-700 flex items-center">
                            <i class="bi bi-clock-fill mr-2 text-lazinet-blue"></i>
                            <strong>Thời gian:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-condition" class="text-gray-700 flex items-center">
                            <i class="bi bi-cloud-sun-fill mr-2 text-lazinet-blue"></i>
                            <strong>Mô tả:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-temp" class="text-gray-700 flex items-center">
                            <i class="bi bi-thermometer-half mr-2 text-lazinet-blue"></i>
                            <strong>Nhiệt độ:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-humidity" class="text-gray-700 flex items-center">
                            <i class="bi bi-droplet-fill mr-2 text-lazinet-blue"></i>
                            <strong>Độ ẩm:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-precip" class="text-gray-700 flex items-center">
                            <i class="bi bi-cloud-rain-fill mr-2 text-lazinet-blue"></i>
                            <strong>Lượng mưa:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-wind" class="text-gray-700 flex items-center">
                            <i class="bi bi-wind mr-2 text-lazinet-blue"></i>
                            <strong>Mức gió:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-cloud" class="text-gray-700 flex items-center">
                            <i class="bi bi-clouds-fill mr-2 text-lazinet-blue"></i>
                            <strong>Mây phủ:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-vis" class="text-gray-700 flex items-center">
                            <i class="bi bi-eye-fill mr-2 text-lazinet-blue"></i>
                            <strong>Tầm nhìn:</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                        <li id="weather-uv" class="text-gray-700 flex items-center">
                            <i class="bi bi-sun-fill mr-2 text-lazinet-blue"></i>
                            <strong>Tử ngoại (UV):</strong> <span class="ml-2"><span class="loading-text">Đang tải...</span></span>
                        </li>
                    </ul>
                </div>

                <!-- Recommendations Card -->
                <div id="recommendations-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md fade-in border border-[blue]">
                    <h2 class="text-lg sm:text-xl font-semibold text-lazinet-orange mb-3 sm:mb-4 flex items-center">
                        <i class="bi bi-leaf-fill mr-2 icon-hover transition-transform"></i> KHUYẾN NGHỊ CHO CÀ PHÊ
                    </h2>
                    <ul id="recommendations" class="space-y-2 text-sm sm:text-base">
                        <li class="text-gray-700 flex items-start">
                            <span class="loading-text flex items-center">
                                <span class="loading-spinner mr-2"></span> Đang tải khuyến nghị...
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <!-- <div id="chart-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md mt-4 sm:mt-6 fade-in"> -->
        <div id="chart-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md mt-4 sm:mt-6 fade-in border border-[blue]">
            <h2 class="text-lg sm:text-xl font-semibold text-lazinet-orange mb-3 sm:mb-4 flex items-center">
                <i class="bi bi-graph-up mr-2 icon-hover transition-transform"></i> BIỂU ĐỒ THỜI TIẾT
            </h2>
            <div class="chart-container">
                <canvas id="weather-chart"></canvas>
            </div>
        </div>

        <!-- Forecast Table -->
        <div id="table-card" class="card bg-white p-4 sm:p-6 rounded-lg shadow-md mt-4 sm:mt-6 fade-in border border-[blue]">
            <h2 class="text-lg sm:text-xl font-semibold text-lazinet-orange mb-3 sm:mb-4 flex items-center">
                <i class="bi bi-table mr-2 icon-hover transition-transform"></i> DỰ BÁO THỜI TIẾT
            </h2>
            <div class="table-container">
                <table id="forecast-table" class="min-w-full bg-white border border-gray-200 text-sm sm:text-base">
                    <thead>
                        <tr class="bg-lazinet-orange text-white">
                            <th class="py-2 px-3 sm:px-4 border-b text-left">Thời gian</th>
                            <th class="py-2 px-3 sm:px-4 border-b text-left">Nhiệt độ (°C)</th>
                            <th class="py-2 px-3 sm:px-4 border-b text-left">Độ ẩm (%)</th>
                            <th class="py-2 px-3 sm:px-4 border-b text-left">Lượng mưa (mm/h)</th>
                            <th class="py-2 px-3 sm:px-4 border-b text-left">Thời tiết</th>
                        </tr>
                    </thead>
                    <tbody id="forecast-table-body">
                        <tr>
                            <td colspan="5" class="py-4 text-center text-gray-500">
                                <span class="loading-text flex items-center justify-center">
                                    <span class="loading-spinner mr-2"></span> Đang tải dữ liệu...
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-4 sm:mt-6 fade-in" role="alert">
            <span id="error-text"></span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>
    <!-- <script src="https://unpkg.com/leaflet.fullscreen@2.0.0/dist/Control.FullScreen.min.js"></script> -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
        // Initialize map
        const map = L.map('map', {
            center: [17.002871, 107.052361],
            zoom: 6,
            // minZoom: 4,
            // maxZoom: 18,
            // maxBounds: [[8.0, 102.0], [23.0, 110.0]],
            zoomControl: false,
            worldCopyJump: true
        });

        // Base maps
        const baseMaps = {
            "Bản đồ Mặc định": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}),
            "Vệ tinh": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {}),
            "Giao thông": L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=a61706a0e2424a7b9e1b6d5a8d7a1b1c', {}),
            "Địa hình": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {})
        };
        const overlayMaps = {
            "Độ pH đất": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/phh2o.map", {
                layers: 'phh2o_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Hàm lượng Nitơ (cg/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/nitrogen.map", {
                layers: 'nitrogen_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Mật độ Carbon hữu cơ (hg/m³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/ocd.map", {
                layers: 'ocd_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Khả năng trao đổi cation, mmol(c)/kg": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/cec.map", {
                layers: 'cec_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),

            // Thuộc tính vật lý
            "Độ chặt đất (cg/cm³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/bdod.map", {
                layers: 'bdod_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Đất sét (g/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/clay.map", {
                layers: 'clay_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Cát (g/kg)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/sand.map", {
                layers: 'sand_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
            "Đá vụn (cm³/dm³)": L.tileLayer.wms("https://maps.isric.org/mapserv?map=/map/cfvo.map", {
                layers: 'cfvo_0-5cm_mean', format: 'image/png', transparent: true, attribution: 'SoilGrids', opacity: 0.7
            }),
        };

        // Add default base map
        baseMaps["Bản đồ Mặc định"].addTo(map);

        // Add marker
        // let marker = L.marker([17.002871, 107.052361]).addTo(map);

        // Tạo marker màu đỏ với icon
// var marker = L.marker([17.002871, 107.052361], {
//     icon: L.AwesomeMarkers.icon({
//         icon: 'map-marker',
//         markerColor: 'red',
//         prefix: 'fa',
//         extraClasses: 'fas'
//     })
// }).addTo(map);

// var marker = L.marker([17.002871, 107.052361], {
//     icon: L.divIcon({
//         html: `<div style="background:#FF6F00; width:24px; height:24px; border-radius:50%; border:2px solid white"></div>`,
//         className: 'custom-marker',
//         iconSize: [24, 24] 
//     })
// }).addTo(map);

// var redMarker = L.icon({
//     iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
//     iconSize: [25, 41],    // Kích thước
//     iconAnchor: [12, 41]   // Vị trí neo
// });

// let marker = L.marker([17.002871, 107.052361], {icon: redMarker}).addTo(map);

        // var marker = L.circleMarker([17.002871, 107.052361], {
        //     radius: 10,
        //     fillColor: "#4A90E2",
        //     color: "#000",
        //     weight: 1,
        //     opacity: 1,
        //     fillOpacity: 0.8
        // }).addTo(map);

var customIcon = L.divIcon({
  html: `
    <svg width="32" height="56.25" viewBox="0 0 1024 1800" preserveAspectRatio="xMidYMin meet">
        <line x1="512" x2="512" y1="1000" y2="1800" stroke="blue" stroke-width="60"/>
        <circle cx="512" cy="512" r="502" fill="blue" />
        <circle cx="512" cy="612" r="402" fill="white" />
        <circle cx="512" cy="712" r="302" fill="blue" />
        <circle cx="512" cy="812" r="202" fill="white" />
        <circle cx="512" cy="892" r="122" fill="#ff6302" />
    </svg>
  `,
  className: 'custom-svg-icon',
  iconSize: [40, 70],  // Kích thước hiển thị trên bản đồ (width, height)
  iconAnchor: [20, 65] // Điểm neo (nửa width, gần bottom)
});

let marker = L.marker([17.002871, 107.052361], {
  icon: customIcon
}).addTo(map);

        let currentLatLng = marker.getLatLng();

        // Function to handle map click
        function handleMapClick(e) {
            currentLatLng = e.latlng;
            marker.setLatLng(currentLatLng)
                .setPopupContent("Đang tải dữ liệu thời tiết...")
                .openPopup();
            fetchWeatherData(currentLatLng.lat, currentLatLng.lng);
        }

        // Add click event to map
        map.on('click', handleMapClick);

        // Thêm scale control tùy chỉnh
        L.control.scale({
            position: 'topright',
            metric: true,
            imperial: false,
            maxWidth: 100
        }).addTo(map);  

        // Add search control
        const geocoder = L.Control.geocoder({
            position: 'topright',
            placeholder: 'Tìm kiếm địa điểm...',
            errorMessage: 'Không tìm thấy địa điểm.',
            showResultIcons: true,
            collapsed: true,
            expand: 'click',
            defaultMarkGeocode: false
        }).addTo(map);       

        geocoder.on('markgeocode', function(e) {
            const { center, name } = e.geocode;
            currentLatLng = center;
            marker.setLatLng(center)
                .setPopupContent(`<b>${name}</b><br>Đang tải dữ liệu...`)
                .openPopup();
            map.setView(center, 15);
            fetchWeatherData(center.lat, center.lng);
        }); 

        // Add layer control
        L.control.layers(baseMaps, overlayMaps, {
            position: 'bottomright',
            collapsed: true
        }).addTo(map);        
        
        // Add measure control       
        L.control.measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#FF6F00',
            completedColor: '#0000FF',
            popupOptions: {
                className: 'leaflet-measure-resultpopup',
                autoPanPadding: [10, 10]
            }
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            position: 'topleft',
            draw: { polyline: true, polygon: true, circle: true },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on('draw:created', function (e) {
            drawnItems.addLayer(e.layer);
        });

        // L.control.fullscreen().addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);
        // Add locate control
        L.control.locate({
            position: 'topright',
            strings: {
                title: "Định vị vị trí của tôi",
                popup: "Bạn đang ở trong bán kính {distance} mét từ điểm này",
                outsideMapBoundsMsg: "Bạn dường như nằm ngoài phạm vi bản đồ"
            },
            locateOptions: {
                maxZoom: 15,
                enableHighAccuracy: true
            },
            onLocationError: function(err) {
                showError(`Lỗi định vị: ${err.message}`);
            },
            onLocationFound: function(e) {
                currentLatLng = e.latlng;
                marker.setLatLng(e.latlng)
                    .setPopupContent("Vị trí của bạn<br>Đang tải dữ liệu...")
                    .openPopup();
                fetchWeatherData(e.latlng.lat, e.latlng.lng);
            }
        }).addTo(map);

        // Add logo to map
        L.Control.Logo = L.Control.extend({
            onAdd: function() {
                const img = L.DomUtil.create('img');
                img.src = 'https://lazinet.com/assets/img/lazinet_LogoFullv2.png';
                img.style.width = '120px';
                img.style.height = 'auto';
                img.style.padding = '5px';
                img.style.background = 'rgba(255,255,255,0.7)';
                img.style.borderRadius = '5px';
                return img;
            }
        });

        new L.Control.Logo({ position: 'bottomleft' }).addTo(map);

        // Thresholds for recommendations
        const thresholds = {
            temperature: [
                -10, "Nhiệt độ thấp cực đoan, cây cà phê dễ bị tổn hại hoặc chết.",
                5, "Nhiệt độ lạnh, giảm sinh trưởng, đặc biệt trong giai đoạn ra hoa.",
                15, "Nhiệt độ hài hòa, phù hợp cho cây cà phê sinh trưởng tốt.",
                25, "Trời ấm, phù hợp cho cây cà phê phát triển.",
                35, "Trời nóng, cần tưới nước nếu nắng nóng kéo dài.", 
                70
            ],
            humidity: [
                0, "Độ ẩm thấp, cây cà phê mất nước nhanh, cần tưới gấp!",
                40, "Độ ẩm thấp, giảm quang hợp, cần theo dõi tưới nước.",
                60, "Độ ẩm tối ưu, cây cà phê hấp thụ nước và dinh dưỡng hiệu quả.",
                90, "Độ ẩm cao, quả cà phê dễ bị nấm mốc.", 
                100
            ],
            precipitation: [
                0, "Không mưa, cần tưới nước định kỳ.",
                0.1, "Mưa nhỏ, tốt cho cây cà phê.",
                1, "Mưa tốt, lưu ý đắp gốc bảo vệ cây con.",
                2, "Mưa to, cần thoát nước và bù phân.",
                4, "Mưa xối xả, cây cà phê dễ bị úng, cần thoát nước gấp.", 
                100
            ],
            wind: [
                0, "Gió nhẹ, không gây hại.",
                20, "Gió vừa, kiểm tra cây con và hoa quả.",
                40, "Gió mạnh, cây cà phê dễ rụng lá, cần che chắn.",
                60, "Gió giật mạnh, cây có thể nghiêng ngã, cần chống đỡ.",
                80, "Bão tố, cây cà phê dễ bật gốc, cần xử lý khẩn cấp.", 
                500
            ],
            uv: [
                0, "UV an toàn.",
                3, "UV nhẹ, cần mũ nón khi làm việc ngoài trời.",
                5, "UV cao, hạn chế ra ngoài từ 11h-15h.",
                7, "UV rất cao, tránh ra ngoài từ 10h-16h.",
                11, "UV cực cao, tránh ra ngoài hoàn toàn.", 
                500
            ]
        };

        // Chart.js instance
        let weatherChart = null;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('weather-chart').getContext('2d');
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 25 }, (_, i) => ((i + 6) % 24)),
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            data: [],
                            borderColor: '#FF6F00',
                            backgroundColor: 'rgba(255, 111, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Lượng mưa (mm/h)',
                            data: [],
                            borderColor: '#0000FF',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            borderWidth: 1,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Biểu đồ thời tiết 24 giờ',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Giờ trong ngày'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nhiệt độ (°C)'
                            },
                            min: 0,
                            max: 40,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Lượng mưa (mm/h)'
                            },
                            min: 0,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    annotation: {
                        annotations: []
                    }
                }
            });
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // Get recommendation based on value and thresholds
        function getRecommendation(value, thresholdList) {
            for (let i = 0; i < thresholdList.length; i += 2) {
                const low = thresholdList[i];
                const text = thresholdList[i + 1];
                const high = i + 2 < thresholdList.length ? thresholdList[i + 2] : Infinity;
                if (low <= value && value < high) {
                    return text;
                }
            }
            return null;
        }

        // Fetch address from coordinates
        async function getAddressFromCoords(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lon=${lon}&lat=${lat}&format=json&zoom=18&addressdetails=1`, {
                    headers: { 'User-Agent': 'Mozilla/5.0' }
                });
                
                if (!response.ok) {
                    throw new Error('Không thể truy cập API địa chỉ');
                }
                const data = await response.json();
                let detail = data.address.state || '';
                const keys = ['city', 'county', 'city_district', 'town', 'suburb', 'village', 'road', 'neighbourhood'];
                for (const key of keys) {
                    if (data.address[key]) {
                        detail = data.address[key];
                        break;
                    }
                }
                return [detail, data.display_name || ''];
            } catch (e) {
                showError(`Lỗi khi truy cập API địa chỉ: ${e.message}`);
                return ['', ''];
            }
        }

        // Fetch weather data
        async function fetchWeatherData(lat, lon) {
            try {
                // Show loading states
                document.querySelectorAll('.loading-text').forEach(el => {
                    el.textContent = 'Đang tải...';
                });

                // Update marker and get address
                const [locationName, fullAddress] = await getAddressFromCoords(lat, lon);
                marker.setPopupContent(`<b>${locationName || 'Vị trí được chọn'}</b><br>Vĩ độ: ${lat.toFixed(6)}<br>Kinh độ: ${lon.toFixed(6)}`)
                    .openPopup();

                // Update location info
                document.querySelector('#address span').textContent = fullAddress || 'Không xác định';
                document.querySelector('#lat span').textContent = lat.toFixed(6);
                document.querySelector('#lon span').textContent = lon.toFixed(6);
                document.getElementById('location-card').classList.remove('hidden');

                // Fetch weather data
                const apiKey = '5f1bd39bf15c4f4694a145604251202';
                const url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${lat},${lon}&days=3&aqi=yes&alerts=yes&lang=vi`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Lỗi: ${response.status} - ${await response.text()}`);
                }
                const data = await response.json();

                // Update current weather
                updateCurrentWeather(data, locationName);
                
                // Update forecast table
                updateForecastTable(data);
                
                // Update recommendations
                updateRecommendations(data);
                
                // Update chart
                updateWeatherChart(data, locationName);

            } catch (error) {
                showError(`Lỗi khi lấy dữ liệu thời tiết: ${error.message}`);
                marker.setPopupContent(`<b>Lỗi khi tải dữ liệu</b><br>${error.message}`)
                    .openPopup();
            }
        }

        // Update current weather information
        function updateCurrentWeather(data, locationName) {
            const current = data.current;
            
            document.querySelector('#weather-location span').textContent = locationName || 'Không xác định';
            document.querySelector('#weather-time span').textContent = current.last_updated;
            document.querySelector('#weather-condition span').textContent = current.condition.text;
            document.querySelector('#weather-temp span').textContent = `${current.temp_c} °C`;
            document.querySelector('#weather-humidity span').textContent = `${current.humidity} %`;
            document.querySelector('#weather-precip span').textContent = `${current.precip_mm} mm/h`;
            document.querySelector('#weather-wind span').textContent = `${current.wind_kph} km/h`;
            document.querySelector('#weather-cloud span').textContent = `${current.cloud} %`;
            document.querySelector('#weather-vis span').textContent = `${current.vis_km} km`;
            document.querySelector('#weather-uv span').textContent = current.uv;
            
            document.getElementById('weather-card').classList.remove('hidden');
        }

        // Update forecast table
        function updateForecastTable(data) {
            const tbody = document.getElementById('forecast-table-body');
            tbody.innerHTML = '';

            const forecastDays = data.forecast.forecastday;
            
            // Process today's data
            const today = forecastDays[0];
            const tomorrow = forecastDays[1];
            const dayAfter = forecastDays[2];
            
            // Helper function to calculate average for a period
            const getPeriodAverage = (hours, start, end) => {
                const periodHours = hours.slice(start, end);
                return {
                    temp: (periodHours.reduce((sum, h) => sum + h.temp_c, 0) / periodHours.length).toFixed(1),
                    humidity: Math.round(periodHours.reduce((sum, h) => sum + h.humidity, 0) / periodHours.length),
                    precip: (periodHours.reduce((sum, h) => sum + h.precip_mm, 0) / periodHours.length).toFixed(2),
                    condition: [...new Set(periodHours.map(h => h.condition.text))].join(', ')
                };
            };

            // Today's periods
            const todayMorning = getPeriodAverage(today.hour, 6, 12);
            const todayAfternoon = getPeriodAverage(today.hour, 12, 18);
            const todayEvening = getPeriodAverage(today.hour, 18, 24);
            
            // Night period (combine late night today and early morning tomorrow)
            const nightHours = [...today.hour.slice(0, 6), ...tomorrow.hour.slice(0, 6)];
            const nightData = {
                temp: (nightHours.reduce((sum, h) => sum + h.temp_c, 0) / nightHours.length).toFixed(1),
                humidity: Math.round(nightHours.reduce((sum, h) => sum + h.humidity, 0) / nightHours.length),
                precip: (nightHours.reduce((sum, h) => sum + h.precip_mm, 0) / nightHours.length).toFixed(2),
                condition: [...new Set(nightHours.map(h => h.condition.text))].join(', ')
            };

            // Tomorrow and day after
            const tomorrowData = {
                temp: `${tomorrow.day.mintemp_c}-${tomorrow.day.maxtemp_c}`,
                humidity: tomorrow.day.avghumidity,
                precip: (tomorrow.day.totalprecip_mm / 24).toFixed(1),
                condition: tomorrow.day.condition.text
            };

                        const dayAfterData = {
                temp: `${dayAfter.day.mintemp_c}-${dayAfter.day.maxtemp_c}`,
                humidity: dayAfter.day.avghumidity,
                precip: (dayAfter.day.totalprecip_mm / 24).toFixed(1),
                condition: dayAfter.day.condition.text
            };

            // Create table rows
            const periods = [
                { time: 'Sáng', ...todayMorning },
                { time: 'Chiều', ...todayAfternoon },
                { time: 'Tối', ...todayEvening },
                { time: 'Đêm', ...nightData },
                { time: 'Ngày MAI', ...tomorrowData },
                { time: 'Ngày MỐT', ...dayAfterData }
            ];

            periods.forEach(p => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-lazinet-orange', 'hover:bg-opacity-10');
                tr.innerHTML = `
                    <td class="py-2 px-3 sm:px-4 border-b">${p.time}</td>
                    <td class="py-2 px-3 sm:px-4 border-b">${p.temp}</td>
                    <td class="py-2 px-3 sm:px-4 border-b">${p.humidity}</td>
                    <td class="py-2 px-3 sm:px-4 border-b">${p.precip}</td>
                    <td class="py-2 px-3 sm:px-4 border-b">${p.condition}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('table-card').classList.remove('hidden');
        }

        // Update recommendations
        function updateRecommendations(data) {
            const recommendations = document.getElementById('recommendations');
            recommendations.innerHTML = '';

            // Check for weather alerts
            if (data.alerts.alert && data.alerts.alert.length > 0) {
                const li = document.createElement('li');
                li.classList.add('text-red-600', 'font-semibold');
                li.innerHTML = '<i class="bi bi-exclamation-triangle-fill mr-2 text-red-600"></i> Có cảnh báo thời tiết bất thường, kiểm tra chi tiết để xử lý.';
                recommendations.appendChild(li);
            }

            // Get forecast data for recommendations
            const forecastDay = data.forecast.forecastday[0].day;
            const maxTemp = forecastDay.maxtemp_c;
            const avgHumidity = forecastDay.avghumidity;
            const avgPrecip = (forecastDay.totalprecip_mm / 24).toFixed(1);
            const maxWind = forecastDay.maxwind_kph;
            const uvIndex = forecastDay.uv;

            // Get recommendations based on thresholds
            const tempRec = getRecommendation(maxTemp, thresholds.temperature);
            const humidityRec = getRecommendation(avgHumidity, thresholds.humidity);
            const precipRec = getRecommendation(avgPrecip, thresholds.precipitation);
            const windRec = getRecommendation(maxWind, thresholds.wind);
            const uvRec = getRecommendation(uvIndex, thresholds.uv);

            // Add recommendations to list
            [tempRec, humidityRec, precipRec, windRec, uvRec].forEach(text => {
                if (text) {
                    const li = document.createElement('li');
                    li.classList.add('mb-2');
                    li.innerHTML = `<i class="bi bi-arrow-right mr-2 text-white bg-lazinet-blue rounded-full p-1 custom-arrow"></i> ${text}`;
                    recommendations.appendChild(li);
                }
            });

            document.getElementById('recommendations-card').classList.remove('hidden');
        }

        // Update weather chart
        function updateWeatherChart(data, locationName) {
            if (!weatherChart) initChart();
            
            // Prepare data for chart
            const todayHours = data.forecast.forecastday[0].hour;
            const tomorrowHours = data.forecast.forecastday[1].hour;
            
            // Combine today (from 6AM) and tomorrow (until 6AM) for 24-hour view
            const hoursData = [
                ...todayHours.slice(6, 24).map(h => ({
                    time: h.time,
                    temp: h.temp_c,
                    precip: h.precip_mm
                })),
                ...tomorrowHours.slice(0, 6).map(h => ({
                    time: h.time,
                    temp: h.temp_c,
                    precip: h.precip_mm
                }))
            ];
            
            // Format time labels
            const labels = hoursData.map(h => {
                const date = new Date(h.time);
                return date.getHours() + ':00';
            });
            
            // Update chart data
            weatherChart.data.labels = labels;
            weatherChart.data.datasets[0].data = hoursData.map(h => h.temp);
            weatherChart.data.datasets[1].data = hoursData.map(h => h.precip);
            
            // Update chart title with current date and location
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('vi-VN', options);
            weatherChart.options.plugins.title.text = `Biểu đồ thời tiết ngày ${today} tại ${locationName}`;
            
            // Auto-scale y-axis based on data
            const maxTemp = Math.max(...hoursData.map(h => h.temp));
            const minTemp = Math.min(...hoursData.map(h => h.temp));
            weatherChart.options.scales.y.min = Math.floor(minTemp) - 2;
            weatherChart.options.scales.y.max = Math.ceil(maxTemp) + 2;
            
            weatherChart.update();
            document.getElementById('chart-card').classList.remove('hidden');
        }

        // Sync map height with sidebar
        function syncMapHeight() {
            if (window.innerWidth >= 1024) {
                const sidebar = document.getElementById('sidebar');
                const mapDiv = document.getElementById('map');
                if (sidebar && mapDiv) {
                    mapDiv.style.height = `${sidebar.offsetHeight}px`;
                    map.invalidateSize();
                }
            } else {
                const mapDiv = document.getElementById('map');
                if (mapDiv) {
                    mapDiv.style.height = '400px';
                    map.invalidateSize();
                }
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchWeatherData(17.002871, 107.052361);
            syncMapHeight();
            
            // Initialize map size after a short delay to ensure all elements are rendered
            setTimeout(syncMapHeight, 100);
        });

        // Resize listener with debounce
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                syncMapHeight();
                if (weatherChart) {
                    weatherChart.resize();
                }
            }, 100);
        });
    </script>
</body>
</html>