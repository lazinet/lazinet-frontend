<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET - Sản phẩm & Dịch vụ</title>
    <style>
        /* Import CSS từ template Netzone */
        :root {
            --primary-color: #FFFFFF;
            --secondary-color: #FFFFFF0A;
            --orange-main: #ff5000;
            --orange-light: #FFbbbb;
            --blue-main: blue;
            --blue-light: #ccccff;
            --text-color: #FFFFFF;
            --accent-color: #3F82FB;
            --accent-secondary-color: #0F2453;
            --bg-color: #0F162C;
            --white-color: #FFFFFF;
            --black-color: #000000;
            --divider-color: #FFFFFF1A;
            --error-color: rgb(230, 87, 87);
            --default-font: "Instrument Sans", "Geist", "Inter", system-ui, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--default-font);
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header Styles */
        .main-header {
            background: var(--secondary-color);
            backdrop-filter: blur(180px);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 40px;
        }

        /* Tab Navigation */
        .tabs-container {
            margin: 40px 0;
            text-align: center;
        }

        .tabs {
            display: inline-flex;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 5px;
            gap: 5px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: var(--accent-color);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .product-card {
            background: var(--secondary-color);
            backdrop-filter: blur(180px);
            border-radius: 12px;
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            right: 0;
            bottom: 0;
            left: 0;
            height: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--accent-secondary-color) 0%, var(--accent-color) 100%);
            transition: all 0.4s ease-in-out;
        }

        .product-card:hover::before {
            height: 100%;
        }

        .product-card.highlighted::after {
            content: 'Phổ biến';
            position: absolute;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            color: var(--white-color);
            top: 20px;
            right: -35px;
            width: 140px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--accent-color);
            transform: rotate(45deg);
        }

        .product-header {
            border-bottom: 1px solid var(--divider-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .product-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .product-description {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 14px;
        }

        .product-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .product-features {
            list-style: none;
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }

        .product-features li {
            padding: 5px 0;
            position: relative;
            padding-left: 20px;
        }

        .product-features li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--accent-color);
            font-weight: bold;
        }

        .product-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--accent-secondary-color) 0%, var(--accent-color) 50%, var(--accent-secondary-color) 100%);
            background-size: 200% auto;
            border: none;
            border-radius: 8px;
            color: var(--white-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .product-button:hover {
            background-position: right center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--divider-color);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--secondary-color);
            border: 1px solid var(--divider-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 16px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: var(--white-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: var(--accent-secondary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            padding: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <img src="assets/images/logo.svg" alt="LAZINET">
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="tabs-container">
            <div class="tabs" id="categoryTabs">
                </div>
        </div>

        <div class="loading" id="loadingMessage">
            Đang tải sản phẩm...
        </div>

        <div class="error-message" id="errorMessage" style="display: none;">
            Có lỗi xảy ra khi tải sản phẩm. Vui lòng thử lại sau.
        </div>

        <div class="products-grid" id="productsGrid">
            </div>
    </div>

    <div class="modal" id="orderModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h2 id="modalProductName">Đặt hàng</h2>
            <form id="orderForm">
                <input type="hidden" id="modalItemCode">
                
                <div class="form-group">
                    <label for="customerName">Họ tên *</label>
                    <input type="text" id="customerName" required>
                </div>
                
                <div class="form-group">
                    <label for="customerEmail">Email *</label>
                    <input type="email" id="customerEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">Số điện thoại *</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                
                <div class="form-group">
                    <label for="customerNote">Ghi chú</label>
                    <input type="text" id="customerNote">
                </div>
                
                <button type="submit" class="submit-btn">Gửi đơn hàng</button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbzlEMtxJKpYnxq4sa1EnV5Kwz_e_BqumkTvFflTA9na-5j1hXBWCUHI324Z-87l_InG7Q/exec' // URL Google Apps Script Web App
        };

        // Global variables
        let products = [];
        let categories = [];

        // DOM Elements
        const categoryTabs = document.getElementById('categoryTabs');
        const productsGrid = document.getElementById('productsGrid');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const orderModal = document.getElementById('orderModal');
        const closeModal = document.getElementById('closeModal');
        const orderForm = document.getElementById('orderForm');
        const modalProductName = document.getElementById('modalProductName');
        const modalItemCode = document.getElementById('modalItemCode');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupEventListeners();
        });

        function setupEventListeners() {
            closeModal.addEventListener('click', closeOrderModal);
            orderForm.addEventListener('submit', handleOrderSubmit);
            
            // Close modal when clicking outside
            orderModal.addEventListener('click', function(e) {
                if (e.target === orderModal) {
                    closeOrderModal();
                }
            });
        }

        // Load products from backend API
        async function loadProducts() {
            try {
                // Sửa: Thêm action=getProducts để Backend biết trả về danh sách phẳng
                const response = await fetch(`${CONFIG.API_URL}?action=getProducts`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Cập nhật: Backend trả về result.data là list phẳng, khớp với logic cũ.
                    products = result.data; 
                    
                    // Extract unique categories
                    categories = [...new Set(products.map(product => product.cat_type))];
                    
                    renderTabs();
                    renderProducts(products);
                    
                    loadingMessage.style.display = 'none';
                } else {
                    throw new Error(result.error || 'Failed to load products');
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        // Render category tabs
        function renderTabs() {
            categoryTabs.innerHTML = '';
            
            // Add "All" tab
            const allTab = document.createElement('button');
            allTab.className = 'tab active';
            allTab.textContent = 'Tất cả';
            allTab.addEventListener('click', (e) => filterProducts('all', e));
            categoryTabs.appendChild(allTab);
            
            // Add category tabs
            categories.forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.textContent = category;
                tab.addEventListener('click', (e) => filterProducts(category, e));
                categoryTabs.appendChild(tab);
            });
        }

        // Render products grid
        function renderProducts(productsToRender) {
            productsGrid.innerHTML = '';
            
            if (productsToRender.length === 0) {
                productsGrid.innerHTML = '<div class="error-message">Không có sản phẩm nào trong danh mục này.</div>';
                return;
            }
            
            productsToRender.forEach(product => {
                const productCard = createProductCard(product);
                productsGrid.appendChild(productCard);
            });
        }

        // Create product card element
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = `product-card ${product.item_common ? 'highlighted' : ''}`;
            
            // Logic get features được giữ nguyên, dựa vào các trường item_feature_XX
            const features = getProductFeatures(product); 
            
            card.innerHTML = `
                <div class="product-header">
                    <h3 class="product-name">${escapeHtml(product.name)}</h3>
                    <p class="product-description">${escapeHtml(product.cat_intro)}</p>
                </div>
                
                <div class="product-price">${formatPrice(product.pay)}</div>
                
                ${features.length > 0 ? `
                <ul class="product-features">
                    ${features.map(feature => `<li>${escapeHtml(feature)}</li>`).join('')}
                </ul>
                ` : ''}
                
                <button class="product-button" data-item-code="${product.code}">
                    Đặt hàng ngay
                </button>
            `;
            
            // Add click event to order button
            const orderButton = card.querySelector('.product-button');
            orderButton.addEventListener('click', () => openOrderModal(product));
            
            return card;
        }

        // Get product features from feature columns
        function getProductFeatures(product) {
            const features = [];
            for (let i = 1; i <= 10; i++) {
                // Sửa: Truy cập bằng tên thuộc tính item_feature_XX
                const feature = product[`item_feature_${i.toString().padStart(2, '0')}`]; 
                if (feature && feature.trim() !== '') {
                    features.push(feature);
                }
            }
            return features;
        }

        // Format price for display
        function formatPrice(price) {
            if (typeof price === 'number') {
                return price.toLocaleString('vi-VN') + ' ₫';
            }
            return price; // For "Liên hệ LAZINET" etc.
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Filter products by category
        function filterProducts(category, event) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            let filteredProducts;
            if (category === 'all') {
                filteredProducts = products;
            } else {
                filteredProducts = products.filter(product => product.cat_type === category);
            }
            
            renderProducts(filteredProducts);
        }

        // Open order modal
        function openOrderModal(product) {
            modalProductName.textContent = product.name; // Sửa: product.item_name -> product.name
            modalItemCode.value = product.code; // Sửa: product.item_code -> product.code
            orderModal.style.display = 'block';
            
            // Store only public product data
            const publicProductData = {
                item_code: product.code,
                item_name: product.name,
                item_pay: product.pay
            };
            orderForm.dataset.product = JSON.stringify(publicProductData);
        }

        // Close order modal
        function closeOrderModal() {
            orderModal.style.display = 'none';
            orderForm.reset();
        }

        // Handle order form submission
        async function handleOrderSubmit(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Đang gửi...';
                submitBtn.disabled = true;
                
                const formData = {
                    item_code: modalItemCode.value,
                    // FIX 3: Sửa tên trường để khớp với Backend
                    customer_name: document.getElementById('customerName').value.trim(), 
                    customer_email: document.getElementById('customerEmail').value.trim(),
                    // FIX 3: Sửa tên trường để khớp với Backend
                    customer_mobile: document.getElementById('customerPhone').value.trim(), 
                    customer_note: document.getElementById('customerNote').value.trim(),
                    action: 'submitOrder'
                };
                
                // Basic validation (sử dụng tên trường đã sửa)
                if (!formData.customer_name || !formData.customer_email || !formData.customer_mobile) {
                    throw new Error('Vui lòng điền đầy đủ thông tin bắt buộc');
                }
                
                // Submit to backend
                // FIX 1: Thêm mode: 'no-cors' để tránh lỗi CORS Preflight
                await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Rất quan trọng để Apps Script POST hoạt động
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                // FIX 1: Vì dùng 'no-cors', ta không thể đọc response. 
                // Nếu không có lỗi network, ta giả định thành công.
                alert('Đơn hàng của bạn đã được gửi thành công! Chúng tôi sẽ liên hệ với bạn trong thời gian sớm nhất.');
                closeOrderModal();
                orderForm.reset(); 
                
            } catch (error) {
                console.error('Error submitting order:', error);
                // Thay đổi thông báo lỗi vì lỗi ở đây chỉ là lỗi mạng, không phải lỗi logic từ BE
                alert(error.message || 'Có lỗi xảy ra khi gửi đơn hàng. Vui lòng kiểm tra lại kết nối mạng hoặc thử lại sau.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>