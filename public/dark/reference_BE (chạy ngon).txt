// GROK HTML riêng chạy rất ngon nhưng giao diện HTML xấu
function doGet(e) {
  // Trả JSON public data
  const data = getPublicPortfolioData();
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const postData = JSON.parse(e.postData.contents);
    const { item_code, customer_name, customer_email, customer_mobile } = postData;
    
    if (!item_code || !customer_name || !customer_email || !customer_mobile) {
      return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Missing required fields' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Append vào sheet Order (các trường public + default status)
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const orderSheet = ss.getSheetByName('Order');
    const orderTime = Math.floor(new Date().getTime() / (1000 * 60 * 60 * 24)) + 25569; // Excel serial
    
    orderSheet.appendRow([
      item_code, orderTime, customer_name, customer_email, customer_mobile,
      'Đã nhận đơn hàng', // status
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '' // internal blank
    ]);
    
    // Gửi email (lookup internal từ Portfolio)
    sendOrderEmail({ item_code, customer_name, customer_email, customer_mobile }, orderTime);
    
    return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Order submitted successfully' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('POST error:', error);
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getPublicPortfolioData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const portfolioSheet = ss.getSheetByName('Portfolio');
  const configsSheet = ss.getSheetByName('Configs');
  
  const defaultImgUrl = configsSheet.getRange('C2').getValue();
  
  const data = portfolioSheet.getDataRange().getValues();
  const subHeaders = data[1]; // ID columns
  const rows = data.slice(2);
  
  const colIndex = {
    cat_type: subHeaders.indexOf('cat_type'),
    cat_intro: subHeaders.indexOf('cat_intro'),
    item_group: subHeaders.indexOf('item_group'),
    item_code: subHeaders.indexOf('item_code'),
    valid: subHeaders.indexOf('valid'),
    item_img_url: subHeaders.indexOf('item_img_url'),
    item_name: subHeaders.indexOf('item_name'),
    item_validity: subHeaders.indexOf('item_validity'),
    item_price: subHeaders.indexOf('item_price'),
    item_tax: subHeaders.indexOf('item_tax'),
    item_pay: subHeaders.indexOf('item_pay'),
    item_common: subHeaders.indexOf('item_common'),
    item_url: subHeaders.indexOf('item_url')
  };
  
  // Lọc valid=TRUE, group theo cat_type (public only)
  const groupedData = {};
  rows.forEach(row => {
    const valid = row[colIndex.valid];
    if (valid === true || valid === 'TRUE') {
      const catType = row[colIndex.cat_type];
      if (!groupedData[catType]) {
        groupedData[catType] = { intro: row[colIndex.cat_intro], items: [] };
      }
      
      const imgUrl = row[colIndex.item_img_url] || defaultImgUrl;
      const features = [];
      for (let i = 1; i <= 10; i++) {
        const featCol = subHeaders.indexOf(`item_feature_0${i < 10 ? '0' + i : i}`);
        if (featCol !== -1 && row[featCol]) features.push(row[featCol]);
      }
      
      // Public item (no internal)
      const item = {
        code: row[colIndex.item_code],
        group: row[colIndex.item_group],
        name: row[colIndex.item_name],
        validity: row[colIndex.item_validity],
        price: row[colIndex.item_price],
        tax: row[colIndex.item_tax],
        pay: row[colIndex.item_pay],
        common: row[colIndex.item_common] === true || row[colIndex.item_common] === 'TRUE',
        features: features,
        url: row[colIndex.item_url] || '',
        imgUrl: imgUrl
      };
      
      groupedData[catType].items.push(item);
    }
  });
  
  return { portfolio: groupedData }; // Chỉ public
}

function sendOrderEmail(formData, orderTime) {
  // Lookup full item (including internal) từ sheet
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const portfolioSheet = ss.getSheetByName('Portfolio');
  const data = portfolioSheet.getDataRange().getValues();
  const subHeaders = data[1];
  const rows = data.slice(2);
  
  const internalCols = {
    order_feedback: subHeaders.indexOf('order_feedback'),
    item_to_list: subHeaders.indexOf('item_to_list'),
    item_cc_list: subHeaders.indexOf('item_cc_list')
  };
  
  let toList = '', ccList = '', sendToCustomer = false;
  rows.forEach(row => {
    if (row[subHeaders.indexOf('item_code')] === formData.item_code) {
      toList = row[internalCols.item_to_list] || '';
      ccList = row[internalCols.item_cc_list] || '';
      sendToCustomer = row[internalCols.order_feedback] === true || row[internalCols.order_feedback] === 'TRUE';
    }
  });
  
  if (!toList) return; // Skip nếu không có toList
  
  const subject = `Đơn hàng mới: ${formData.item_code} - ${formData.customer_name}`;
  const body = `
Kính gửi đội ngũ,

Có đơn hàng mới từ khách hàng:
- Tên khách: ${formData.customer_name}
- Email: ${formData.customer_email}
- SĐT: ${formData.customer_mobile}
- Sản phẩm: ${formData.item_code}
- Thời gian: ${new Date((orderTime - 25569) * 86400000).toLocaleString('vi-VN')}

Vui lòng xử lý.
Trân trọng,
Hệ thống LAZINET
  `;
  
  MailApp.sendEmail({ to: toList, cc: ccList, subject: subject, body: body });
  
  if (sendToCustomer) {
    const customerSubject = `Xác nhận đơn hàng: ${formData.item_code}`;
    const customerBody = `
Kính gửi ${formData.customer_name},

Cảm ơn bạn đã đặt hàng sản phẩm ${formData.item_code}.
Chúng tôi đã nhận đơn và sẽ liên hệ sớm.

Chi tiết:
- Tên: ${formData.customer_name}
- Email: ${formData.customer_email}
- SĐT: ${formData.customer_mobile}
- Thời gian: ${new Date((orderTime - 25569) * 86400000).toLocaleString('vi-VN')}

Trân trọng,
LAZINET
    `;
    
    MailApp.sendEmail({ to: formData.customer_email, subject: customerSubject, body: customerBody });
  }
}

// Remind function (giữ nguyên, chạy trigger)
function checkReminds() {
  // ... (code cũ, không thay đổi)
}

// Tạo trigger: Chạy trong Apps Script editor một lần
function createRemindTrigger() {
  ScriptApp.newTrigger('checkReminds').timeBased().everyDays(1).create();
}