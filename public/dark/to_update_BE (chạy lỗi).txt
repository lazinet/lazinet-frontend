// DEEPSEEK giao diá»‡n Ä‘áº¹p mÃ  Ä‘áº·t hÃ ng lá»—i
function doGet(e) {
  // Tráº£ JSON public data
  const data = getPublicPortfolioData();
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}

function doPost(e) {
  try {
    const postData = JSON.parse(e.postData.contents);
    const { item_code, customer_name, customer_email, customer_mobile, customer_note } = postData;
    
    if (!item_code || !customer_name || !customer_email || !customer_mobile) {
      return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Missing required fields' }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders({
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        });
    }
    
    // Append vÃ o sheet Order
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const orderSheet = ss.getSheetByName('Order');
    const orderTime = Math.floor(new Date().getTime() / (1000 * 60 * 60 * 24)) + 25569; // Excel serial
    
    orderSheet.appendRow([
      item_code, 
      orderTime, 
      customer_name, 
      customer_email, 
      customer_mobile,
      'ÄÃ£ nháº­n Ä‘Æ¡n hÃ ng', // status
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 
      customer_note || '' // notes
    ]);
    
    // Gá»­i email (lookup internal tá»« Portfolio)
    sendOrderEmail({ item_code, customer_name, customer_email, customer_mobile, customer_note }, orderTime);
    
    return ContentService.createTextOutput(JSON.stringify({ 
      success: true, 
      message: 'Order submitted successfully' 
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
    
  } catch (error) {
    console.error('POST error:', error);
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: error.toString() 
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
  }
}

function getPublicPortfolioData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const portfolioSheet = ss.getSheetByName('Portfolio');
  const configsSheet = ss.getSheetByName('Configs');
  
  const defaultImgUrl = configsSheet.getRange('C2').getValue();
  
  const data = portfolioSheet.getDataRange().getValues();
  const subHeaders = data[1]; // ID columns (dÃ²ng 2)
  const rows = data.slice(2); // Báº¯t Ä‘áº§u tá»« dÃ²ng 3
  
  const colIndex = {
    cat_type: subHeaders.indexOf('cat_type'),
    cat_intro: subHeaders.indexOf('cat_intro'),
    item_group: subHeaders.indexOf('item_group'),
    item_code: subHeaders.indexOf('item_code'),
    valid: subHeaders.indexOf('valid'),
    item_img_url: subHeaders.indexOf('item_img_url'),
    item_name: subHeaders.indexOf('item_name'),
    item_validity: subHeaders.indexOf('item_validity'),
    item_price: subHeaders.indexOf('item_price'),
    item_tax: subHeaders.indexOf('item_tax'),
    item_pay: subHeaders.indexOf('item_pay'),
    item_common: subHeaders.indexOf('item_common'),
    item_url: subHeaders.indexOf('item_url')
  };
  
  // Lá»c valid=TRUE, group theo cat_type (public only)
  const groupedData = {};
  rows.forEach(row => {
    const valid = row[colIndex.valid];
    if (valid === true || valid === 'TRUE') {
      const catType = row[colIndex.cat_type];
      if (!groupedData[catType]) {
        groupedData[catType] = { 
          intro: row[colIndex.cat_intro], 
          items: [] 
        };
      }
      
      const imgUrl = row[colIndex.item_img_url] || defaultImgUrl;
      const features = [];
      for (let i = 1; i <= 10; i++) {
        const featKey = `item_feature_${i.toString().padStart(2, '0')}`;
        const featCol = subHeaders.indexOf(featKey);
        if (featCol !== -1 && row[featCol]) {
          features.push(row[featCol]);
        }
      }
      
      // Public item (no internal)
      const item = {
        code: row[colIndex.item_code],
        group: row[colIndex.item_group],
        name: row[colIndex.item_name],
        validity: row[colIndex.item_validity],
        price: row[colIndex.item_price],
        tax: row[colIndex.item_tax],
        pay: row[colIndex.item_pay],
        common: row[colIndex.item_common] === true || row[colIndex.item_common] === 'TRUE',
        features: features,
        url: row[colIndex.item_url] || '',
        imgUrl: imgUrl
      };
      
      groupedData[catType].items.push(item);
    }
  });
  
  return { 
    success: true,
    portfolio: groupedData 
  };
}

function sendOrderEmail(formData, orderTime) {
  // Lookup full item (including internal) tá»« sheet
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const portfolioSheet = ss.getSheetByName('Portfolio');
  const data = portfolioSheet.getDataRange().getValues();
  const subHeaders = data[1];
  const rows = data.slice(2);
  
  const internalCols = {
    order_feedback: subHeaders.indexOf('order_feedback'),
    item_to_list: subHeaders.indexOf('item_to_list'),
    item_cc_list: subHeaders.indexOf('item_cc_list'),
    item_name: subHeaders.indexOf('item_name')
  };
  
  let toList = '', ccList = '', sendToCustomer = false, itemName = '';
  rows.forEach(row => {
    if (row[subHeaders.indexOf('item_code')] === formData.item_code) {
      toList = row[internalCols.item_to_list] || '';
      ccList = row[internalCols.item_cc_list] || '';
      sendToCustomer = row[internalCols.order_feedback] === true || row[internalCols.order_feedback] === 'TRUE';
      itemName = row[internalCols.item_name] || formData.item_code;
    }
  });
  
  if (!toList) return; // Skip náº¿u khÃ´ng cÃ³ toList
  
  const subject = `ğŸš€ ÄÆ N HÃ€NG Má»šI: ${itemName} - ${formData.customer_name}`;
  const body = `
THÃ”NG TIN ÄÆ N HÃ€NG Má»šI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“¦ Sáº¢N PHáº¨M: ${itemName}
ğŸ”¢ MÃƒ SP: ${formData.item_code}

ğŸ‘¤ THÃ”NG TIN KHÃCH HÃ€NG:
â€¢ Há» tÃªn: ${formData.customer_name}
â€¢ Email: ${formData.customer_email}
â€¢ SÄT: ${formData.customer_mobile}
${formData.customer_note ? `â€¢ Ghi chÃº: ${formData.customer_note}` : ''}

â° THá»œI GIAN: ${new Date((orderTime - 25569) * 86400000).toLocaleString('vi-VN')}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LAZINET - Há»‡ thá»‘ng tá»± Ä‘á»™ng
  `;
  
  MailApp.sendEmail({ 
    to: toList, 
    cc: ccList, 
    subject: subject, 
    body: body 
  });
  
  if (sendToCustomer) {
    const customerSubject = `âœ… XÃC NHáº¬N ÄÆ N HÃ€NG: ${itemName}`;
    const customerBody = `
KÃ­nh chÃ o ${formData.customer_name},

Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘áº·t hÃ ng ${itemName} táº¡i LAZINET.

âœ… CHÃšNG TÃ”I ÄÃƒ NHáº¬N ÄÆ¯á»¢C ÄÆ N HÃ€NG Cá»¦A Báº N

ThÃ´ng tin Ä‘Æ¡n hÃ ng:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Sáº£n pháº©m: ${itemName}
â€¢ MÃ£ Ä‘Æ¡n hÃ ng: ${formData.item_code}
â€¢ Thá»i gian Ä‘áº·t: ${new Date((orderTime - 25569) * 86400000).toLocaleString('vi-VN')}
â€¢ Tráº¡ng thÃ¡i: ÄÃ£ tiáº¿p nháº­n

Äá»™i ngÅ© LAZINET sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t Ä‘á»ƒ xÃ¡c nháº­n vÃ  triá»ƒn khai dá»‹ch vá»¥.

Má»i tháº¯c máº¯c xin vui lÃ²ng liÃªn há»‡:
ğŸ“ Hotline: 0827 000 248
ğŸ“§ Email: email@lazinet.com

TrÃ¢n trá»ng,
Äá»™i ngÅ© LAZINET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    `;
    
    MailApp.sendEmail({ 
      to: formData.customer_email, 
      subject: customerSubject, 
      body: customerBody 
    });
  }
}