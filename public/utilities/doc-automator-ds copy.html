<!DOCTYPE html>
<html lang="vi-VN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET Document Automation - Standalone Client</title>
    <style>
        /* [To√†n b·ªô CSS gi·ªØ nguy√™n - kh√¥ng thay ƒë·ªïi] */
        :root {
            --primary-color: #FFFFFF;
            --secondary-color: #FFFFFF0A;
            --orange-main: #ff5000;
            --blue-main: #3F82FB;
            --text-color: #FFFFFF;
            --accent-color: #3F82FB;
            --accent-secondary-color: #0F2453;
            --bg-color: #0F162C;
            --white-color: #FFFFFF;
            --divider-color: #FFFFFF1A;
            --error-color: rgb(230, 87, 87);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --info-color: #2196F3;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Geist', 'Open Sans', sans-serif;
        }
        /* ... [CSS c√≤n l·∫°i gi·ªØ nguy√™n ho√†n to√†n] ... */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- [Ph·∫ßn HTML c·∫•u tr√∫c gi·ªØ nguy√™n ho√†n to√†n] -->
    <div id="connectionStatus" class="connection-status status-connecting">
        <span id="connectionIcon">‚è≥</span>
        <span id="connectionText">ƒêang k·∫øt n·ªëi...</span>
    </div>
    <div class="logo-container">
        <a href="../index.html">
            <img src="../assets/img/logo-lazinet/lazinet_LogoFullv2_vi.png" alt="LAZINET Logo">
        </a>
    </div>
    <div class="container">
        <!-- [To√†n b·ªô c·∫•u tr√∫c HTML kh√°c gi·ªØ nguy√™n] -->
    </div>

    <script>
        // Configuration - S·ª¨A URL N√ÄY TH√ÄNH C·ª¶A B·∫†N
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbyd462zshna-KdhU5XPiDlUBLk1ReE4vjaqQzYCfQJIQ-KxMnZ4ZC6bNlDXG_Fs9nOi/exec'
        };

        // Global state
        let state = {
            connected: false,
            templates: [],
            excelData: null,
            headers: [],
            validation: null,
            results: null,
            isPreviewVisible: false
        };

        // ============================================
        // H√ÄM QUAN TR·ªåNG: G·ª≠i request d·∫°ng Form Data
        // ============================================
        async function sendRequest(action, data = {}) {
            const formData = new URLSearchParams();
            formData.append('action', action);
            
            // Th√™m t·∫•t c·∫£ d·ªØ li·ªáu kh√°c v√†o formData
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'object') {
                    formData.append(key, JSON.stringify(data[key]));
                } else {
                    formData.append(key, data[key]);
                }
            });
            
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            });
            
            return await response.json();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            testConnection();
            setupDragAndDrop();
        });

        // Test connection automatically - ƒê√É S·ª¨A
        async function testConnection() {
            updateConnectionStatus('connecting', '‚è≥', 'ƒêang k·∫øt n·ªëi...');
            
            try {
                // GET request ƒë∆°n gi·∫£n cho test
                const response = await fetch(`${CONFIG.API_URL}?action=test&t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.success || result.status === 'ok') {
                    state.connected = true;
                    updateConnectionStatus('connected', '‚úÖ', 'ƒê√£ k·∫øt n·ªëi');
                    // T·∫£i templates ngay sau khi k·∫øt n·ªëi
                    loadTemplates();
                } else {
                    throw new Error(result.error || 'K·∫øt n·ªëi th·∫•t b·∫°i');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                state.connected = false;
                updateConnectionStatus('disconnected', '‚ùå', 'M·∫•t k·∫øt n·ªëi');
                setTimeout(testConnection, 5000);
            }
        }

        // Update connection status display
        function updateConnectionStatus(status, icon, text) {
            const statusDiv = document.getElementById('connectionStatus');
            const iconSpan = document.getElementById('connectionIcon');
            const textSpan = document.getElementById('connectionText');
            
            statusDiv.className = `connection-status status-${status}`;
            iconSpan.textContent = icon;
            textSpan.textContent = text;
        }

        // Setup drag and drop (gi·ªØ nguy√™n)
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // Handle file upload (gi·ªØ nguy√™n)
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showMessage('Vui l√≤ng ch·ªçn file Excel (.xlsx, .xls) ho·∫∑c CSV (.csv)', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showMessage('File Excel kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
                        return;
                    }

                    state.headers = jsonData[0];
                    state.excelData = jsonData.slice(1).map(row => {
                        const obj = {};
                        state.headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });

                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('fileInfoContent').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${file.name}</strong>
                                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                                    ${(file.size / 1024).toFixed(1)} KB ‚Ä¢ ${state.excelData.length} b·∫£n ghi ‚Ä¢ ${state.headers.length} c·ªôt
                                </div>
                            </div>
                            <span style="color: var(--error-color); cursor: pointer;" onclick="clearFile()">√ó</span>
                        </div>
                    `;

                    showMessage('‚úÖ ƒê√£ t·∫£i file Excel th√†nh c√¥ng', 'success');
                    
                } catch (error) {
                    showMessage(`L·ªói ƒë·ªçc file: ${error.message}`, 'error');
                }
            };

            reader.onerror = () => {
                showMessage('L·ªói ƒë·ªçc file', 'error');
            };

            reader.readAsArrayBuffer(file);
        }

        // Load templates - ƒê√É S·ª¨A: d√πng sendRequest
        async function loadTemplates() {
            if (!state.connected) {
                showMessage('ƒêang k·∫øt n·ªëi l·∫°i v·ªõi backend...', 'error');
                await testConnection();
                return;
            }

            const refreshIcon = document.getElementById('refreshIcon');
            const originalIcon = refreshIcon.textContent;
            refreshIcon.textContent = '‚è≥';

            try {
                // S·ª≠ d·ª•ng h√†m sendRequest m·ªõi
                const result = await sendRequest('getTemplates');
                
                if (result.success) {
                    state.templates = result.data || [];
                    renderTemplates();
                    showMessage('‚úÖ ƒê√£ t·∫£i l·∫°i danh s√°ch template', 'success');
                } else {
                    throw new Error(result.error || 'Failed to load templates');
                }
                
            } catch (error) {
                showMessage(`L·ªói t·∫£i template: ${error.message}`, 'error');
            } finally {
                refreshIcon.textContent = originalIcon;
            }
        }

        // Render templates (gi·ªØ nguy√™n)
        function renderTemplates() {
            const container = document.getElementById('templateList');
            
            if (!state.templates || state.templates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
                        <div>Kh√¥ng c√≥ template n√†o</div>
                    </div>
                `;
                return;
            }

            let html = '<table>';
            html += '<thead><tr><th>T√™n Template</th><th>S·ªë tr∆∞·ªùng</th><th>C√°c tr∆∞·ªùng</th></tr></thead>';
            html += '<tbody>';

            state.templates.forEach(template => {
                html += `
                    <tr>
                        <td>
                            <a href="${template.url}" target="_blank" class="link">${template.name}</a>
                        </td>
                        <td style="text-align: center;">${template.fields.length}</td>
                        <td>
                            ${template.fields.map(f => 
                                `<span class="template-field">{{${f}}}</span>`
                            ).join(' ')}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Validate data - ƒê√É S·ª¨A: d√πng sendRequest
        async function validateData() {
            if (!state.connected) {
                showMessage('M·∫•t k·∫øt n·ªëi v·ªõi backend', 'error');
                await testConnection();
                return;
            }

            if (!state.excelData) {
                showMessage('Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc', 'error');
                return;
            }

            const validateBtn = document.getElementById('validateBtn');
            const originalText = validateBtn.textContent;
            validateBtn.innerHTML = '<span class="spinner"></span>ƒêang ki·ªÉm tra...';
            validateBtn.disabled = true;

            try {
                // S·ª≠ d·ª•ng h√†m sendRequest m·ªõi
                const result = await sendRequest('validate', {
                    headers: state.headers,
                    data: state.excelData
                });
                
                if (result.success) {
                    state.validation = result.data;
                    showValidationResults();
                    
                    if (state.validation.summary.isValid) {
                        showMessage('‚úÖ T·∫•t c·∫£ d·ªØ li·ªáu h·ª£p l·ªá!', 'success');
                    } else {
                        showMessage(`‚ö†Ô∏è C√≥ ${state.validation.summary.error} l·ªói, ${state.validation.summary.warning} c·∫£nh b√°o`, 'warning');
                    }
                } else {
                    throw new Error(result.error || 'Validation failed');
                }
                
            } catch (error) {
                showMessage(`L·ªói ki·ªÉm tra: ${error.message}`, 'error');
            } finally {
                validateBtn.textContent = originalText;
                validateBtn.disabled = false;
            }
        }

        // Show validation results (gi·ªØ nguy√™n)
        function showValidationResults() {
            if (!state.validation) return;

            const container = document.getElementById('validationResults');
            const stats = state.validation.summary;

            let html = '<div class="stats-grid">';
            html += `<div class="stat-card">
                <div class="stat-value">${stats.total}</div>
                <div>T·ªïng s·ªë</div>
            </div>`;
            html += `<div class="stat-card" style="border-color: var(--success-color);">
                <div class="stat-value" style="color: var(--success-color);">${stats.ok}</div>
                <div>H·ª£p l·ªá</div>
            </div>`;
            html += `<div class="stat-card" style="border-color: var(--warning-color);">
                <div class="stat-value" style="color: var(--warning-color);">${stats.warning}</div>
                <div>C·∫£nh b√°o</div>
            </div>`;
            html += `<div class="stat-card" style="border-color: var(--error-color);">
                <div class="stat-value" style="color: var(--error-color);">${stats.error}</div>
                <div>L·ªói</div>
            </div>`;
            html += '</div>';

            if (state.validation.errors.length > 0) {
                html += `<div style="margin-top: 15px; padding: 15px; background: rgba(230, 87, 87, 0.1); border-radius: 10px; border: 1px solid var(--error-color);">
                    <strong>‚ö†Ô∏è L·ªói:</strong><br>
                    ${state.validation.errors.map(e => `‚Ä¢ ${e}`).join('<br>')}
                </div>`;
            }

            if (state.validation.warnings.length > 0) {
                html += `<div style="margin-top: 15px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 10px; border: 1px solid var(--warning-color);">
                    <strong>üìù C·∫£nh b√°o:</strong><br>
                    ${state.validation.warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}
                </div>`;
            }

            container.innerHTML = html;
        }

        // Process data - ƒê√É S·ª¨A: d√πng sendRequest
        async function processData() {
            if (!state.connected) {
                showMessage('M·∫•t k·∫øt n·ªëi v·ªõi backend.', 'error');
                return;
            }
            if (!state.excelData) {
                showMessage('Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc!', 'error');
                return;
            }
            
            if (state.validation && state.validation.summary.error > 0) {
                const userConfirmed = confirm(`‚ö†Ô∏è C√≥ ${state.validation.summary.error} l·ªói trong d·ªØ li·ªáu. Nh·ªØng d√≤ng l·ªói s·∫Ω ƒë∆∞·ª£c b·ªè qua.\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c x·ª≠ l√Ω kh√¥ng?`);
                if (!userConfirmed) {
                    return;
                }
            }

            const processBtn = document.getElementById('processBtn');
            processBtn.innerHTML = '<span class="spinner"></span>ƒêang x·ª≠ l√Ω...';
            processBtn.disabled = true;

            document.getElementById('processingPanel').classList.remove('hidden');
            document.getElementById('previewPanel').classList.add('hidden');

            try {
                // S·ª≠ d·ª•ng h√†m sendRequest m·ªõi
                const result = await sendRequest('process', {
                    data: state.excelData
                });
                
                if (result.success) {
                    state.results = result.data;
                    showResults();
                    showMessage('‚úÖ X·ª≠ l√Ω ho√†n th√†nh!', 'success');
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
            } catch (error) {
                showMessage(`L·ªói x·ª≠ l√Ω: ${error.message}`, 'error');
            } finally {
                processBtn.textContent = 'üöÄ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω';
                processBtn.disabled = false;
            }
        }

        // Show results (gi·ªØ nguy√™n)
        function showResults() {
            if (!state.results) return;

            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('currentProgress').textContent = state.results.summary.total;
            document.getElementById('totalProgress').textContent = state.results.summary.total;
            document.getElementById('progressPercent').textContent = '100%';

            document.getElementById('processingPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');

            const statsContainer = document.getElementById('resultsStats');
            const summary = state.results.summary;
            
            let statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${summary.total}</div>
                    <div>T·ªïng s·ªë</div>
                </div>
                <div class="stat-card" style="border-color: var(--success-color);">
                    <div class="stat-value" style="color: var(--success-color);">${summary.success}</div>
                    <div>Th√†nh c√¥ng</div>
                </div>
                <div class="stat-card" style="border-color: var(--error-color);">
                    <div class="stat-value" style="color: var(--error-color);">${summary.error}</div>
                    <div>L·ªói</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Date().toLocaleTimeString('vi-VN')}</div>
                    <div>Th·ªùi gian</div>
                </div>
            `;
            statsContainer.innerHTML = statsHtml;

            const tableContainer = document.getElementById('resultsTable');
            let tableHtml = '<table>';
            tableHtml += '<thead><tr><th>STT</th><th>File ID</th><th>Template</th><th>Tr·∫°ng th√°i</th><th>T·∫£i v·ªÅ</th></tr></thead>';
            tableHtml += '<tbody>';

            state.results.results.forEach((result, index) => {
                const statusClass = result.status === 'OK' ? 'status-ok' : 'status-error';
                const downloadLink = result.downloadUrl ? 
                    `<a href="${result.downloadUrl}" target="_blank" class="link">üìÑ ${result.status === 'OK' ? 'PDF/Doc' : 'N/A'}</a>` :
                    'N/A';

                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${result.fileId}</td>
                        <td>${result.template}</td>
                        <td class="${statusClass}">${result.status}</td>
                        <td>${downloadLink}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
        }

        // Download template - ƒê√É S·ª¨A
        async function downloadTemplate() {
            if (!state.connected) {
                showMessage('M·∫•t k·∫øt n·ªëi v·ªõi backend', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getTemplateExcel&t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.success && result.data.url) {
                    window.open(result.data.url, '_blank');
                } else {
                    throw new Error(result.error || 'Kh√¥ng th·ªÉ t·∫£i m·∫´u');
                }
            } catch (error) {
                showMessage(`L·ªói t·∫£i m·∫´u: ${error.message}`, 'error');
            }
        }

        // Download results (gi·ªØ nguy√™n)
        function downloadResults() {
            if (!state.results) {
                showMessage('Kh√¥ng c√≥ k·∫øt qu·∫£ ƒë·ªÉ t·∫£i', 'error');
                return;
            }

            try {
                const resultsData = [
                    ['STT', 'File ID', 'Template', 'Tr·∫°ng th√°i', 'Th√¥ng b√°o', 'URL Document', 'URL PDF']
                ];

                state.results.results.forEach((result, index) => {
                    resultsData.push([
                        index + 1,
                        result.fileId,
                        result.template,
                        result.status,
                        result.message,
                        result.docUrl || '',
                        result.pdfUrl || ''
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(resultsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£');

                XLSX.writeFile(wb, `LAZINET_Results_${new Date().getTime()}.xlsx`);
            } catch (error) {
                showMessage(`L·ªói t·∫£i k·∫øt qu·∫£: ${error.message}`, 'error');
            }
        }

        // Toggle preview (gi·ªØ nguy√™n)
        function togglePreview() {
            if (!state.excelData) return;

            const previewPanel = document.getElementById('previewPanel');
            const previewBtn = document.getElementById('previewBtn');

            if (state.isPreviewVisible) {
                previewPanel.classList.add('hidden');
                previewBtn.textContent = 'üëÅÔ∏è Xem tr∆∞·ªõc';
            } else {
                previewPanel.classList.remove('hidden');
                previewBtn.textContent = 'üëÅÔ∏è ·∫®n tr∆∞·ªõc';
                
                const previewContainer = document.getElementById('dataPreview');
                let html = '<table>';
                html += '<thead><tr>';
                state.headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead>';
                html += '<tbody>';

                const previewRows = Math.min(5, state.excelData.length);
                for (let i = 0; i < previewRows; i++) {
                    html += '<tr>';
                    state.headers.forEach(header => {
                        html += `<td>${state.excelData[i][header] || ''}</td>`;
                    });
                    html += '</tr>';
                }
                html += '</tbody></table>';

                if (state.excelData.length > 5) {
                    html += `<div style="text-align: center; padding: 10px; opacity: 0.7;">
                        ... v√† ${state.excelData.length - 5} h√†ng kh√°c
                    </div>`;
                }

                previewContainer.innerHTML = html;
            }

            state.isPreviewVisible = !state.isPreviewVisible;
        }

        // Clear file (gi·ªØ nguy√™n)
        function clearFile() {
            state.excelData = null;
            state.validation = null;
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('previewPanel').classList.add('hidden');
            state.isPreviewVisible = false;
        }

        // Reset all (gi·ªØ nguy√™n)
        function resetAll() {
            state.excelData = null;
            state.validation = null;
            state.results = null;
            
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('previewPanel').classList.add('hidden');
            document.getElementById('processingPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.add('hidden');
            
            document.getElementById('fileInput').value = '';
            
            state.isPreviewVisible = false;
            
            showMessage('ƒê√£ l√†m m·ªõi', 'success');
        }

        // Helper: Show message (gi·ªØ nguy√™n)
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            const color = type === 'success' ? 'var(--success-color)' : 
                         type === 'error' ? 'var(--error-color)' : 
                         type === 'warning' ? 'var(--warning-color)' : 'var(--info-color)';
            
            messageDiv.innerHTML = `<div style="position: fixed; bottom: 20px; right: 20px; color: ${color}; padding: 10px 20px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid ${color}; z-index: 1000;">${message}</div>`;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>