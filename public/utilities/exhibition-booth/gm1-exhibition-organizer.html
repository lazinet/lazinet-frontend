<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Organizer Portal - LAZINET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 font-sans">
    <div id="lock" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="w-96 p-8 border rounded-3xl shadow-xl text-center">
            <img src="https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png" class="w-16 mx-auto mb-4">
            <h2 class="text-xl font-black mb-6">ADMIN LOGIN</h2>
            <input type="password" id="pass" class="w-full border p-4 rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Mật khẩu Config B4">
            <button onclick="access()" class="w-full bg-black text-white py-4 rounded-2xl font-bold">XÁC MINH</button>
        </div>
    </div>

    <div id="app" class="hidden min-h-screen pb-20">
        <nav class="bg-white p-4 border-b sticky top-0 z-50 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <img id="org-logo" class="h-10">
                <span class="font-black text-lg tracking-tighter">ORGANIZER CONTROL</span>
            </div>
            <button onclick="saveAll()" class="bg-blue-600 text-white px-8 py-2 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">LƯU CẬU HÌNH</button>
        </nav>

        <div class="max-w-[1600px] mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-8">
            <aside class="space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                    <h3 class="font-bold text-slate-400 text-xs mb-4 uppercase">Thông số không gian</h3>
                    <div class="space-y-4">
                        <div><label class="text-[10px] font-bold">RỘNG (CM)</label><input id="w" type="number" class="w-full border-b py-2 outline-none"></div>
                        <div><label class="text-[10px] font-bold">CAO (CM)</label><input id="h" type="number" class="w-full border-b py-2 outline-none"></div>
                        <div><label class="text-[10px] font-bold">RATIO (PX/CM)</label><input id="ratio" type="number" class="w-full border-b py-2 outline-none"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                    <h3 class="font-bold text-slate-400 text-xs mb-4 uppercase">Thông tin sự kiện</h3>
                    <div class="space-y-4">
                        <input id="title" class="w-full border-b py-2 text-sm" placeholder="Tên triển lãm">
                        <input id="loc" class="w-full border-b py-2 text-sm" placeholder="Địa điểm">
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-8">
                <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <span class="font-bold">MẶT BẰNG THIẾT KẾ</span>
                        <div class="flex gap-2 text-xs">
                            <span class="flex items-center gap-1"><i class="w-3 h-3 bg-white border"></i> Trống</span>
                            <span class="flex items-center gap-1"><i class="w-3 h-3 bg-yellow-400"></i> Giữ chỗ</span>
                            <span class="flex items-center gap-1"><i class="w-3 h-3 bg-green-500"></i> Đã chốt</span>
                        </div>
                    </div>
                    <div class="relative bg-slate-200 overflow-auto" style="height: 600px;">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="p-4">BOOTH ID</th>
                                <th class="p-4">X,Y</th>
                                <th class="p-4">HẠNG</th>
                                <th class="p-4">GIÁ (VAT)</th>
                                <th class="p-4">TRẠNG THÁI</th>
                            </tr>
                        </thead>
                        <tbody id="booth-table"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbz5FsEf2ju5erOpeWGOAL5QvC8Mk4uh1yHgY8-Kf51CUWH0qmB4S8pAxOgzV7dHHLqMIQ/exec";
        let state = { data: null, pass: "" };

        async function access() {
            state.pass = document.getElementById('pass').value;
            const res = await fetch(API, {method:'POST', body: JSON.stringify({action:'checkPass', pass: state.pass})}).then(r=>r.json());
            if(res.valid) {
                document.getElementById('lock').remove();
                document.getElementById('app').classList.remove('hidden');
                load();
            } else Swal.fire('Sai mật khẩu!', 'Vui lòng kiểm tra Config B4', 'error');
        }

        async function load() {
            const res = await fetch(API, {method:'POST', body: JSON.stringify({action:'getInitData'})}).then(r=>r.json());
            state.data = res;
            document.getElementById('org-logo').src = res.organizer.logo;
            document.getElementById('w').value = res.organizer.width;
            document.getElementById('h').value = res.organizer.height;
            document.getElementById('ratio').value = res.organizer.ratio;
            document.getElementById('title').value = res.organizer.title;
            document.getElementById('loc').value = res.organizer.location;
            
            renderTable();
            drawMap();
        }

        function renderTable() {
            document.getElementById('booth-table').innerHTML = state.data.booths.map(b => `
                <tr class="border-t hover:bg-slate-50 transition">
                    <td class="p-4 font-bold text-blue-600">${b['Booth ID']}</td>
                    <td class="p-4">${b.X}, ${b.Y}</td>
                    <td class="p-4 font-bold">${b['Hạng']}</td>
                    <td class="p-4 text-emerald-600 font-bold">${Number(b['Giá gồm thuế (VAT 10%)']).toLocaleString()}</td>
                    <td class="p-4">
                        <select onchange="updateStatus('${b['Booth ID']}', this.value)" class="bg-white border rounded px-2 py-1">
                            <option value="Available" ${b['Trạng thái']=='Available'?'selected':''}>Available</option>
                            <option value="Booked" ${b['Trạng thái']=='Booked'?'selected':''}>Booked</option>
                            <option value="Occupied" ${b['Trạng thái']=='Occupied'?'selected':''}>Occupied</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function drawMap() {
            const c = document.getElementById('canvas');
            const ctx = c.getContext('2d');
            const o = state.data.organizer;
            const r = o.ratio;
            c.width = o.width * r;
            c.height = o.height * r;

            ctx.fillStyle = 'white';
            ctx.fillRect(0,0, c.width, c.height);

            state.data.booths.forEach(b => {
                ctx.strokeStyle = '#cbd5e1';
                ctx.lineWidth = 2;
                if(b['Trạng thái'] === 'Occupied') ctx.fillStyle = '#22c55e';
                else if(b['Trạng thái'] === 'Booked') ctx.fillStyle = '#facc15';
                else ctx.fillStyle = 'white';

                ctx.strokeRect(b.X*r, b.Y*r, b.Width*r, b.Height*r);
                ctx.fillRect(b.X*r, b.Y*r, b.Width*r, b.Height*r);

                ctx.fillStyle = '#334155';
                ctx.font = `bold ${12*r/20}px Arial`;
                ctx.fillText(b['Booth ID'], b.X*r + 5, b.Y*r + 15);
            });
        }

        async function saveAll() {
            const payload = {
                title: document.getElementById('title').value,
                location: document.getElementById('loc').value,
                width: document.getElementById('w').value,
                height: document.getElementById('h').value,
                ratio: document.getElementById('ratio').value
            };
            await fetch(API, {method:'POST', body: JSON.stringify({action:'saveOrganizer', payload, pass: state.pass})});
            Swal.fire('Đã lưu!', 'Dữ liệu Organizer đã được ghi đè.', 'success');
        }
    </script>
</body>
</html>