<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sơ đồ Triển lãm Trực tuyến - LAZINET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; background: #f1f5f9; }
        
        /* Navbar Glassmorphism */
        nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* Viewport cho Canvas */
        #viewport { width: 100vw; height: calc(100vh - 80px); cursor: grab; touch-action: none; position: relative; }
        #viewport:active { cursor: grabbing; }

        /* Chatbot Style */
        .chat-win { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom right; }
        .chat-hidden { transform: scale(0) translateY(100px); opacity: 0; pointer-events: none; }
        
        .typing-dot { width: 4px; height: 4px; background: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body>

    <nav class="h-20 px-6 md:px-10 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <img id="ui-logo" class="h-10 w-10 object-contain rounded-xl bg-slate-50 p-1 border">
            <div class="leading-tight">
                <h1 id="ui-title" class="font-black text-slate-900 text-lg md:text-xl tracking-tighter uppercase italic">Đang tải...</h1>
                <p id="ui-loc-info" class="text-[10px] font-bold text-blue-600 tracking-widest"></p>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="hidden lg:flex gap-5 text-[10px] font-black uppercase tracking-widest text-slate-400">
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-white border border-slate-300 rounded-sm"></i> Trống</span>
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-yellow-400 rounded-sm"></i> Giữ chỗ</span>
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-emerald-500 rounded-sm"></i> Đã chốt</span>
            </div>
            <button onclick="resetCamera()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-[10px] font-black hover:bg-slate-800 transition active:scale-95 shadow-lg shadow-slate-200 uppercase">
                Reset View
            </button>
        </div>
    </nav>

    <div id="viewport">
        <canvas id="map-canvas"></canvas>
    </div>

    <div class="fixed bottom-6 right-6 z-[60] flex flex-col items-end gap-4">
        <div id="chat-win" class="chat-win chat-hidden w-[350px] h-[550px] bg-white rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden border border-slate-100">
            <div id="chat-header" class="p-6 flex items-center justify-between text-white">
                <div class="flex items-center gap-3">
                    <img id="bot-logo" class="w-10 h-10 rounded-full border-2 border-white/30 bg-white">
                    <div>
                        <p id="bot-name" class="font-black text-sm tracking-tight"></p>
                        <p class="text-[9px] font-medium opacity-80 uppercase tracking-widest">Assistant Online</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="hover:bg-black/10 w-8 h-8 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="chat-body" class="flex-1 p-5 overflow-y-auto space-y-4 bg-slate-50/50 custom-scrollbar">
                <div class="flex justify-start">
                    <div class="bg-white border border-slate-100 p-4 rounded-2xl rounded-tl-none text-sm text-slate-700 shadow-sm max-w-[85%]">
                        Xin chào! Tôi có thể giúp bạn tìm gian hàng hoặc thông tin sự kiện này không?
                    </div>
                </div>
            </div>

            <div id="ai-typing" class="hidden px-6 py-2 flex items-center gap-2">
                <span id="ai-waiting-msg" class="text-[9px] font-black text-slate-400 uppercase"></span>
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
            </div>

            <div class="p-4 bg-white border-t flex gap-2">
                <input id="chat-inp" type="text" class="flex-1 bg-slate-100 border-none p-4 rounded-2xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Hỏi AI về gian hàng...">
                <button onclick="sendChat()" id="btn-send" class="w-12 h-12 rounded-2xl text-white shadow-lg flex items-center justify-center transition active:scale-90">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <button id="chat-toggle-btn" onclick="toggleChat()" class="w-16 h-16 rounded-full shadow-2xl text-white text-2xl flex items-center justify-center hover:scale-110 transition active:scale-95">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwp5KujatRHegAw84kfI2XYgdjDCUP9UHQ3DnVR_z-OL8UZMwgWqvNitcDovFWVZxXLLA/exec";
        let app = null;
        let canvas, ctx;
        let camera = { x: 0, y: 0, zoom: 1 };
        let isDragging = false;
        let lastPos = { x: 0, y: 0 };

        window.onload = async () => {
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getInitData' }) }).then(r => r.json());
                app = res;
                setupUI();
                initMap();
                animate();
            } catch (e) {
                Swal.fire('Lỗi', 'Không thể kết nối máy chủ dữ liệu.', 'error');
            }
        };

        function setupUI() {
            document.getElementById('ui-title').innerText = app.organizer.title;
            document.getElementById('ui-loc-info').innerText = `${app.organizer.location} | ${app.organizer.address}`;
            document.getElementById('ui-logo').src = app.organizer.logo;

            // Chatbot UI Config
            const cfg = app.configs;
            document.getElementById('bot-name').innerText = cfg.botName;
            document.getElementById('bot-logo').src = cfg.botLogo;
            document.getElementById('ai-waiting-msg').innerText = cfg.waitingMsg;
            document.getElementById('chat-header').style.background = `linear-gradient(135deg, ${cfg.themeColor1}, ${cfg.themeColor2})`;
            document.getElementById('btn-send').style.backgroundColor = cfg.themeColor1;
            document.getElementById('chat-toggle-btn').style.backgroundColor = cfg.themeColor1;
        }

        function initMap() {
            canvas = document.getElementById('map-canvas');
            ctx = canvas.getContext('2d');
            window.addEventListener('resize', resize);
            resize();
            resetCamera();

            // Mouse Events
            canvas.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', endDrag);
            canvas.addEventListener('wheel', handleWheel);

            // Touch Events (Mobile)
            canvas.addEventListener('touchstart', e => startDrag(e.touches[0]));
            canvas.addEventListener('touchmove', e => drag(e.touches[0]));
            canvas.addEventListener('touchend', endDrag);

            // Click to interact
            canvas.addEventListener('click', handleMapClick);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 80;
        }

        function resetCamera() {
            const r = app.organizer.ratio;
            const mapW = app.organizer.width * r;
            const mapH = app.organizer.height * r;
            camera.zoom = Math.min(canvas.width / mapW, canvas.height / mapH) * 0.8;
            camera.x = (canvas.width - mapW * camera.zoom) / 2;
            camera.y = (canvas.height - mapH * camera.zoom) / 2;
        }

        function startDrag(e) { isDragging = true; lastPos = { x: e.clientX, y: e.clientY }; }
        function endDrag() { isDragging = false; }
        function drag(e) {
            if (!isDragging) return;
            camera.x += (e.clientX - lastPos.x);
            camera.y += (e.clientY - lastPos.y);
            lastPos = { x: e.clientX, y: e.clientY };
        }

        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const mouseX = e.clientX;
            const mouseY = e.clientY - 80;
            camera.x = mouseX - (mouseX - camera.x) * delta;
            camera.y = mouseY - (mouseY - camera.y) * delta;
            camera.zoom *= delta;
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(camera.x, camera.y);
            ctx.scale(camera.zoom, camera.zoom);

            const r = app.organizer.ratio;
            
            // Vẽ nền Map
            ctx.fillStyle = 'white';
            ctx.shadowColor = 'rgba(0,0,0,0.1)';
            ctx.shadowBlur = 30 / camera.zoom;
            ctx.fillRect(0, 0, app.organizer.width * r, app.organizer.height * r);
            ctx.shadowBlur = 0;

            // Vẽ Booths
            app.booths.forEach(b => {
                const bx = b.X * r, by = b.Y * r, bw = b.Width * r, bh = b.Height * r;
                
                ctx.beginPath();
                ctx.roundRect(bx, by, bw, bh, (b.Radius || 0) * r);
                
                // Màu sắc theo trạng thái
                if (b['Trạng thái'] === 'Occupied') ctx.fillStyle = '#10b981';
                else if (b['Trạng thái'] === 'Booked') ctx.fillStyle = '#fbbf24';
                else ctx.fillStyle = '#ffffff';
                
                ctx.fill();
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1 / camera.zoom;
                ctx.stroke();

                // Chữ Booth ID
                ctx.fillStyle = b['Trạng thái'] === 'Available' ? '#94a3b8' : '#ffffff';
                ctx.font = `bold ${10}px Inter`;
                ctx.fillText(b['Booth ID'], bx + 4, by + 12);
            });

            ctx.restore();
            requestAnimationFrame(animate);
        }

        function handleMapClick(e) {
            if (isDragging) return;
            const r = app.organizer.ratio;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - camera.x) / camera.zoom;
            const my = (e.clientY - rect.top - camera.y) / camera.zoom;

            const b = app.booths.find(b => {
                return mx >= b.X * r && mx <= (b.X + b.Width) * r && my >= b.Y * r && my <= (b.Y + b.Height) * r;
            });

            if (b) openBookingModal(b);
        }

        function openBookingModal(b) {
            if (b['Trạng thái'] !== 'Available') {
                return Swal.fire({ title: `Booth ${b['Booth ID']}`, text: 'Gian hàng này đã được đặt chỗ.', icon: 'info' });
            }

            Swal.fire({
                title: `<span class="font-black text-xl uppercase italic">Đăng ký Booth ${b['Booth ID']}</span>`,
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-blue-50 p-5 rounded-[2rem] flex items-center gap-4 border border-blue-100">
                            <img src="${b['Link QR thanh toán']}" class="w-24 h-24 rounded-2xl bg-white p-1 shadow-sm">
                            <div>
                                <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">${b['Hạng']}</p>
                                <p class="text-xl font-black text-slate-800">${parseInt(b['Giá gồm thuế (VAT 10%)']).toLocaleString()} VND</p>
                                <p class="text-[9px] text-slate-400 font-medium">Quét mã để thanh toán giữ chỗ</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <input id="sw-comp" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tên công ty *">
                            <input id="sw-name" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Người đại diện *">
                            <input id="sw-phone" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Số điện thoại *">
                        </div>
                    </div>
                `,
                confirmButtonText: 'GỬI ĐĂNG KÝ NGAY',
                confirmButtonColor: app.configs.themeColor1,
                preConfirm: () => {
                    const comp = document.getElementById('sw-comp').value;
                    const name = document.getElementById('sw-name').value;
                    const phone = document.getElementById('sw-phone').value;
                    if(!comp || !name || !phone) return Swal.showValidationMessage('Vui lòng nhập đủ thông tin *');
                    return { compShort: comp, name, phone };
                }
            }).then(async (res) => {
                if (res.isConfirmed) {
                    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
                    const result = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'bookBooth', boothId: b['Booth ID'], info: res.value }) }).then(r => r.json());
                    if (result.success) Swal.fire('Thành công', result.message, 'success').then(() => location.reload());
                    else Swal.fire('Lỗi', result.message, 'error');
                }
            });
        }

        // --- Chatbot Logic ---
        function toggleChat() {
            document.getElementById('chat-win').classList.toggle('chat-hidden');
        }

        async function sendChat() {
            const inp = document.getElementById('chat-inp');
            const msg = inp.value.trim();
            if(!msg) return;

            const body = document.getElementById('chat-body');
            body.innerHTML += `<div class="flex justify-end"><div class="bg-blue-600 text-white p-4 rounded-3xl rounded-tr-none text-sm shadow-md max-w-[80%]">${msg}</div></div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;

            document.getElementById('ai-typing').classList.remove('hidden');
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'chatAI', message: msg }) }).then(r => r.json());
            document.getElementById('ai-typing').classList.add('hidden');
            
            body.innerHTML += `<div class="flex justify-start"><div class="bg-white border border-slate-100 p-4 rounded-3xl rounded-tl-none text-sm text-slate-700 shadow-sm max-w-[80%]">${res.answer}</div></div>`;
            body.scrollTop = body.scrollHeight;
        }
    </script>
</body>
</html>