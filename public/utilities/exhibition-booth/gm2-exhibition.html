<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sơ đồ Triển lãm Trực tuyến - LAZINET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; background: #e2e8f0; }
        #viewport { width: 100vw; height: 100vh; cursor: grab; touch-action: none; }
        #viewport:active { cursor: grabbing; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .chat-shadow { box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
        
        /* Animation cho Chatbot */
        .typing-dot { width: 4px; height: 4px; background: #64748b; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body>

    <div class="fixed top-6 left-6 z-10 pointer-events-none max-w-[90%] md:max-w-md">
        <div class="glass-panel p-6 rounded-[2.5rem] shadow-2xl pointer-events-auto">
            <h1 id="ui-title" class="text-2xl md:text-3xl font-black text-slate-900 leading-tight uppercase tracking-tighter italic">Đang tải...</h1>
            <div id="ui-loc-box" class="mt-3 flex items-start gap-2">
                <i class="fas fa-map-marker-alt text-red-500 mt-1"></i>
                <div>
                    <p id="ui-loc" class="text-xs font-bold text-slate-700"></p>
                    <p id="ui-addr" class="text-[10px] text-slate-500 leading-relaxed"></p>
                </div>
            </div>
            <div class="mt-6 flex gap-4 text-[10px] font-black uppercase tracking-widest border-t pt-4 border-slate-200">
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-white border border-slate-300 rounded-sm"></i> Trống</span>
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-yellow-400 rounded-sm"></i> Giữ chỗ</span>
                <span class="flex items-center gap-2"><i class="w-3 h-3 bg-emerald-500 rounded-sm"></i> Đã chốt</span>
            </div>
        </div>
    </div>

    <div id="viewport">
        <canvas id="map-canvas"></canvas>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
        <div id="chat-win" class="hidden w-[350px] h-[550px] glass-panel rounded-[2.5rem] chat-shadow flex flex-col overflow-hidden transition-all duration-500 transform translate-y-4 opacity-0 translate-y-0 opacity-100">
            <div id="chat-header" class="p-5 flex items-center justify-between text-white">
                <div class="flex items-center gap-3">
                    <img id="bot-logo" class="w-10 h-10 rounded-full border-2 border-white/50 bg-white">
                    <div>
                        <p id="bot-name" class="font-black text-sm tracking-tight"></p>
                        <p class="text-[9px] font-medium opacity-80 uppercase tracking-widest">Hỗ trợ trực tuyến 24/7</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="hover:rotate-90 transition-transform"><i class="fas fa-times"></i></button>
            </div>
            <div id="chat-body" class="flex-1 p-5 overflow-y-auto space-y-4 scroll-smooth">
                <div class="bg-white/50 p-4 rounded-2xl rounded-tl-none border border-slate-100 text-sm text-slate-700 shadow-sm">
                    Xin chào! Tôi là trợ lý AI. Bạn cần tìm hiểu thông tin về gian hàng nào không?
                </div>
            </div>
            <div id="ai-loading" class="hidden px-5 py-2 flex gap-1 items-center">
                <span id="ai-waiting-text" class="text-[10px] font-bold text-slate-400 mr-2 uppercase"></span>
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
            </div>
            <div class="p-4 bg-white/50 border-t border-slate-100 flex gap-2">
                <input id="chat-inp" type="text" class="flex-1 bg-white border-none p-3 rounded-2xl text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-inner" placeholder="Nhập câu hỏi...">
                <button onclick="sendChat()" id="btn-send" class="w-12 h-12 rounded-2xl text-white shadow-lg transition-transform active:scale-90 flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <button id="chat-toggle-btn" onclick="toggleChat()" class="w-16 h-16 rounded-full shadow-2xl text-white text-2xl flex items-center justify-center hover:scale-110 transition active:scale-95 chat-shadow">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwrTMBEFZqszW4uobt5ZTA7lYRRcwGPJy0Obu-Xl8TerS1bvRk6exL5I1fRJ9hvUwFZkw/exec";
        let app = null;
        let canvas, ctx;
        let transform = { x: 0, y: 0, k: 1 };
        let isDrag = false, lastMouse = { x: 0, y: 0 };

        window.onload = async () => {
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getInitData' }) }).then(r => r.json());
                app = res;
                setupUI();
                initCanvas();
                loop();
            } catch (e) {
                Swal.fire('Lỗi', 'Không thể tải dữ liệu sự kiện', 'error');
            }
        };

        function setupUI() {
            document.getElementById('ui-title').innerText = app.organizer.event.title;
            document.getElementById('ui-loc').innerText = app.organizer.event.location;
            document.getElementById('ui-addr').innerText = app.organizer.event.address;
            
            // Setup Bot
            const cfg = app.configs;
            document.getElementById('bot-name').innerText = cfg.botName;
            document.getElementById('bot-logo').src = cfg.botLogo;
            document.getElementById('ai-waiting-text').innerText = cfg.waitingMsg;
            document.getElementById('chat-header').style.background = `linear-gradient(135deg, ${cfg.themeColor1}, ${cfg.themeColor2})`;
            document.getElementById('btn-send').style.backgroundColor = cfg.themeColor1;
            document.getElementById('chat-toggle-btn').style.backgroundColor = cfg.themeColor1;
        }

        function initCanvas() {
            canvas = document.getElementById('map-canvas');
            ctx = canvas.getContext('2d');
            window.onresize = resize;
            resize();
            resetView();

            // Mouse & Touch Events
            canvas.onmousedown = e => { isDrag = true; lastMouse = { x: e.clientX, y: e.clientY }; };
            window.onmousemove = e => {
                if (!isDrag) return;
                transform.x += (e.clientX - lastMouse.x);
                transform.y += (e.clientY - lastMouse.y);
                lastMouse = { x: e.clientX, y: e.clientY };
            };
            window.onmouseup = () => isDrag = false;
            canvas.onwheel = e => {
                const zoom = e.deltaY > 0 ? 0.9 : 1.1;
                applyZoom(zoom, e.clientX, e.clientY);
            };

            // Click to Book
            canvas.onclick = e => {
                if (isDrag && Math.abs(e.clientX - lastMouse.x) > 5) return;
                const rect = canvas.getBoundingClientRect();
                const mx = (e.clientX - rect.left - transform.x) / transform.k;
                const my = (e.clientY - rect.top - transform.y) / transform.k;
                const r = app.organizer.event.ratio;

                const clickedBooth = app.booths.find(b => {
                    const bx = b.X * r, by = b.Y * r, bw = b.Width * r, bh = b.Height * r;
                    return mx >= bx && mx <= bx + bw && my >= by && my <= by + bh;
                });
                if (clickedBooth) openBooking(clickedBooth);
            };
        }

        function applyZoom(s, cx, cy) {
            transform.x = cx - (cx - transform.x) * s;
            transform.y = cy - (cy - transform.y) * s;
            transform.k *= s;
        }

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

        function resetView() {
            const o = app.organizer.event;
            const r = o.ratio;
            transform.k = Math.min(canvas.width / (o.width * r), canvas.height / (o.height * r)) * 0.8;
            transform.x = (canvas.width - o.width * r * transform.k) / 2;
            transform.y = (canvas.height - o.height * r * transform.k) / 2;
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);

            const r = app.organizer.event.ratio;
            const o = app.organizer.event;

            // Nền triển lãm
            ctx.fillStyle = 'white';
            ctx.shadowColor = 'rgba(0,0,0,0.1)';
            ctx.shadowBlur = 50 / transform.k;
            ctx.fillRect(0, 0, o.width * r, o.height * r);
            ctx.shadowBlur = 0;

            // Vẽ Booths
            app.booths.forEach(b => {
                const bx = b.X * r, by = b.Y * r, bw = b.Width * r, bh = b.Height * r, br = (b.Radius || 0) * r;
                
                ctx.beginPath();
                ctx.roundRect(bx, by, bw, bh, br);
                ctx.strokeStyle = '#cbd5e1';
                ctx.lineWidth = 1 / transform.k;
                ctx.stroke();

                if (b['Trạng thái'] === 'Occupied') ctx.fillStyle = '#10b981';
                else if (b['Trạng thái'] === 'Booked') ctx.fillStyle = '#fbbf24';
                else ctx.fillStyle = '#ffffff';
                ctx.fill();

                // Số Booth
                ctx.fillStyle = b['Trạng thái'] === 'Available' ? '#64748b' : '#ffffff';
                ctx.font = `bold ${11}px Inter`;
                ctx.fillText(b['Booth ID'], bx + 5, by + 15);

                // Vẽ Logo nếu Occupied
                if (b['Trạng thái'] === 'Occupied' && b['Logo URL']) {
                    const img = new Image(); img.src = b['Logo URL'];
                    try { ctx.drawImage(img, bx + bw*0.1, by + bh*0.1, bw*0.8, bh*0.8); } catch(e){}
                }
            });

            ctx.restore();
            requestAnimationFrame(loop);
        }

        function openBooking(b) {
            if (b['Trạng thái'] !== 'Available') {
                return Swal.fire({
                    title: `Gian hàng ${b['Booth ID']}`,
                    text: `Trạng thái: ${b['Trạng thái']}. Vui lòng chọn gian hàng màu trắng.`,
                    icon: 'info', confirmButtonColor: app.configs.themeColor1
                });
            }

            Swal.fire({
                title: `<span class="text-xl font-black tracking-tighter">ĐĂNG KÝ GIAN HÀNG ${b['Booth ID']}</span>`,
                html: `
                    <div class="text-left space-y-4 p-2">
                        <div class="bg-slate-50 p-4 rounded-3xl flex gap-4 items-center border border-slate-100">
                            <img src="${b['Link QR thanh toán']}" class="w-24 h-24 rounded-2xl shadow-md bg-white p-1">
                            <div>
                                <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">${b['Hạng']}</p>
                                <p class="text-lg font-black text-slate-800">${parseInt(b['Giá gồm thuế (VAT 10%)']).toLocaleString()} VND</p>
                                <p class="text-[9px] text-slate-400">Quét QR để thanh toán giữ chỗ ngay</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <input id="sw-comp-short" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tên công ty viết tắt *">
                            <input id="sw-comp-full" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tên đầy đủ pháp nhân">
                            <input id="sw-tax" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Mã số thuế">
                            <input id="sw-name" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Người đại diện đăng ký *">
                            <input id="sw-phone" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Số điện thoại liên hệ *">
                            <input id="sw-email" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Email nhận xác nhận *">
                        </div>
                    </div>
                `,
                confirmButtonText: 'XÁC NHẬN GIỮ CHỖ',
                confirmButtonColor: app.configs.themeColor1,
                showCancelButton: true,
                cancelButtonText: 'ĐÓNG',
                preConfirm: () => {
                    const getV = id => document.getElementById(id).value;
                    if(!getV('sw-comp-short') || !getV('sw-name') || !getV('sw-phone')) return Swal.showValidationMessage('Vui lòng điền các mục *');
                    return {
                        compShort: getV('sw-comp-short'), compFull: getV('sw-comp-full'),
                        tax: getV('sw-tax'), name: getV('sw-name'),
                        phone: getV('sw-phone'), email: getV('sw-email')
                    };
                }
            }).then(async (res) => {
                if (res.isConfirmed) {
                    Swal.fire({ title: 'Đang gửi đăng ký...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const result = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'bookBooth', boothId: b['Booth ID'], info: res.value }) }).then(r => r.json());
                    if (result.success) Swal.fire('Thành công', result.message, 'success').then(() => location.reload());
                    else Swal.fire('Lỗi', result.message, 'error');
                }
            });
        }

        // --- Chat Logic ---
        function toggleChat() {
            const win = document.getElementById('chat-win');
            win.classList.toggle('hidden');
        }

        async function sendChat() {
            const inp = document.getElementById('chat-inp');
            const msg = inp.value.trim();
            if (!msg) return;

            const body = document.getElementById('chat-body');
            body.innerHTML += `<div class="flex justify-end"><div class="bg-blue-600 text-white p-4 rounded-3xl rounded-tr-none text-sm shadow-md max-w-[80%]">${msg}</div></div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;

            document.getElementById('ai-loading').classList.remove('hidden');
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'chatAI', message: msg }) }).then(r => r.json());
                document.getElementById('ai-loading').classList.add('hidden');
                body.innerHTML += `<div class="flex justify-start"><div class="glass-panel p-4 rounded-3xl rounded-tl-none text-sm text-slate-700 shadow-sm border border-slate-100 max-w-[80%]">${res.answer}</div></div>`;
                body.scrollTop = body.scrollHeight;
            } catch (e) {
                document.getElementById('ai-loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>