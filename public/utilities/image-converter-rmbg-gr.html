<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuyển Đổi Ảnh Sang WebP Miễn Phí | Nén, Resize & Xóa Nền - LAZINET</title>
    <meta name="description" content="Công cụ chuyển đổi ảnh miễn phí: JPG/PNG sang WebP/AVIF, nén ảnh, thay đổi kích thước hàng loạt, và xóa nền ảnh bằng AI hoàn toàn trên browser.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .upload-area { border: 3px dashed #3498db; padding: 40px; text-align: center; border-radius: 12px; margin: 20px 0; transition: 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #2980b9; background: #ecf0f1; }
        .upload-area i { font-size: 50px; color: #3498db; }
        #file-input { display: none; }
        .options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
        .option-group { background: #f1f1f1; padding: 20px; border-radius: 8px; }
        .option-group label { display: block; margin: 10px 0 5px; font-weight: bold; }
        .threshold-group { display: none; margin-top: 10px; } /* Ẩn mặc định */
        .threshold-group.show { display: block; }
        button { background: #3498db; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .preview, .result { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 40px 0; }
        .image-item { text-align: center; }
        .image-item img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .download-link { display: block; margin: 10px 0; color: #3498db; text-decoration: none; }
        .progress { margin: 20px 0; text-align: center; font-style: italic; color: #7f8c8d; }
        footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chuyển Đổi, Nén, Resize & Xóa Nền Ảnh Miễn Phí</h1>
        <p style="text-align:center;">Hỗ trợ hàng loạt • Chạy hoàn toàn trên trình duyệt • Không upload server</p>

        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Kéo thả ảnh vào đây hoặc click để chọn file</p>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>

        <div class="options">
            <div class="option-group">
                <label>Định dạng đầu ra</label>
                <select id="output-format">
                    <option value="webp">WebP</option>
                    <option value="avif">AVIF (nếu hỗ trợ)</option>
                    <option value="png">PNG</option>
                    <option value="jpeg">JPEG</option>
                    <option value="original">Giữ nguyên</option>
                </select>

                <label>Chất lượng nén (JPEG/WebP)</label>
                <input type="range" id="quality" min="1" max="100" value="80">
                <span id="quality-value">80%</span>
            </div>

            <div class="option-group">
                <label>Thay đổi kích thước</label>
                <input type="number" id="width" placeholder="Chiều rộng (px)" min="1">
                <input type="number" id="height" placeholder="Chiều cao (px)" min="1">
                <small>Giữ trống để giữ tỷ lệ gốc</small>
            </div>

            <div class="option-group">
                <label><input type="checkbox" id="remove-bg"> Xóa nền ảnh (Remove Background bằng AI - dành cho ảnh có người)</label>
                <small>Tốt nhất cho ảnh có người chính rõ ràng. Lần đầu tải model ~20MB, chờ 10-30s. Sản phẩm có thể không chính xác 100%.</small>
                <div class="threshold-group" id="threshold-group">
                    <label>Độ chính xác đường viền (Threshold): <span id="threshold-value">0.7</span></label>
                    <input type="range" id="threshold" min="0.5" max="0.9" step="0.05" value="0.7">
                    <small>Giá trị cao hơn = đường viền sát hơn (ít lỗi nhưng có thể cắt chủ thể). Thử nghiệm để phù hợp ảnh.</small>
                </div>
            </div>
        </div>

        <div style="text-align:center;">
            <button id="process-btn">Xử Lý Ảnh</button>
        </div>

        <div class="progress" id="progress"></div>

        <h2>Ảnh gốc</h2>
        <div class="preview" id="preview"></div>

        <h2>Kết quả</h2>
        <div class="result" id="result"></div>
    </div>

    <footer>© 2025 LAZINET • Công cụ miễn phí, không lưu trữ ảnh</footer>

    <script>
        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');
        const result = document.getElementById('result');
        const progress = document.getElementById('progress');
        const processBtn = document.getElementById('process-btn');
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('quality-value');
        const removeBgCheckbox = document.getElementById('remove-bg');
        const thresholdGroup = document.getElementById('threshold-group');
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('threshold-value');

        let files = [];

        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = qualitySlider.value + '%';
        });

        // Hiển thị/ẩn tùy chọn threshold khi tick checkbox
        removeBgCheckbox.addEventListener('change', () => {
            if (removeBgCheckbox.checked) {
                thresholdGroup.classList.add('show');
            } else {
                thresholdGroup.classList.remove('show');
            }
        });

        thresholdSlider.addEventListener('input', () => {
            thresholdValue.textContent = thresholdSlider.value;
        });

        fileInput.addEventListener('change', (e) => {
            files = Array.from(e.target.files);
            displayPreview();
        });

        // Drag & drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#27ae60'; });
        uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = '#3498db'; });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3498db';
            files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            displayPreview();
        });

        function displayPreview() {
            preview.innerHTML = '';
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'image-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                const name = document.createElement('p');
                name.textContent = file.name;
                div.appendChild(img);
                div.appendChild(name);
                preview.appendChild(div);
            });
        }

        async function processImages() {
            if (files.length === 0) return alert('Vui lòng chọn ảnh!');

            processBtn.disabled = true;
            result.innerHTML = '';
            progress.textContent = 'Đang xử lý...';

            const outputFormat = document.getElementById('output-format').value;
            const quality = parseInt(qualitySlider.value) / 100;
            const targetWidth = parseInt(document.getElementById('width').value) || null;
            const targetHeight = parseInt(document.getElementById('height').value) || null;
            const removeBgOption = document.getElementById('remove-bg').checked;
            const segmentationThreshold = parseFloat(thresholdSlider.value); // Lấy giá trị threshold từ slider

            let net = null;
            if (removeBgOption) {
                try {
                    progress.textContent += ' (Đang tải model AI xóa nền...)';
                    // Sử dụng mô hình ResNet50 để có độ chính xác cao hơn
                    net = await bodyPix.load({
                        architecture: 'ResNet50',
                        outputStride: 16,
                        quantBytes: 2
                    });
                    progress.textContent = 'Model sẵn sàng!';
                } catch (err) {
                    console.error('Lỗi tải model:', err);
                    alert('Không thể tải model xóa nền. Vui lòng thử lại hoặc tắt tùy chọn này. Chi tiết: ' + err.message);
                    processBtn.disabled = false;
                    return;
                }
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                progress.textContent = `Đang xử lý ${i+1}/${files.length}: ${file.name}`;

                let blob = file;
                let bgRemoved = false;

                // Bước 1: Xóa nền nếu chọn
                if (removeBgOption && net) {
                    try {
                        const img = new Image();
                        img.crossOrigin = "anonymous"; // Đảm bảo cross-origin cho canvas
                        img.src = URL.createObjectURL(file);
                        await new Promise((resolve) => img.onload = resolve);
                        
                        // Lấy dữ liệu phân đoạn với threshold tùy chỉnh
                        const segmentation = await net.segmentPerson(img, {
                            segmentationThreshold: segmentationThreshold
                        });
                        
                        // Tạo canvas mới với nền trong suốt
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');

                        // Vẽ ảnh gốc
                        ctx.drawImage(img, 0, 0);

                        // Lấy dữ liệu pixel của ảnh gốc
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        // Lấy dữ liệu phân đoạn (0 là nền, >0 là người/vật thể)
                        const segmentationData = segmentation.data; 
                        
                        // === ĐOẠN CODE FIX LỖI "XOÁ LỘN NGƯỢC" ===
                        for (let j = 0; j < segmentationData.length; j++) {
                            // Vị trí alpha trong mảng data là j * 4 + 3
                            const alphaIndex = j * 4 + 3; 

                            // Nếu segmentationData[j] là 0 (ĐÃ PHÂN TÁCH LÀ NỀN)
                            if (segmentationData[j] === 0) { 
                                data[alphaIndex] = 0; // Đặt kênh alpha về 0 (trong suốt)
                            } else {
                                // Nếu là người/vật thể (chủ thể), giữ alpha = 255 (rõ nét)
                                data[alphaIndex] = 255; 
                            }
                        }

                        ctx.putImageData(imageData, 0, 0);
                        // === KẾT THÚC ĐOẠN CODE FIX ===

                        // Convert to blob PNG (luôn PNG để giữ transparency)
                        blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        bgRemoved = true;
                        progress.textContent += ' (xóa nền OK)';
                    } catch (err) {
                        console.error('Lỗi xóa nền:', err);
                        alert(`Xóa nền thất bại cho ${file.name}. Tiếp tục với ảnh gốc. Chi tiết: ${err.message}`);
                        bgRemoved = false;
                    }
                }

                // Bước 2: Resize + Convert bằng Canvas
                // Nếu đã xóa nền, outputFormat mặc định sẽ là 'png'
                const finalFormat = bgRemoved ? 'png' : outputFormat;
                
                const processedBlob = await processWithCanvas(
                    blob, 
                    finalFormat, 
                    quality, 
                    targetWidth, 
                    targetHeight, 
                    finalFormat === 'jpeg' && !bgRemoved
                );

                // Hiển thị kết quả
                const div = document.createElement('div');
                div.className = 'image-item';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(processedBlob);

                const name = document.createElement('p');
                let ext = finalFormat === 'original' ? file.name.split('.').pop() : finalFormat;
                if (bgRemoved && finalFormat !== 'png') ext = 'png'; // Giữ PNG nếu xóa nền
                name.textContent = (bgRemoved ? 'removed-bg-' : 'processed-') + file.name.replace(/\.[^/.]+$/, '') + '.' + ext;

                const a = document.createElement('a');
                a.href = img.src;
                a.download = name.textContent;
                a.className = 'download-link';
                a.textContent = 'Tải xuống';

                div.appendChild(img);
                div.appendChild(name);
                div.appendChild(a);
                result.appendChild(div);
            }

            progress.textContent = 'Hoàn thành!';
            processBtn.disabled = false;
        }

        function processWithCanvas(blob, format, quality, width, height, fillWhite = true) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;

                    if (width || height) {
                        if (width && height) {
                            w = width; h = height;
                        } else if (width) {
                            h = (img.height * width) / img.width;
                            w = width;
                        } else if (height) {
                            w = (img.width * height) / img.height;
                            h = height;
                        }
                    }

                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');

                    if (fillWhite) {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, w, h);
                    }
                    ctx.drawImage(img, 0, 0, w, h);

                    let mime = blob.type;
                    if (format === 'webp') mime = 'image/webp';
                    else if (format === 'avif') mime = 'image/avif';
                    else if (format === 'png') mime = 'image/png';
                    else if (format === 'jpeg') mime = 'image/jpeg';

                    canvas.toBlob(resolve, mime, quality);
                };
                img.src = URL.createObjectURL(blob);
                img.onerror = () => resolve(blob);
            });
        }

        // Gắn event listener cho button
        processBtn.addEventListener('click', processImages);
    </script>
</body>
</html>