<!DOCTYPE html>
<html lang="vi-VN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0">

    <title>LAZINET LUCKY DRAW NEW YEAR 2026 | Professional Utility</title>
    <meta name="description" content="üéØ C√¥ng c·ª• quay th∆∞·ªüng chuy√™n nghi·ªáp t·ª´ LAZINET cho nƒÉm m·ªõi 2026. T√πy ch·ªânh gi·∫£i th∆∞·ªüng, √¢m thanh ho√†nh tr√°ng v√† minh b·∫°ch.">
    <meta name="author" content="LAZINET - C√¥ng Ty C√¥ng Ngh·ªá H√†ng ƒê·∫ßu Vi·ªát Nam">

    <link rel="icon" type="image/x-icon" href="../assets/img/logo-lazinet/lazinet_LogoOnly.ico">
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/all.min.css">
    <!-- <link rel="stylesheet" href="../assets/css/lazinet.css">
    <link rel="stylesheet" href="../assets/css/custom.css"> -->
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300..700&family=Instrument+Sans:wght@400..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --lz-bg: #0F162C;
            --lz-card: rgba(255, 255, 255, 0.03);
            --lz-accent: #3F82FB;
            --lz-border: rgba(255, 255, 255, 0.1);
            --lz-orange: #ff5000;
        }

        body { background-color: var(--lz-bg); color: #fff; font-family: "Be Vietnam Pro", "Inter", "Instrument Sans", sans-serif; overflow-x: hidden; }
        .glass-card { background: var(--lz-card); border: 1px solid var(--lz-border); border-radius: 24px; backdrop-filter: blur(15px); padding: 25px; height: 100%; }

        /* Header Responsive */
        .brand-container { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            width: 100%; 
            flex-wrap: wrap;
            gap: 10px;
        }

        .brand-year { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            font-weight: 800; 
            letter-spacing: 1px; 
            font-size: 1.25rem;
            color: #fff; 
            text-shadow: 0 0 20px rgba(63, 130, 251, 0.5);
            transition: all 0.3s ease;
            text-align: right;
            flex: 1;
        }
        @media (max-width: 992px) { .brand-year { font-size: 1rem; letter-spacing: 1px; } }
        @media (max-width: 768px) { .brand-year { position: static; transform: none; margin-left: auto; font-size: 0.85rem; } }
        @media (max-width: 480px) { 
            .brand-container { justify-content: center; }
            .brand-year { 
                font-size: 0.75rem; 
                text-align: center;
                width: 100%;
                margin-top: 5px;
            }
            .navbar-brand { margin-right: 0; }
        }

        /* Wheel & Pointer */
        .wheel-wrapper { position: relative; max-width: 420px; margin: 0 auto; }
        #wheel-pointer { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            z-index: 100; width: 45px; filter: drop-shadow(0 5px 12px rgba(255, 80, 0, 0.6)); 
        }
        canvas { width: 100%;}

        /* Inputs */
        .lz-input { background: rgba(255,255,255,0.05) !important; border: 1px solid var(--lz-border) !important; color: #fff !important; border-radius: 12px; }
        .lz-input::placeholder { color: rgba(255, 255, 255, 0.25) !important; font-weight: 400; }
        .unit-label { width: 60px; text-align: left; display: inline-block; font-size: 0.8rem; opacity: 0.5; }

        /* Audio Bar */
        .audio-bar { 
            background: rgba(63, 130, 251, 0.08); border-radius: 14px; padding: 10px 18px; margin-bottom: 25px; 
            display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(63, 130, 251, 0.15);
        }
        .audio-main-btn { cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--lz-accent); transition: 0.2s; }
        .change-music-btn { 
            font-size: 0.7rem; font-weight: 800; color: rgba(255,255,255,0.4); text-decoration: none; 
            border: 1px solid rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 8px; cursor: pointer;
        }

        /* Reward items */
        .reward-item { display: grid; grid-template-columns: 1fr 50px 70px 30px; gap: 10px; margin-bottom: 10px; align-items: center; }
        .btn-spin { 
            background: linear-gradient(90deg, var(--lz-orange), #E64A19); border: none; color: white; padding: 18px; 
            border-radius: 16px; font-weight: 800; width: 100%; transition: 0.3s; box-shadow: 0 10px 20px rgba(230, 74, 25, 0.3);
        }
        .btn-spin:disabled { opacity: 0.4; }

        /* CHI·ªÄU CAO LINH HO·∫†T - c·∫°nh d∆∞·ªõi b·∫±ng nhau */
        .height-sync-container {
            display: flex;
            flex-direction: column;
            height: calc(100% - 30px); /* Chi·ªÅu cao linh ho·∫°t */
        }
        
        /* K·∫øt qu·∫£ v·ª´a quay - chi·ªÅu cao c·ªë ƒë·ªãnh */
        .result-container {
            height: 180px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px dashed var(--lz-accent);
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* DANH S√ÅCH TR√öNG GI·∫¢I - chi·ªÅu cao t·ª± ƒë·ªông gi√£n ƒë·ªÉ b·∫±ng v·ªõi L·ªãch s·ª≠ */
        .stats-container {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .stats-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* L·ªäCH S·ª¨ TRAO GI·∫¢I - chi·ªÅu cao t·ª± ƒëi·ªÅu ch·ªânh */
        .history-container { 
            height: calc(100% - 70px); /* 70px cho header v√† margin */
            overflow-y: auto; 
            padding-right: 5px;
        }
        
        .history-row { 
            padding: 12px 15px; 
            border-radius: 14px; 
            margin-bottom: 10px; 
            display: grid; 
            grid-template-columns: 40px 1fr 1fr 85px; 
            font-size: 0.85rem; 
            align-items: center; 
            background: rgba(255,255,255,0.02); 
            border: 1px solid var(--lz-border); 
        }
        
        /* B·∫£ng th·ªëng k√™ DANH S√ÅCH TR√öNG GI·∫¢I - KH√îNG c√≥ th·ªùi gian */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .stats-table th {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--lz-border);
            color: var(--lz-accent);
            font-weight: 700;
        }
        
        .stats-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: top;
        }
        
        .prize-column {
            width: 35%;
            background: rgba(255,255,255,0.02);
            font-weight: 600;
            border-left: 4px solid;
        }
        
        .winners-column {
            width: 65%;
        }
        
        .winner-row {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.05);
        }
        
        .winner-row:last-child {
            border-bottom: none;
        }
        
        .winner-number {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            min-width: 35px;
            text-align: right;
            padding-right: 10px;
        }
        
        .winner-name {
            flex-grow: 1;
            cursor: text;
        }
        
        /* N√∫t xu·∫•t Excel - CH·ªà ·ªü History */
        .export-btn {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #2ecc71;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .export-btn:hover {
            background: rgba(46, 204, 113, 0.3);
            transform: translateY(-2px);
        }
        
        .export-history-btn {
            margin-right: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            font-size: 0.9em;
        }
        
        .editable-name {
            display: inline-block;
            min-width: 50px;
        }
        
        .editable-name:focus {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            outline: none;
        }
        
        /* T·ªïng k·∫øt khi h·∫øt gi·∫£i - HI·ªÇN TH·ªä B·∫¢NG TH·ªêNG K√ä L·ªöN */
        .final-summary {
            display: none;
            text-align: center;
            padding: 30px 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .summary-table-container {
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid var(--lz-border);
            text-align: left;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .summary-title {
            color: var(--lz-accent);
            font-weight: 800;
            font-size: 1.5rem;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid var(--lz-border);
            padding-bottom: 15px;
        }
        
        .final-export-btn {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
            margin-top: 20px;
        }
        
        .final-export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(46, 204, 113, 0.4);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--lz-accent); border-radius: 10px; }
        
        /* ƒê·∫£m b·∫£o chi·ªÅu cao cho c√°c container ch√≠nh */
        .main-row {
            min-height: 600px;
        }
        
        @media (max-height: 800px) {
            .main-row {
                min-height: 500px;
            }
        }
        
    </style>
</head>

<body>
<nav class="navbar navbar-dark bg-transparent py-3">
    <div class="container">
        <div class="brand-container">
            <a class="navbar-brand" href="https://lazinet.com">
                <img src="../assets/img/logo-lazinet/lazinet_LogoFullv2.png" height="60">
            </a>
            <div class="brand-year">LUCKY DRAW NEW YEAR 2026</div>
        </div>
    </div>
</nav>

<main class="container py-2">
    <div class="row g-4 mb-4 main-row">
        <div class="col-lg-4">
            <div class="glass-card">
                <div class="d-flex align-items-center mb-4 text-primary">
                    <i class="fas fa-sliders-h fa-lg me-2"></i>
                    <h5 class="fw-bold mb-0">C·∫§U H√åNH</h5>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <label class="small fw-bold opacity-75 text-primary"><i class="fas fa-clock me-2"></i>TH·ªúI GIAN QUAY</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="spinDuration" class="form-control lz-input text-center p-1" value="5" style="width: 70px;">
                            <span class="unit-label">gi√¢y</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <label class="small fw-bold opacity-75 text-primary"><i class="fas fa-rocket me-2"></i>T·ªêC ƒê·ªò QUAY</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="spinSpeed" class="form-control lz-input text-center p-1" value="3" style="width: 70px;">
                            <span class="unit-label">v√≤ng/s</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-center mb-3 text-primary">
                    <i class="fas fa-gift me-2"></i>
                    <h6 class="fw-bold mb-0">DANH S√ÅCH GI·∫¢I</h6>
                    <span class="ms-2 small text-white-50 fst-italic" style="font-size: 0.75rem;">(SL ‚àû l√† v√¥ h·∫°n)</span>
                </div>
                <div id="rewardContainer" style="max-height: 320px; overflow-y: auto;"></div>
                <button onclick="addRewardRow()" class="btn btn-outline-light btn-sm w-100 border-0 py-2 mt-3" style="background: var(--lz-border);">
                    <i class="fas fa-plus-circle me-2"></i>Th√™m gi·∫£i th∆∞·ªüng
                </button>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="glass-card" style="height: 100%;">
                <div id="play-zone" class="row h-100 align-items-center">
                    <div class="col-md-7">
                        <div class="wheel-wrapper">
                            <div id="wheel-pointer">
                                <svg viewBox="0 0 24 24" fill="#ff5000">
                                    <path d="M12 24l8-12h-16l8 12zM12 0c-1.1 0-2 .9-2 2v10h4v-10c0-1.1-.9-2-2-2z"/>
                                </svg>
                            </div>
                            <canvas id="wheelCanvas" width="800" height="800"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="ps-md-4 py-4">
                            <div class="audio-bar">
                                <div class="audio-main-btn" onclick="toggleMute()">
                                    <i class="fas fa-volume-up" id="muteIcon"></i>
                                    <span style="font-size: 0.75rem; font-weight: 800;">√ÇM THANH</span>
                                </div>
                                <input type="file" id="audioUpload" accept="audio/*,video/*" class="d-none" onchange="loadMedia(this)">
                                <label for="audioUpload" class="change-music-btn">THAY NH·∫†C C·ª¶A B·∫†N</label>
                                <audio id="winSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
                            </div>
                            <label class="small fw-bold text-primary mb-2 opacity-75">T√äN NG∆Ø·ªúI QUAY</label>
                            <input type="text" id="currentPlayer" class="form-control lz-input mb-4 p-3 fw-bold" placeholder="ƒê·ªÉ tr·ªëng l√† 'M·∫∑c ƒë·ªãnh'...">
                            <button id="spinBtn" class="btn-spin" onclick="spin()">B·∫ÆT ƒê·∫¶U QUAY</button>
                        </div>
                    </div>
                </div>
                
                <!-- PH·∫¶N T·ªîNG K·∫æT KHI H·∫æT GI·∫¢I - HI·ªÇN TH·ªä B·∫¢NG TH·ªêNG K√ä L·ªöN -->
                <div id="final-summary" class="final-summary">
                    <h2 class="fw-bold text-primary mb-4">üéâ T·ªîNG K·∫æT TRAO GI·∫¢I üéâ</h2>
                    
                    <div class="summary-table-container">
                        <div class="summary-title">DANH S√ÅCH TR√öNG GI·∫¢I</div>
                        <div id="final-stats-table"></div>
                    </div>
                    
                    <button onclick="exportExcel()" class="final-export-btn">
                        <i class="fas fa-file-excel me-2"></i>XU·∫§T B√ÅO C√ÅO EXCEL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 main-row">
        <div class="col-lg-4">
            <div class="height-sync-container">
                <div class="glass-card result-container">
                    <span class="small opacity-50 text-uppercase fw-bold">K·∫æT QU·∫¢ V·ª™A QUAY</span>
                    <div id="lastResult" class="my-3 h2 fw-bold text-white">‚Äî</div>
                    <div id="lastWinner" class="badge bg-primary px-3 py-2 rounded-pill mx-auto" style="width: fit-content;">S·∫µn s√†ng</div>
                </div>
                
                <div class="glass-card stats-container">
                    <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-chart-bar me-2"></i>DANH S√ÅCH TR√öNG GI·∫¢I</h6>
                    <div id="statsTable" class="stats-content">
                        <div class="text-center py-4 text-white-50 small italic">Ch∆∞a c√≥ th·ªëng k√™ n√†o...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="glass-card" style="height: 100%;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-history me-2"></i>L·ªäCH S·ª¨ TRAO GI·∫¢I</h5>
                    <div>
                        <button onclick="exportHistoryToExcel()" class="export-btn export-history-btn">
                            <i class="fas fa-file-excel me-1"></i>Xu·∫•t Excel
                        </button>
                        <button onclick="clearHistory()" class="btn btn-link btn-sm text-danger text-decoration-none">X√≥a l·ªãch s·ª≠</button>
                    </div>
                </div>
                <div id="historyList" class="history-container">
                    <div id="emptyHistory" class="text-center py-5 text-white-50 small italic">Ch∆∞a c√≥ l∆∞·ª£t quay n√†o...</div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-copyright-text">
            <p>LUCKY <span style="color: #ff6302;"><b>LAZI</b></span><span style="color: #0000ff;"><b>NET</b></span> &copy;
                <script>
                    const startYear = 2024;
                    const currentYear = new Date().getFullYear();
                    document.write(`${startYear}‚Äì${currentYear}`);
                </script>
            </p>
        </div>
    </footer>
</main>

<script>
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const rewardContainer = document.getElementById('rewardContainer');
    const winSound = document.getElementById('winSound');
    const spinBtn = document.getElementById('spinBtn');
    let turnCount = 0;
    let currentAngle = 0;
    let isSpinning = false;
    let activeRewards = [];
    let historyData = [];
    let prizeOrder = [];
    let prizeStats = {};
    let allPrizes = [];

    function addRewardRow(name = "", color = "", qty = "") {
        const row = document.createElement('div');
        row.className = 'reward-item';
        const finalColor = color || `#${Math.floor(Math.random()*16777215).toString(16)}`;
        row.innerHTML = `
            <input type="text" class="form-control lz-input rew-name p-1 ps-2" placeholder="T√™n gi·∫£i..." value="${name}" oninput="refresh()">
            <input type="color" class="color-picker rew-color" value="${finalColor}" onchange="refresh()">
            <input type="number" class="form-control lz-input rew-qty text-center p-1" placeholder="‚àû" value="${qty}" oninput="refresh()">
            <button class="btn btn-link text-danger p-0" onclick="this.parentElement.remove(); refresh()"><i class="fas fa-times"></i></button>
        `;
        rewardContainer.appendChild(row);
        refresh();
    }

    function refresh() {
        const names = document.querySelectorAll('.rew-name');
        const colors = document.querySelectorAll('.rew-color');
        const qtys = document.querySelectorAll('.rew-qty');
        activeRewards = [];
        
        prizeOrder = [];
        names.forEach((n, i) => {
            const nameStr = n.value.trim();
            if(nameStr !== "" && !prizeOrder.includes(nameStr)) {
                prizeOrder.push(nameStr);
            }
        });
        
        allPrizes.forEach(prizeName => {
            if (!prizeOrder.includes(prizeName)) {
                prizeOrder.push(prizeName);
            }
        });
        
        names.forEach((n, i) => {
            const q = qtys[i].value;
            const qtyVal = q === "" ? null : parseInt(q);
            const nameStr = n.value.trim();
            
            if(nameStr !== "") {
                if (!allPrizes.includes(nameStr)) {
                    allPrizes.push(nameStr);
                }
                
                if(qtyVal === null || qtyVal > 0) {
                    activeRewards.push({ 
                        name: nameStr, 
                        color: colors[i].value, 
                        qty: qtyVal, 
                        input: qtys[i], 
                        row: n.parentElement 
                    });
                }
            }
        });
        
        if (activeRewards.length === 0 && turnCount > 0) {
            document.getElementById('play-zone').style.display = 'none';
            document.getElementById('final-summary').style.display = 'flex';
            renderFinalSummary();
        } else {
            document.getElementById('play-zone').style.display = 'flex';
            document.getElementById('final-summary').style.display = 'none';
            draw();
        }
    }

    function draw() {
        const radius = canvas.width / 2;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(activeRewards.length === 0) return;
        
        const slice = (Math.PI * 2) / activeRewards.length;
        activeRewards.forEach((item, i) => {
            const angle = currentAngle + i * slice;
            ctx.beginPath();
            ctx.fillStyle = item.color;
            ctx.moveTo(radius, radius);
            ctx.arc(radius, radius, radius - 15, angle, angle + slice);
            ctx.fill();
            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(angle + slice / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 24px Geist";
            const label = (item.qty === null ? "" : item.qty + " ") + item.name;
            ctx.fillText(label, radius - 60, 10);
            ctx.restore();
        });
        
        ctx.beginPath(); 
        ctx.arc(radius, radius, 30, 0, Math.PI * 2);
        ctx.fillStyle = "#0F162C"; 
        ctx.fill();
    }

    function spin() {
        if (isSpinning || activeRewards.length === 0) return;
        isSpinning = true; 
        spinBtn.disabled = true;
        
        const duration = (parseFloat(document.getElementById('spinDuration').value) || 5) * 1000;
        const speed = parseFloat(document.getElementById('spinSpeed').value) || 3;
        const totalRot = (speed * (duration/1000) * Math.PI * 2) + Math.random() * Math.PI * 2;
        const start = performance.now();
        
        function animate(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            currentAngle = (1 - Math.pow(1 - progress, 3)) * totalRot;
            draw();
            if (progress < 1) requestAnimationFrame(animate);
            else finalize();
        }
        requestAnimationFrame(animate);
    }

    function finalize() {
        isSpinning = false; 
        spinBtn.disabled = false;
        
        const slice = (Math.PI * 2) / activeRewards.length;
        const norm = (1.5 * Math.PI - (currentAngle % (Math.PI * 2))) % (Math.PI * 2);
        const idx = Math.floor((norm < 0 ? norm + Math.PI * 2 : norm) / slice);
        const prize = activeRewards[idx];
        const player = document.getElementById('currentPlayer').value.trim() || "M·∫∑c ƒë·ªãnh";
        
        if(prize.qty !== null) {
            prize.qty--;
            prize.input.value = prize.qty;
            if(prize.qty <= 0) {
                prize.row.style.opacity = "0.5";
                prize.row.style.textDecoration = "line-through";
            }
        }
        
        document.getElementById('lastResult').innerText = prize.name;
        document.getElementById('lastResult').style.color = prize.color;
        document.getElementById('lastWinner').innerText = "Ng∆∞·ªùi th·∫Øng: " + player;
        
        if(!winSound.muted) {
            winSound.currentTime = 0;
            winSound.play();
        }
        confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
        
        Swal.fire({
            title: 'CH√öC M·ª™NG!',
            html: `<b>${player}</b> ƒë√£ nh·∫≠n ƒë∆∞·ª£c:<br><h3 style="color:${prize.color}; margin-top:10px;">${prize.name}</h3>`,
            timer: 2000,
            showConfirmButton: false,
            background: '#161d31',
            color: '#fff'
        });
        
        turnCount++;
        const timeString = new Date().toLocaleTimeString('vi-VN');
        const dateString = new Date().toLocaleDateString('vi-VN');
        
        const historyEntry = {
            id: turnCount,
            player: player,
            prize: prize.name,
            prizeColor: prize.color,
            time: timeString,
            date: dateString,
            timestamp: new Date().getTime()
        };
        
        historyData.unshift(historyEntry);
        
        if (!prizeStats[prize.name]) {
            prizeStats[prize.name] = {
                name: prize.name,
                color: prize.color,
                winners: []
            };
        }
        
        prizeStats[prize.name].winners.push({
            id: turnCount,
            player: player,
            time: timeString,
            date: dateString
        });
        
        updateHistoryDisplay(historyEntry);
        updateStatsTable();
        document.getElementById('currentPlayer').value = "";
        refresh();
    }

    function updateHistoryDisplay(entry) {
        const history = document.getElementById('historyList');
        if(document.getElementById('emptyHistory')) document.getElementById('emptyHistory').remove();
        
        const div = document.createElement('div');
        div.className = 'history-row';
        div.style.borderLeft = `5px solid ${entry.prizeColor}`;
        
        div.innerHTML = `
            <div class="opacity-50 fw-bold">${entry.id}</div>
            <div class="fw-bold text-white editable-name" 
                contenteditable="true" 
                spellcheck="false"
                data-id="${entry.id}">
                ${entry.player}
            </div>
            <div style="color:${entry.prizeColor}">${entry.prize}</div>
            <div class="text-end opacity-50 small">${entry.time}</div>
        `;
        
        const nameElement = div.querySelector('.editable-name');
        nameElement.addEventListener('blur', function() {
            const newName = this.textContent.trim();
            const entryId = parseInt(this.getAttribute('data-id'));
            
            const historyIndex = historyData.findIndex(h => h.id === entryId);
            if (historyIndex !== -1) {
                historyData[historyIndex].player = newName;
            }
            
            for (const prizeName in prizeStats) {
                const winnerIndex = prizeStats[prizeName].winners.findIndex(w => w.id === entryId);
                if (winnerIndex !== -1) {
                    prizeStats[prizeName].winners[winnerIndex].player = newName;
                }
            }
            
            updateStatsTable();
        });
        
        history.prepend(div);
    }

    function updateStatsTable() {
        const statsTable = document.getElementById('statsTable');
        
        if (Object.keys(prizeStats).length === 0) {
            statsTable.innerHTML = '<div class="text-center py-4 text-white-50 small italic">Ch∆∞a c√≥ th·ªëng k√™ n√†o...</div>';
            return;
        }
        
        let html = '<table class="stats-table">';
        html += '<thead><tr><th>GI·∫¢I TH∆Ø·ªûNG</th><th>DANH S√ÅCH NG∆Ø·ªúI TR√öNG</th></tr></thead>';
        html += '<tbody>';
        
        prizeOrder.forEach(prizeName => {
            if (prizeStats[prizeName]) {
                const prize = prizeStats[prizeName];
                html += '<tr>';
                
                html += `<td class="prize-column" style="border-left-color: ${prize.color}; color: ${prize.color}">`;
                html += `<strong>${prize.name}</strong>`;
                html += `<br><small class="opacity-75">(${prize.winners.length} ng∆∞·ªùi tr√∫ng)</small>`;
                html += '</td>';
                
                html += '<td class="winners-column">';
                
                if (prize.winners.length > 0) {
                    const sortedWinners = [...prize.winners].sort((a, b) => a.id - b.id);
                    
                    sortedWinners.forEach(winner => {
                        html += `
                            <div class="winner-row">
                                <span class="winner-number">#${winner.id}</span>
                                <span class="winner-name editable-stats" 
                                    contenteditable="true" 
                                    data-id="${winner.id}" 
                                    data-prize="${prize.name}">
                                    ${winner.player}
                                </span>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="text-center py-2 text-white-50 small italic">Ch∆∞a c√≥ ng∆∞·ªùi tr√∫ng</div>';
                }
                
                html += '</td>';
                html += '</tr>';
            }
        });
        
        html += '</tbody></table>';
        statsTable.innerHTML = html;
        
        document.querySelectorAll('.editable-stats').forEach(el => {
            el.addEventListener('blur', function() {
                const newName = this.textContent.trim();
                const winnerId = parseInt(this.getAttribute('data-id'));
                const prizeName = this.getAttribute('data-prize');
                
                const winnerIndex = prizeStats[prizeName].winners.findIndex(w => w.id === winnerId);
                if (winnerIndex !== -1) {
                    prizeStats[prizeName].winners[winnerIndex].player = newName;
                }
                
                const historyIndex = historyData.findIndex(h => h.id === winnerId);
                if (historyIndex !== -1) {
                    historyData[historyIndex].player = newName;
                }
                
                const historyEntry = document.querySelector(`.editable-name[data-id="${winnerId}"]`);
                if (historyEntry) {
                    historyEntry.textContent = newName;
                }
            });
        });
    }

    function renderFinalSummary() {
        const container = document.getElementById('final-stats-table');
        let html = '';
        
        if (Object.keys(prizeStats).length === 0) {
            html = '<div class="text-center py-5 text-white-50 small italic">Ch∆∞a c√≥ th·ªëng k√™ n√†o...</div>';
        } else {
            html = '<table class="stats-table">';
            html += '<thead><tr><th>GI·∫¢I TH∆Ø·ªûNG</th><th>DANH S√ÅCH NG∆Ø·ªúI TR√öNG</th></tr></thead>';
            html += '<tbody>';
            
            prizeOrder.forEach(prizeName => {
                if (prizeStats[prizeName]) {
                    const prize = prizeStats[prizeName];
                    html += '<tr>';
                    
                    html += `<td class="prize-column" style="border-left-color: ${prize.color}; color: ${prize.color}">`;
                    html += `<strong>${prize.name}</strong>`;
                    html += `<br><small class="opacity-75">(${prize.winners.length} ng∆∞·ªùi tr√∫ng)</small>`;
                    html += '</td>';
                    
                    html += '<td class="winners-column">';
                    
                    if (prize.winners.length > 0) {
                        const sortedWinners = [...prize.winners].sort((a, b) => a.id - b.id);
                        
                        sortedWinners.forEach(winner => {
                            html += `
                                <div class="winner-row">
                                    <span class="winner-number">#${winner.id}</span>
                                    <span class="winner-name">${winner.player}</span>
                                </div>
                            `;
                        });
                    } else {
                        html += '<div class="text-center py-2 text-white-50 small italic">Ch∆∞a c√≥ ng∆∞·ªùi tr√∫ng</div>';
                    }
                    
                    html += '</td>';
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table>';
        }
        
        container.innerHTML = html;
    }

    function exportHistoryToExcel() {
        if (historyData.length === 0) {
            Swal.fire({
                title: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                text: 'Ch∆∞a c√≥ l·ªãch s·ª≠ quay th∆∞·ªüng n√†o ƒë·ªÉ xu·∫•t.',
                icon: 'warning',
                background: '#161d31',
                color: '#fff'
            });
            return;
        }
        
        const wsData = [
            ['STT L∆Ø·ª¢T QUAY', 'NG∆Ø·ªúI TH·∫ÆNG', 'GI·∫¢I TH∆Ø·ªûNG', 'TH·ªúI GIAN', 'NG√ÄY']
        ];
        
        const sortedHistory = [...historyData].sort((a, b) => b.id - a.id);
        
        sortedHistory.forEach(entry => {
            wsData.push([
                entry.id,
                entry.player,
                entry.prize,
                entry.time,
                entry.date
            ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "L·ªãch s·ª≠ quay th∆∞·ªüng");
        
        const fileName = `LichSuQuayThuong_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        Swal.fire({
            title: 'Xu·∫•t Excel th√†nh c√¥ng!',
            text: `File "${fileName}" ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
            background: '#161d31',
            color: '#fff'
        });
    }

    function exportStatsToExcel() {
        if (Object.keys(prizeStats).length === 0) {
            Swal.fire({
                title: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                text: 'Ch∆∞a c√≥ th·ªëng k√™ tr√∫ng th∆∞·ªüng n√†o ƒë·ªÉ xu·∫•t.',
                icon: 'warning',
                background: '#161d31',
                color: '#fff'
            });
            return;
        }
        
        const wsData = [
            ['GI·∫¢I TH∆Ø·ªûNG', 'STT L∆Ø·ª¢T QUAY', 'NG∆Ø·ªúI TH·∫ÆNG', 'TH·ªúI GIAN', 'NG√ÄY']
        ];
        
        prizeOrder.forEach(prizeName => {
            if (prizeStats[prizeName]) {
                const prize = prizeStats[prizeName];
                if (prize.winners.length > 0) {
                    const sortedWinners = [...prize.winners].sort((a, b) => a.id - b.id);
                    sortedWinners.forEach(winner => {
                        wsData.push([
                            prize.name,
                            winner.id,
                            winner.player,
                            winner.time,
                            winner.date
                        ]);
                    });
                } else {
                    wsData.push([prize.name, '', 'Ch∆∞a c√≥ ng∆∞·ªùi tr√∫ng', '', '']);
                }
                wsData.push(['', '', '', '', '']);
            }
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Th·ªëng k√™ tr√∫ng th∆∞·ªüng");
        
        const fileName = `ThongKeTrungThuong_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        Swal.fire({
            title: 'Xu·∫•t Excel th√†nh c√¥ng!',
            text: `File "${fileName}" ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
            background: '#161d31',
            color: '#fff'
        });
    }

    function exportExcel() {
        exportStatsToExcel();
    }

    function loadMedia(input) { 
        if(input.files[0]) winSound.src = URL.createObjectURL(input.files[0]); 
    }
    
    function toggleMute() { 
        winSound.muted = !winSound.muted; 
        document.getElementById('muteIcon').className = winSound.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up'; 
    }
    
    function clearHistory() { 
        document.getElementById('historyList').innerHTML = '<div id="emptyHistory" class="text-center py-5 text-white-50 small italic">Ch∆∞a c√≥ d·ªØ li·ªáu l∆∞·ª£t quay n√†o...</div>'; 
        document.getElementById('statsTable').innerHTML = '<div class="text-center py-4 text-white-50 small italic">Ch∆∞a c√≥ th·ªëng k√™ n√†o...</div>';
        document.getElementById('final-stats-table').innerHTML = '<div class="text-center py-5 text-white-50 small italic">Ch∆∞a c√≥ th·ªëng k√™ n√†o...</div>';
        turnCount = 0;
        historyData = [];
        prizeStats = {};
        allPrizes = [];
        refresh();
    }

    document.addEventListener('DOMContentLoaded', () => {
        addRewardRow("Gi·∫£i ƒê·∫∑c Bi·ªát", "#FF6300", "1");
        addRewardRow("Gi·∫£i Nh·∫•t", "#0000FF", "2");
        addRewardRow("Gi·∫£i Nh√¨", "#0A703F", "3");
        addRewardRow("Khuy·∫øn Kh√≠ch", "#EA2035", "5");
        addRewardRow("Ch√∫c May M·∫Øn", "#7030A0", "5");
        updateStatsTable();
    });
</script>
</body>
</html>