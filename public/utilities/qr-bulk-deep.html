<!DOCTYPE html>
<html lang="vi-VN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAZINET - T·∫°o QR Code H√†ng Lo·∫°t</title>
    <style>
        :root {
            --primary-color: #0052FF;
            --secondary-color: #FFFFFF0A;
            --bg-color: #0F162C;
            --text-color: #FFFFFF;
            --accent-color: #3F82FB;
            --accent-secondary-color: #0F2453;
            --divider-color: #FFFFFF1A;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --white-color: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--accent-secondary-color) 0%, var(--accent-color) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            background: var(--bg-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid var(--divider-color);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--divider-color);
        }

        h1 {
            color: var(--white-color);
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .subtitle {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .upload-section, .preview-section {
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--divider-color);
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: var(--white-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: rgba(63, 130, 251, 0.1);
            border-color: var(--white-color);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            color: var(--white-color);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(63, 130, 251, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
            color: var(--white-color);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 2px solid var(--divider-color);
        }

        .btn-secondary:hover {
            background: var(--accent-secondary-color);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #EF6C00 100%);
            color: var(--white-color);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #EF6C00 0%, #E65100 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }

        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid var(--divider-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--accent-secondary-color);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--divider-color);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--secondary-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .qr-item {
            text-align: center;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 10px;
            border: 1px solid var(--divider-color);
        }

        .qr-image {
            max-width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
        }

        .qr-name {
            font-size: 0.8em;
            word-break: break-word;
            margin-top: 5px;
            opacity: 0.9;
        }

        .download-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--divider-color);
        }

        .option-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        select, input[type="text"] {
            padding: 10px 15px;
            background: var(--secondary-color);
            border: 2px solid var(--divider-color);
            border-radius: 8px;
            color: var(--text-color);
            flex: 1;
            min-width: 200px;
        }

        .help-text {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 10px;
            line-height: 1.4;
        }

        .template-link {
            color: var(--accent-color);
            text-decoration: none;
            margin-left: 10px;
        }

        .template-link:hover {
            text-decoration: underline;
        }

        .error-message {
            color: var(--error-color);
            padding: 10px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: var(--success-color);
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        /* Th√™m style cho c·ªôt logo */
        .logo-cell {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .logo-preview {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            object-fit: cover;
            vertical-align: middle;
            margin-right: 5px;
            border: 1px solid var(--divider-color);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--accent-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 18px;
            text-align: center;
        }
    </style>
    <!-- Include QR Code Styling Library -->
    <script src="https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
    <!-- Include XLSX library for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Include JSZip for zip file creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Include FileSaver for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">ƒêang x·ª≠ l√Ω...</div>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1>üìä LAZINET - T·∫°o QR Code H√†ng Lo·∫°t</h1>
            <p class="subtitle">T·∫£i l√™n file Excel/CSV ƒë·ªÉ t·∫°o nhi·ªÅu QR code c√πng l√∫c v·ªõi c√°c thi·∫øt l·∫≠p kh√°c nhau</p>
        </header>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2 class="section-title">üìÅ T·∫£i l√™n d·ªØ li·ªáu</h2>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3>K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn</h3>
                    <p>H·ªó tr·ª£ CSV, XLS, XLSX</p>
                    <p class="help-text">T·∫£i m·∫´u: 
                        <a href="javascript:void(0)" onclick="downloadTemplate()" class="template-link">template.csv</a> 
                        | 
                        <a href="javascript:void(0)" onclick="downloadTemplate('excel')" class="template-link">template.xlsx</a>
                    </p>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xls,.xlsx" onchange="handleFileUpload(event)">
                
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div><strong>File:</strong> <span id="fileName"></span></div>
                    <div><strong>K√≠ch th∆∞·ªõc:</strong> <span id="fileSize"></span></div>
                    <div><strong>S·ªë d√≤ng:</strong> <span id="rowCount"></span></div>
                </div>

                <div class="help-text">
                    <p><strong>C·∫•u tr√∫c file c·∫ßn c√≥ c√°c c·ªôt sau:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><code>type</code>: Lo·∫°i QR (text, url, wifi, phone, email, vcard)</li>
                        <li><code>content</code>: N·ªôi dung QR code</li>
                        <li><code>size</code>: K√≠ch th∆∞·ªõc (px, t√πy ch·ªçn)</li>
                        <li><code>margin</code>: L·ªÅ (px, t√πy ch·ªçn)</li>
                        <li><code>colorDark</code>: M√†u module (hex, t√πy ch·ªçn)</li>
                        <li><code>colorLight</code>: M√†u n·ªÅn (hex, t√πy ch·ªçn)</li>
                        <li><code>centerImage</code>: URL ·∫£nh trung t√¢m (t√πy ch·ªçn)</li>
                        <li><code>filename</code>: T√™n file (t√πy ch·ªçn)</li>
                    </ul>
                    <p><strong>L∆∞u √Ω:</strong> 
                        <br>‚Ä¢ K√≠ch th∆∞·ªõc QR t·ªëi thi·ªÉu: 100px
                        <br>‚Ä¢ ·∫¢nh trung t√¢m n√™n c√≥ k√≠ch th∆∞·ªõc ph√π h·ª£p v·ªõi QR
                        <br>‚Ä¢ C√°c c·ªôt t√πy ch·ªçn n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh
                    </p>
                </div>

                <div class="controls">
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                        <span>üìÅ</span> Ch·ªçn File
                    </button>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h2 class="section-title">üëÅÔ∏è Xem tr∆∞·ªõc & Xu·∫•t file</h2>
                
                <div class="preview-table-container" id="dataTableContainer" style="display: none;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Lo·∫°i</th>
                                <th>N·ªôi dung</th>
                                <th>K√≠ch th∆∞·ªõc</th>
                                <th>M√†u</th>
                                <th>Logo</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="qr-grid" id="qrPreview" style="display: none;">
                    <!-- QR previews will be inserted here -->
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressText">ƒêang x·ª≠ l√Ω: 0/0</span>
                        <span id="progressPercent">0%</span>
                    </div>
                </div>

                <div class="download-options" id="downloadOptions" style="display: none;">
                    <h3>T√πy ch·ªçn xu·∫•t file:</h3>
                    <div class="option-group">
                        <select id="exportFormat">
                            <option value="zip">Zip file (t·∫•t c·∫£ QR)</option>
                            <option value="individual">T·ª´ng file ri√™ng l·∫ª</option>
                        </select>
                        <input type="text" id="zipName" placeholder="T√™n file zip (QR_BATCH_DATE.zip)" value="QR_LAZINET_BATCH">
                    </div>
                    <p class="help-text">T·∫•t c·∫£ QR code s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t trong th∆∞ m·ª•c v·ªõi t√™n b·∫°n ch·ªçn</p>
                </div>

                <div class="controls">
                    <!-- N√öT HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ƒê∆Ø·ª¢C ƒê∆ØA L√äN ƒê·∫¶U TI√äN -->
                    <button class="btn-warning" onclick="togglePreview()" id="togglePreviewBtn" disabled>
                        <span>üìã</span> Hi·ªÉn th·ªã d·ªØ li·ªáu
                    </button>
                    
                    <button class="btn-success" onclick="generateAllQR()" id="generateBtn" disabled>
                        <span>‚ö°</span> T·∫°o t·∫•t c·∫£ QR
                    </button>
                    
                    <button class="btn-primary" onclick="exportAllQR()" id="exportBtn" disabled>
                        <span>üì¶</span> Xu·∫•t to√†n b·ªô
                    </button>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--divider-color); opacity: 0.7;">
            <p>QRMS<sup>‚Ñ¢</sup> <span style="color: #ff6302;"><b>LAZI</b></span><span style="color: #0000ff;"><b>NET</b></span> &copy; 2024‚Äì<script>document.write(new Date().getFullYear())</script></p>
        </footer>
    </div>

    <script>
        // Global variables
        let qrData = [];
        let qrInstances = [];
        let isPreviewVisible = false;

        // Show loading overlay
        function showLoading(text = 'ƒêang x·ª≠ l√Ω...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // File template download - UPDATED WITH centerImage
        function downloadTemplate(format = 'csv') {
            const templateData = [
                ['type', 'content', 'size', 'margin', 'colorDark', 'colorLight', 'centerImage', 'filename'],
                ['text', '12345', '600', '20', '#0000ff', '#ffffff', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'Phung1'],
                ['text', '12346', '600', '20', '#0000ff', '#ffffff', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'Phung2'],
                ['url', 'https://lazinet.com', '500', '15', '#0052FF', '#FFFFFF', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'Website_Lazinet'],
                ['wifi', 'WIFI:S:LAZINET_WIFI;T:WPA;P:P@ssw0rd123;;', '400', '10', '#000000', '#FFFFFF', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'WiFi_Access'],
                ['phone', '+84908556220', '450', '12', '#FF5000', '#FFFFFF', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'Phone_Contact'],
                ['email', 'sales@lazinet.com', '450', '12', '#4CAF50', '#FFFFFF', 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.png', 'Email_Contact'],
                ['text', 'QR kh√¥ng c√≥ logo', '500', '10', '#000000', '#FFFFFF', '', 'No_Logo_QR']
            ];

            if (format === 'csv') {
                const csvContent = templateData.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, 'qr_template.csv');
            } else {
                // Create Excel file
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template');
                XLSX.writeFile(wb, 'qr_template.xlsx');
            }
        }

        // Handle file upload - FIXED VERSION
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading
            showLoading('ƒêang ƒë·ªçc file...');

            // Update file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';

            // Clear previous data
            qrData = [];
            qrInstances = [];
            document.getElementById('rowCount').textContent = '0';
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('qrPreview').innerHTML = '';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('togglePreviewBtn').disabled = true;
            document.getElementById('downloadOptions').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            
            // Parse file
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('Starting to parse file:', file.name);
                    
                    let data;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        console.log('Parsing as CSV');
                        data = parseCSV(e.target.result);
                    } else {
                        console.log('Parsing as Excel');
                        const workbook = XLSX.read(e.target.result, { 
                            type: file.name.toLowerCase().endsWith('.xlsx') ? 'array' : 'binary',
                            cellDates: true,
                            cellStyles: true
                        });
                        const firstSheetName = workbook.SheetNames[0];
                        const firstSheet = workbook.Sheets[firstSheetName];
                        data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    }
                    
                    console.log('Parsed data:', data);
                    
                    if (!data || data.length === 0) {
                        throw new Error('File r·ªóng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu');
                    }
                    
                    // Process data
                    processQRData(data);
                    
                    // Enable buttons
                    document.getElementById('togglePreviewBtn').disabled = false;
                    document.getElementById('generateBtn').disabled = false;
                    
                    hideLoading();
                    showMessage('success', `ƒê√£ t·∫£i l√™n th√†nh c√¥ng ${qrData.length} d√≤ng d·ªØ li·ªáu`);
                    
                } catch (error) {
                    console.error('Error parsing file:', error);
                    hideLoading();
                    showMessage('error', 'L·ªói khi ƒë·ªçc file: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                hideLoading();
                showMessage('error', 'L·ªói khi ƒë·ªçc file: ' + error);
            };
            
            // Choose correct reading method based on file type
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else if (file.name.toLowerCase().endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
            } else {
                // For .xls files
                reader.readAsBinaryString(file);
            }
        }

        // Parse CSV content - IMPROVED VERSION
        function parseCSV(content) {
            try {
                console.log('CSV content length:', content.length);
                
                // Remove BOM if present
                if (content.charCodeAt(0) === 0xFEFF) {
                    content = content.substring(1);
                }
                
                // Split lines and filter empty ones
                const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                
                console.log('Number of lines:', lines.length);
                
                if (lines.length === 0) {
                    return [];
                }
                
                // Parse each line
                const result = lines.map(line => {
                    const cells = [];
                    let currentCell = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        const nextChar = line[i + 1];
                        
                        if (char === '"' && !inQuotes) {
                            inQuotes = true;
                        } else if (char === '"' && inQuotes && nextChar === '"') {
                            // Escaped quote
                            currentCell += '"';
                            i++; // Skip next quote
                        } else if (char === '"' && inQuotes) {
                            inQuotes = false;
                        } else if (char === ',' && !inQuotes) {
                            cells.push(currentCell.trim());
                            currentCell = '';
                        } else {
                            currentCell += char;
                        }
                    }
                    
                    // Add last cell
                    cells.push(currentCell.trim());
                    
                    return cells;
                });
                
                console.log('Parsed CSV result:', result);
                return result;
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                // Fallback to simple split
                const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                return lines.map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
            }
        }

        // Process QR data from array - UPDATED WITH centerImage and FIXED
        function processQRData(dataArray) {
            console.log('Processing data array:', dataArray);
            
            if (!dataArray || !Array.isArray(dataArray) || dataArray.length === 0) {
                throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
            }

            // Get headers (first row)
            const headers = dataArray[0].map(h => {
                if (typeof h === 'string') {
                    return h.toLowerCase().trim();
                }
                return String(h).toLowerCase().trim();
            });
            
            console.log('Headers:', headers);
            
            // Check required columns
            const required = ['type', 'content'];
            const missingColumns = required.filter(col => !headers.includes(col));
            
            if (missingColumns.length > 0) {
                throw new Error(`Thi·∫øu c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}`);
            }

            // Get column indices
            const typeIndex = headers.indexOf('type');
            const contentIndex = headers.indexOf('content');
            const sizeIndex = headers.indexOf('size');
            const marginIndex = headers.indexOf('margin');
            const colorDarkIndex = headers.indexOf('colordark');
            const colorLightIndex = headers.indexOf('colorlight');
            const centerImageIndex = headers.indexOf('centerimage');
            const filenameIndex = headers.indexOf('filename');

            // Process each row
            qrData = [];
            let validRows = 0;
            let warnings = [];
            
            for (let i = 1; i < dataArray.length; i++) {
                const row = dataArray[i];
                
                // Skip empty rows
                if (!row || row.length === 0 || (row.length === 1 && !row[0])) {
                    continue;
                }
                
                try {
                    const item = {
                        type: String(row[typeIndex] || 'text').toLowerCase().trim(),
                        content: String(row[contentIndex] || '').trim(),
                        size: row[sizeIndex] ? Math.max(100, parseInt(row[sizeIndex]) || 300) : 300,
                        margin: row[marginIndex] ? Math.min(50, Math.max(0, parseInt(row[marginIndex]) || 10)) : 10,
                        colorDark: row[colorDarkIndex] ? String(row[colorDarkIndex]).trim() : '#000000',
                        colorLight: row[colorLightIndex] ? String(row[colorLightIndex]).trim() : '#FFFFFF',
                        centerImage: row[centerImageIndex] ? String(row[centerImageIndex]).trim() : '',
                        filename: row[filenameIndex] ? String(row[filenameIndex]).trim() : `qr_${validRows + 1}`
                    };
                    
                    // T·ª± ƒë·ªông th√™m # n·∫øu m√£ m√†u hex thi·∫øu
                    if (item.colorDark && !item.colorDark.startsWith('#')) {
                        item.colorDark = '#' + item.colorDark;
                    }
                    if (item.colorLight && !item.colorLight.startsWith('#')) {
                        item.colorLight = '#' + item.colorLight;
                    }
                    
                    // Validate required fields
                    if (!item.content) {
                        warnings.push(`D√≤ng ${i + 1} b·ªã b·ªè qua: thi·∫øu n·ªôi dung`);
                        continue;
                    }
                    
                    // Validate size
                    if (item.size < 100) {
                        item.size = 100;
                        warnings.push(`D√≤ng ${i + 1}: K√≠ch th∆∞·ªõc QR qu√° nh·ªè, ƒë√£ t·ª± ƒë·ªông ƒë·∫∑t th√†nh 100px`);
                    }
                    
                    // Validate margin
                    if (item.margin < 0 || item.margin > 50) {
                        item.margin = Math.min(50, Math.max(0, item.margin));
                        warnings.push(`D√≤ng ${i + 1}: Margin kh√¥ng h·ª£p l·ªá, ƒë√£ t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh`);
                    }
                    
                    qrData.push(item);
                    validRows++;
                    
                } catch (error) {
                    console.warn(`L·ªói x·ª≠ l√Ω d√≤ng ${i + 1}:`, error);
                    warnings.push(`D√≤ng ${i + 1}: ${error.message}`);
                }
            }

            console.log('Processed QR data:', qrData);
            
            if (qrData.length === 0) {
                throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file');
            }

            // Show warnings if any
            if (warnings.length > 0) {
                console.warn('Warnings:', warnings);
                showMessage('warning', `ƒê√£ x·ª≠ l√Ω ${qrData.length} d√≤ng. M·ªôt s·ªë c·∫£nh b√°o: ${warnings.slice(0, 3).join('; ')}${warnings.length > 3 ? '...' : ''}`);
            }

            // Update row count
            document.getElementById('rowCount').textContent = qrData.length;
            
            // Update table
            updateDataTable();
        }

        // Update data table preview - UPDATED WITH centerImage
        function updateDataTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            qrData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // T·∫°o preview logo nh·ªè
                let logoHtml = '';
                if (item.centerImage && item.centerImage.trim() !== '') {
                    logoHtml = `
                        <div class="logo-cell" title="${item.centerImage}">
                            <img src="${item.centerImage}" class="logo-preview" onerror="this.style.display='none'">
                            <span>${truncateText(item.centerImage, 20)}</span>
                        </div>
                    `;
                } else {
                    logoHtml = '<div class="logo-cell">Kh√¥ng c√≥</div>';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${getTypeIcon(item.type)} ${item.type}</td>
                    <td title="${item.content}">${truncateText(item.content, 30)}</td>
                    <td>${item.size}px</td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <div style="width: 15px; height: 15px; background: ${item.colorDark}; border: 1px solid white;"></div>
                            <div style="width: 15px; height: 15px; background: ${item.colorLight}; border: 1px solid white;"></div>
                        </div>
                    </td>
                    <td>${logoHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Toggle preview
        function togglePreview() {
            isPreviewVisible = !isPreviewVisible;
            const tableContainer = document.getElementById('dataTableContainer');
            const qrPreview = document.getElementById('qrPreview');
            const btn = document.getElementById('togglePreviewBtn');
            
            if (isPreviewVisible) {
                tableContainer.style.display = 'block';
                qrPreview.style.display = 'none';
                btn.innerHTML = '<span>üëÅÔ∏è</span> Xem QR preview';
                btn.className = 'btn-warning';
            } else {
                tableContainer.style.display = 'none';
                generateQRPreviews();
                qrPreview.style.display = 'grid';
                btn.innerHTML = '<span>üìã</span> Xem d·ªØ li·ªáu';
                btn.className = 'btn-secondary';
            }
        }

        // Generate QR previews
        async function generateQRPreviews() {
            const qrPreview = document.getElementById('qrPreview');
            qrPreview.innerHTML = '';
            
            // Clear previous instances
            qrInstances = [];
            
            // Generate first 12 QR codes for preview
            const previewCount = Math.min(qrData.length, 12);
            
            for (let i = 0; i < previewCount; i++) {
                const item = qrData[i];
                const qrItem = document.createElement('div');
                qrItem.className = 'qr-item';
                qrItem.innerHTML = `
                    <div id="qrPreview${i}"></div>
                    <div class="qr-name">${item.filename}</div>
                `;
                qrPreview.appendChild(qrItem);
                
                // Generate QR code
                await new Promise(resolve => setTimeout(resolve, 100));
                generateSingleQR(item, `qrPreview${i}`, false);
            }
        }

        // Generate single QR code - FIXED VERSION with error handling
        function generateSingleQR(item, containerId, forExport = false) {
            try {
                // Validate size for image
                const qrSize = forExport ? parseInt(item.size) : 120;
                const margin = parseInt(item.margin) || 10;
                
                const options = {
                    width: qrSize,
                    height: qrSize,
                    margin: margin,
                    data: formatQRContent(item.type, item.content),
                    qrOptions: {
                        errorCorrectionLevel: 'M',
                        mode: 'Byte'
                    },
                    dotsOptions: {
                        color: item.colorDark,
                        type: 'square'
                    },
                    backgroundOptions: {
                        color: item.colorLight
                    }
                };
                
                // Th√™m ·∫£nh trung t√¢m n·∫øu c√≥ - V·ªöI X·ª¨ L√ù L·ªñI
                if (item.centerImage && item.centerImage.trim() !== '') {
                    // T√≠nh to√°n k√≠ch th∆∞·ªõc ·∫£nh ph√π h·ª£p
                    const imageSizeRatio = 0.3; // 30% k√≠ch th∆∞·ªõc QR
                    const calculatedSize = Math.max(10, Math.floor(qrSize * imageSizeRatio));
                    
                    options.image = item.centerImage;
                    options.imageOptions = {
                        crossOrigin: "anonymous",
                        margin: 5,
                        imageSize: imageSizeRatio,
                        hideBackgroundDots: true
                    };
                    
                    console.log(`QR ${item.filename}: Size=${qrSize}, ImageSize=${calculatedSize}`);
                }
                
                const qrCode = new QRCodeStyling(options);
                
                if (!forExport && containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        try {
                            container.innerHTML = '';
                            qrCode.append(container);
                        } catch (error) {
                            console.error(`Error appending QR to container ${containerId}:`, error);
                            container.innerHTML = `<div style="color: red; padding: 10px;">L·ªói t·∫°o QR</div>`;
                        }
                    }
                }
                
                return qrCode;
            } catch (error) {
                console.error('Error generating QR:', error, item);
                return null;
            }
        }

        // Format QR content based on type
        function formatQRContent(type, content) {
            if (!content) return '';
            
            switch(type) {
                case 'url':
                    return content.startsWith('http') ? content : `https://${content}`;
                case 'email':
                    return `mailto:${content}`;
                case 'phone':
                    return `tel:${content}`;
                case 'wifi':
                    // Ensure proper WiFi format
                    if (!content.startsWith('WIFI:')) {
                        return `WIFI:S:${content};T:WPA;P:;;`;
                    }
                    return content;
                default:
                    return content;
            }
        }

        // Generate all QR codes - FIXED VERSION
        async function generateAllQR() {
            if (qrData.length === 0) {
                showMessage('error', 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫°o QR');
                return;
            }
            
            showLoading(`ƒêang t·∫°o ${qrData.length} QR code...`);
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const exportBtn = document.getElementById('exportBtn');
            const downloadOptions = document.getElementById('downloadOptions');
            
            // Reset progress
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = `ƒêang x·ª≠ l√Ω: 0/${qrData.length}`;
            progressPercent.textContent = '0%';
            
            // Clear previous instances
            qrInstances = [];
            
            // Generate all QR codes
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < qrData.length; i++) {
                const item = qrData[i];
                try {
                    const qrCode = generateSingleQR(item, '', true);
                    
                    if (qrCode) {
                        qrInstances.push({qrCode, item});
                        successCount++;
                    } else {
                        errorCount++;
                        console.error(`Failed to generate QR for item ${i}:`, item);
                    }
                    
                    // Update progress
                    const percent = Math.round(((i + 1) / qrData.length) * 100);
                    progressFill.style.width = `${percent}%`;
                    progressText.textContent = `ƒêang x·ª≠ l√Ω: ${i + 1}/${qrData.length}`;
                    progressPercent.textContent = `${percent}%`;
                    
                    // Small delay to prevent UI freezing
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                } catch (error) {
                    errorCount++;
                    console.error(`Error generating QR ${i}:`, error);
                }
            }
            
            hideLoading();
            
            // Enable export button if we have any successful QR codes
            if (successCount > 0) {
                exportBtn.disabled = false;
                downloadOptions.style.display = 'block';
                
                if (errorCount > 0) {
                    showMessage('warning', `ƒê√£ t·∫°o th√†nh c√¥ng ${successCount}/${qrData.length} QR code. ${errorCount} QR kh√¥ng th·ªÉ t·∫°o.`);
                } else {
                    showMessage('success', `ƒê√£ t·∫°o th√†nh c√¥ng ${successCount}/${qrData.length} QR code`);
                }
            } else {
                showMessage('error', 'Kh√¥ng th·ªÉ t·∫°o b·∫•t k·ª≥ QR code n√†o. Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.');
            }
        }

        // Export all QR codes - FIXED VERSION
        async function exportAllQR() {
            const exportFormat = document.getElementById('exportFormat').value;
            const zipName = document.getElementById('zipName').value || 'QR_LAZINET_BATCH';
            
            if (qrInstances.length === 0) {
                showMessage('error', 'Ch∆∞a c√≥ QR code n√†o ƒë∆∞·ª£c t·∫°o. Vui l√≤ng b·∫•m "T·∫°o t·∫•t c·∫£ QR" tr∆∞·ªõc.');
                return;
            }
            
            showLoading(`ƒêang xu·∫•t ${qrInstances.length} QR code...`);
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            
            // Reset progress
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = `ƒêang xu·∫•t: 0/${qrInstances.length}`;
            progressPercent.textContent = '0%';
            
            let exportedCount = 0;
            
            if (exportFormat === 'zip') {
                // Create zip file
                const zip = new JSZip();
                
                for (let i = 0; i < qrInstances.length; i++) {
                    const {qrCode, item} = qrInstances[i];
                    
                    try {
                        // Get QR code as blob with timeout
                        const blobPromise = qrCode.getRawData('png');
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), 10000)
                        );
                        
                        const blob = await Promise.race([blobPromise, timeoutPromise]);
                        
                        if (blob) {
                            // Add to zip
                            const fileName = `${item.filename.replace(/[<>:"/\\|?*]/g, '_')}.png`;
                            zip.file(fileName, blob);
                            exportedCount++;
                        }
                        
                        // Update progress
                        const percent = Math.round(((i + 1) / qrInstances.length) * 100);
                        progressFill.style.width = `${percent}%`;
                        progressText.textContent = `ƒêang xu·∫•t: ${i + 1}/${qrInstances.length}`;
                        progressPercent.textContent = `${percent}%`;
                        
                    } catch (error) {
                        console.error(`Error generating QR ${i}:`, error);
                    }
                    
                    // Small delay
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Generate and download zip
                try {
                    const content = await zip.generateAsync({type: 'blob'});
                    const timestamp = getCurrentTimestamp();
                    saveAs(content, `${zipName}_${timestamp}.zip`);
                    
                    hideLoading();
                    showMessage('success', `ƒê√£ xu·∫•t th√†nh c√¥ng ${exportedCount}/${qrInstances.length} QR code v√†o file zip`);
                    
                } catch (error) {
                    hideLoading();
                    console.error('Error creating zip:', error);
                    showMessage('error', 'L·ªói khi t·∫°o file zip: ' + error.message);
                }
                
            } else {
                // Export individual files
                for (let i = 0; i < qrInstances.length; i++) {
                    const {qrCode, item} = qrInstances[i];
                    
                    try {
                        await qrCode.download({
                            name: item.filename.replace(/[<>:"/\\|?*]/g, '_'),
                            extension: 'png'
                        });
                        
                        exportedCount++;
                        
                        // Update progress
                        const percent = Math.round(((i + 1) / qrInstances.length) * 100);
                        progressFill.style.width = `${percent}%`;
                        progressText.textContent = `ƒêang xu·∫•t: ${i + 1}/${qrInstances.length}`;
                        progressPercent.textContent = `${percent}%`;
                        
                    } catch (error) {
                        console.error(`Error downloading QR ${i}:`, error);
                    }
                    
                    // Delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                hideLoading();
                showMessage('success', `ƒê√£ xu·∫•t th√†nh c√¥ng ${exportedCount}/${qrInstances.length} file`);
            }
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function getTypeIcon(type) {
            const icons = {
                'text': 'üìù',
                'url': 'üåê',
                'wifi': 'üì∂',
                'phone': 'üìû',
                'email': '‚úâÔ∏è',
                'vcard': 'üë§'
            };
            return icons[type] || '‚ùì';
        }

        function getCurrentTimestamp() {
            const now = new Date();
            return [
                now.getFullYear(),
                (now.getMonth() + 1).toString().padStart(2, '0'),
                now.getDate().toString().padStart(2, '0'),
                now.getHours().toString().padStart(2, '0'),
                now.getMinutes().toString().padStart(2, '0')
            ].join('');
        }

        function showMessage(type, text) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // Clear previous messages
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = text;
                errorEl.style.display = 'block';
            } else if (type === 'warning') {
                successEl.style.cssText = 'color: var(--warning-color); padding: 10px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; margin-top: 10px; display: block;';
                successEl.textContent = text;
            } else {
                successEl.style.cssText = 'color: var(--success-color); padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; margin-top: 10px; display: block;';
                successEl.textContent = text;
            }
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add drag and drop functionality
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(63, 130, 251, 0.2)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.toLowerCase().endsWith('.csv') || 
                             file.name.toLowerCase().endsWith('.xls') || 
                             file.name.toLowerCase().endsWith('.xlsx'))) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('fileInput').files = dataTransfer.files;
                    
                    // Trigger the change event
                    const event = new Event('change', { bubbles: true });
                    document.getElementById('fileInput').dispatchEvent(event);
                } else {
                    showMessage('error', 'Vui l√≤ng ch·ªçn file CSV ho·∫∑c Excel');
                }
            });
            
            // Add error handler for image loading
            window.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG' && e.target.className === 'logo-preview') {
                    e.target.style.display = 'none';
                }
            }, true);
        });
    </script>
</body>
</html>