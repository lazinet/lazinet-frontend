<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title id="page-title">Mr. Lê Minh Phụng - PTGĐ NECS | Danh thiếp số thông minh bởi LAZINET</title>
    <meta name="description" content="Kết nối với Ông Lê Minh Phụng - Phó Tổng Giám Đốc Công ty Cổ phần Kỷ Nguyên Mới (NECS). Thông tin liên hệ, lĩnh vực Logistics & Kho lạnh. Giải pháp danh thiếp số chuyên nghiệp phát triển bởi LAZINET.">
    <meta name="keywords" content="Lê Minh Phụng, NECS, Logistics, Kho lạnh, Kỷ Nguyên Mới, Danh thiếp điện tử, Business Card, LAZINET, Chuyển đổi số">
    <meta name="author" content="LAZINET Technologies">
    <meta name="generator" content="LAZINET Smart Business Card Solution">
    <meta name="copyright" content="NECS © 2026 LAZINET Technologies">
    <meta name="robots" content="index, follow, max-image-preview:large">

    <link id="favicon" rel="icon" type="image/x-icon" href="../../assets/img/logo-lazinet/lazinet_LogoOnly.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../../assets/img/logo-lazinet/lazinet_LogoOnly.png">

    <meta property="og:title" content="Danh thiếp: Ông Lê Minh Phụng - PTGĐ NECS">
    <meta property="og:description" content="Chạm để lưu danh bạ & kết nối hợp tác. Giải pháp công nghệ từ LAZINET.">
    <meta property="og:type" content="profile">
    <meta property="og:site_name" content="NECS Digital Card">
    <meta property="og:image" content="https://lazinet.com/bizcards/vip/LeMinhPhung.jpg"> 
    <meta property="og:image:alt" content="Danh thiếp ông Lê Minh Phụng - NECS">
    <meta property="og:locale" content="vi_VN">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ông Lê Minh Phụng - PTGĐ NECS">
    <meta name="twitter:description" content="Kết nối hợp tác cùng NECS. Danh thiếp số bảo mật bởi LAZINET.">
    <meta name="twitter:image" content="https://lazinet.com/bizcards/vip/LeMinhPhung.jpg">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Lê Minh Phụng">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#187752"> <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Lê Minh Phụng",
        "jobTitle": "Phó Tổng Giám Đốc",
        "worksFor": {
            "@type": "Organization",
            "name": "Công ty Cổ phần Kỷ Nguyên Mới (NECS)",
            "url": "https://necs.vn" 
        },
        "url": "https://lazinet.com/bizcards/vip/leminhphung-necs",
        "image": "leminhphung_front.png",
        "knowsAbout": ["Logistics", "Kho lạnh", "Quản trị doanh nghiệp"],
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://lazinet.com/bizcards/vip/leminhphung-necs",
            "author": {
                "@type": "Organization",
                "name": "LAZINET Technologies",
                "url": "https://lazinet.com"
            }
        }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        
        :root {
            --placeholder-front: url('leminhphung_front.png?text=Front+Card');
            --placeholder-back: url('leminhphung_back.png?text=Back+Card');
            --bg-fallback: #1a1a1a; 
            --primary: #187752;
            --secondary: #B91C1C;
            --text: #333;
            --font: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font);
            color: var(--text);
            overflow-x: hidden;
            background-color: var(--bg-fallback);
            margin: 0; padding: 0;
        }

        /* Loading State */
        body.loading-mode .bizcard > * { opacity: 0 !important; visibility: hidden !important; }
        body.loading-mode #card-front { background-image: var(--placeholder-front) !important; background-size: cover; }
        body.loading-mode #card-back { background-image: var(--placeholder-back) !important; background-size: cover; }
        .bizcard, .bizcard > * { transition: opacity 0.3s ease-in-out, visibility 0.3s; }

        .video-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; object-fit: cover; filter: brightness(0.5);
            background-color: var(--bg-fallback);
            /* Placeholder mặc định trong CSS để tránh nháy đen */
            background-size: cover; background-position: center;
        }

        /* --- SCALING ENGINE (EDGE-TO-EDGE MOBILE - FIX #1) --- */
        .card-scaler-wrap {
            width: 100%; 
            display: flex; justify-content: center;
            padding: 0 !important; margin: 0 !important; /* Force margin/padding 0 */
            overflow: visible;
        }
        
        .bizcard-frame {
            width: 500px; height: 300px;
            position: relative;
            transform-origin: top center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            background: #000;
            display: flex;
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-sizing: border-box;
        }

        /* --- BIZCARD LAYOUT --- */
        .bizcard {
            width: 100%; height: 100%;
            border-radius: 12px;
            background-size: cover; background-position: center;
            padding: 16px 20px; 
            color: white;
            display: flex; flex-direction: column; 
            justify-content: space-between; 
        }
        
        .bizcard a { color: inherit; text-decoration: none; cursor: pointer; }
        .bizcard a:hover { opacity: 0.8; }

        /* HEADER SECTION */
        .card-top {
            flex: 0 0 auto; 
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 5px;
        }
        
        /* FIX #2: Logo Height = QR Height (70px) */
        .card-logo { 
            height: 70px; /* Tăng từ 42px lên 70px */
            width: auto; max-width: 200px; /* Giới hạn chiều ngang để không đè QR */
            object-fit: contain; 
            background: rgba(47,83,162,0.15); 
            padding: 10px; border-radius: 8px; 
            backdrop-filter: blur(4px); 
        }
        
        .qr-area {
            width: 70px; height: 70px;
            background: white; padding: 3px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .qr-area img, .qr-area canvas { width: 100% !important; height: 100% !important; }

        /* BODY SECTION */
        .card-body {
            flex: 1 1 auto; 
            display: flex; flex-direction: column; justify-content: center;
            min-height: 0; 
        }

        .intro-text { text-align: center; margin-top: -10px; } 
        .intro-text h2 { font-size: 24px; font-weight: 800; text-transform: uppercase; margin: 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); line-height: 1.2; }
        .intro-text .pos { font-size: 14px; font-weight: 600; font-style: italic; opacity: 0.95; margin: 2px 0 0 0; }

        /* Back Services */
        .services-wrapper { margin-top: 5px; }
        .services-title { 
            font-size: 11px; font-weight: 800; text-transform: uppercase; 
            border-bottom: 1px solid rgba(255,255,255,0.4); 
            padding-bottom: 2px; margin-bottom: 6px; display: inline-block; width: 100%;
        }
        .service-grid {
            display: grid; grid-template-columns: 1fr 1fr; 
            column-gap: 10px; row-gap: 4px;
        }
        .service-item {
            font-size: 10px; line-height: 1.3;
            display: flex; align-items: flex-start; text-align: left;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        }
        .service-item i { color: #facc15; margin-right: 5px; margin-top: 2px; flex-shrink: 0; font-size: 9px; }

        /* --- SOCIAL ICONS --- */
        .social-container {
            flex: 0 0 auto;
            display: flex; justify-content: center;
            margin: 5px 0 8px 0;
        }
        .social-icon {
            width: 34px; height: 34px; 
            background-color: #ffffff;
            border-radius: 50%; 
            margin: 0 6px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4); 
            transition: transform 0.2s;
        }
        .social-icon:hover { transform: scale(1.1); }
        .social-icon i { font-size: 18px; line-height: 0; display: inline-block; }

        /* FOOTER SECTION */
        .card-footer {
            flex: 0 0 auto; 
            background: rgba(0, 0, 0, 0.65);
            border-radius: 8px;
            padding: 8px 10px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.15);
            text-align: center;
        }

        .comp-name { 
            font-size: 11px; font-weight: 800; text-transform: uppercase; 
            color: #fff; letter-spacing: 0.5px; margin-bottom: 4px; display: block;
        }

        .contact-links {
            display: flex; justify-content: center; gap: 15px; 
            margin-bottom: 4px;
            white-space: nowrap;
        }
        .contact-link-item { font-size: 10px; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .contact-link-item i { color: #facc15; font-size: 11px; }

        .address-lines { display: flex; flex-direction: column; gap: 2px; }
        .addr-item { 
            font-size: 10px; line-height: 1.3; text-align: left; 
            display: flex; align-items: flex-start; justify-content: center; gap: 6px;
        }
        .addr-item i { color: #facc15; margin-top: 2px; flex-shrink: 0; font-size: 11px; }

        /* --- BUTTONS --- */
        .btn-action {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 12px 14px; border-radius: 50px;
            font-weight: 700; font-size: 13px;
            border: none; cursor: pointer; color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s; text-transform: uppercase;
        }
        .btn-action:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .action-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
            width: 100%; max-width: 900px; padding: 0 10px; margin-bottom: 30px;
        }
        
        /* Mobile Layout Buttons */
        @media (max-width: 767px) {
            .btn-item-main { width: 100%; } 
            .btn-item-sub { width: 48%; font-size: 12px; padding: 10px; }   
            .action-grid { gap: 8px; padding: 0 5px; }
        }
        @media (min-width: 768px) {
            .btn-item { width: auto; min-width: 120px; }
        }

        /* --- CHAT PANEL --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px; box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            overflow: hidden; border: 1px solid rgba(255,255,255,0.2);
            display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .glass-panel { flex-direction: row; } }

        .chat-sidebar {
            background: linear-gradient(135deg, var(--primary) 0%, #064e3b 100%);
            color: white; padding: 2rem;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        
        /* FIX #3: Increase Avatar Size */
        .secretary-avatar {
            width: 165px; height: 165px; /* Tăng từ 140px lên 165px */
            border-radius: 50%; 
            border: 4px solid white; object-fit: cover;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .chat-main { background: white; display: flex; flex-direction: column; height: 500px; }
        
        .chat-bubble { max-width: 85%; padding: 8px 12px; margin-bottom: 6px; border-radius: 12px; font-size: 14px; }
        .chat-bubble-user { background: var(--primary); color: white; align-self: flex-end; margin-left: 20%; }
        .chat-bubble-bot { background: #f3f4f6; color: #333; align-self: flex-start; margin-right: 20%; border: 1px solid #ddd; }

        .hidden { display: none !important; }
        .goog-te-gadget-simple { background: rgba(0,0,0,0.4) !important; border: none !important; padding: 4px 10px !important; border-radius: 20px; }
        .goog-te-gadget-simple span { color: white !important; font-weight: bold; }
        .goog-te-gadget img { display: none; }
    </style>
</head>
<body class="min-h-screen loading-mode flex flex-col items-center py-0 md:py-6">
    
    <video id="bg-video" autoplay muted loop class="video-background" poster="../../assets/img/background/Logistics-BG_008_W1024.webp">
        <source src="" type="video/mp4">
    </video>

    <div class="w-full max-w-6xl px-0 md:px-4 flex flex-col items-center relative z-10">

        <header class="text-center mb-4 text-white w-full animate-fade-in-down px-2 mt-4 md:mt-0">
            <div id="google_translate_element" class="inline-block mb-2"></div>
            <h1 id="intro-name" class="text-2xl md:text-5xl font-bold drop-shadow-lg"></h1>
            <p id="intro-pos" class="text-sm md:text-2xl opacity-90 font-light drop-shadow-md"></p>
        </header>

        <div id="capture-area" class="w-full flex flex-col lg:flex-row gap-0 lg:gap-8 justify-center items-center mb-6">
            
            <div class="card-scaler-wrap">
                <div class="bizcard-frame">
                    <div id="card-front" class="bizcard" style="background-image: url('')">
                        <div class="card-top">
                            <a id="link-logo-f" href="#" target="_blank"><img id="logo-f" src="" class="card-logo" alt="Logo"></a>
                            <a id="link-qr-f" href="#" target="_blank"><div id="qr-f" class="qr-area"></div></a>
                        </div>
                        
                        <div class="card-body">
                            <div class="intro-text">
                                <h2 id="name-f">...</h2>
                                <p id="pos-f" class="pos">...</p>
                            </div>
                            
                            <div id="socials-f" class="social-container"></div>
                        </div>

                        <div class="card-footer">
                            <div class="comp-name" id="comp-f">...</div>
                            <div class="contact-links">
                                <a id="link-phone-f" href="#" class="contact-link-item"><i class="fas fa-phone"></i> <span id="phone-f">...</span></a>
                                <a id="link-email-f" href="#" class="contact-link-item"><i class="fas fa-envelope"></i> <span id="email-f">...</span></a>
                                <a id="link-web-f" href="#" target="_blank" class="contact-link-item"><i class="fas fa-globe"></i> <span id="web-f">...</span></a>
                            </div>
                            <div class="address-lines">
                                <a id="link-addr1-f" href="#" target="_blank" class="addr-item">
                                    <i class="fas fa-map-marker-alt"></i> <span id="addr1-f">...</span>
                                </a>
                                <a id="link-addr2-f" href="#" target="_blank" class="addr-item">
                                    <i class="fas fa-warehouse"></i> <span id="addr2-f">...</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-2 w-full lg:hidden"></div>

            <div class="card-scaler-wrap">
                <div class="bizcard-frame">
                    <div id="card-back" class="bizcard" style="background-image: url('')">
                        <div class="card-top">
                             <a id="link-logo-b" href="#" target="_blank"><img id="logo-b" src="" class="card-logo" alt="Logo"></a>
                             <a id="link-qr-b" href="#" target="_blank"><div id="qr-b" class="qr-area"></div></a>
                        </div>

                        <div class="card-body">
                            <div class="services-wrapper">
                                <div class="services-title">Lĩnh vực hoạt động</div>
                                <div class="service-grid">
                                    <div id="biz1" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                    <div id="biz2" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                    <div id="biz3" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                    <div id="biz4" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                    <div id="biz5" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                    <div id="biz6" class="service-item"><i class="fas fa-check-circle"></i><span>...</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer">
                            <div class="comp-name" id="comp-b">...</div>
                            <div class="contact-links">
                                <a id="link-phone-b" href="#" class="contact-link-item"><i class="fas fa-phone"></i> <span id="phone-b">...</span></a>
                                <a id="link-email-b" href="#" class="contact-link-item"><i class="fas fa-envelope"></i> <span id="email-b">...</span></a>
                                <a id="link-web-b" href="#" target="_blank" class="contact-link-item"><i class="fas fa-globe"></i> <span id="web-b">...</span></a>
                            </div>
                            <div class="address-lines">
                                <a id="link-addr1-b" href="#" target="_blank" class="addr-item">
                                    <i class="fas fa-map-marker-alt"></i> <span id="addr1-b">...</span>
                                </a>
                                <a id="link-addr2-b" href="#" target="_blank" class="addr-item">
                                    <i class="fas fa-warehouse"></i> <span id="addr2-b">...</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-grid mb-8">
            <button onclick="toggleChat()" class="btn-action bg-green-600 hover:bg-green-700 btn-item btn-item-main">
                <i class="fas fa-comments"></i> TƯ VẤN NGAY
            </button>
            <button onclick="shareLink()" class="btn-action bg-blue-600 hover:bg-blue-700 btn-item btn-item-sub">
                <i class="fas fa-share-nodes"></i> Chia sẻ
            </button>
            <button onclick="downloadVCard()" class="btn-action bg-amber-600 hover:bg-amber-700 btn-item btn-item-sub">
                <i class="fas fa-address-book"></i> Danh bạ
            </button>
            <button onclick="exportPNG()" class="btn-action bg-slate-700 hover:bg-slate-800 btn-item btn-item-sub">
                <i class="fas fa-download"></i> Tải PNG
            </button>
            <button onclick="exportPDF()" class="btn-action bg-red-700 hover:bg-red-800 btn-item btn-item-sub">
                <i class="fas fa-file-pdf"></i> Tải PDF
            </button>
        </div>

        <div id="interaction-panel" class="hidden w-full max-w-5xl glass-panel animate-fade-in-up mb-10 mx-2">
            <div class="chat-sidebar w-full md:w-1/3">
                <button onclick="toggleChat()" class="absolute top-4 left-4 md:hidden text-white/80"><i class="fas fa-chevron-left"></i></button>
                <div class="relative mb-4">
                    <img id="bot-avatar" src="" class="secretary-avatar">
                    <span class="absolute bottom-2 right-2 w-4 h-4 bg-green-500 border-2 border-white rounded-full animate-pulse"></span>
                </div>
                <h3 id="bot-name" class="text-xl font-bold">...</h3>
                <p id="bot-pos" class="text-xs uppercase tracking-widest opacity-80 mb-2">...</p>
                
                <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm text-sm italic border border-white/20">
                    "Chào anh/chị ❤️<br>Em luôn ở đây để hỗ trợ anh/chị kết nối với công ty NECS nhanh nhất ạ!"
                </div>
            </div>

            <div class="chat-main w-full md:w-2/3 relative">
                <button onclick="toggleChat()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 hidden md:block z-20"><i class="fas fa-times text-xl"></i></button>

                <div id="form-container" class="flex flex-col h-full p-6 overflow-y-auto">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Để lại thông tin tư vấn</h3>
                    <form id="lead-form" class="space-y-3 flex-grow">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" name="name" placeholder="Họ tên *" required class="w-full p-2 bg-gray-50 border rounded text-sm">
                            <input type="text" name="company" placeholder="Công ty" class="w-full p-2 bg-gray-50 border rounded text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="tel" name="phone" placeholder="SĐT *" required class="w-full p-2 bg-gray-50 border rounded text-sm">
                            <input type="email" name="email" placeholder="Email" class="w-full p-2 bg-gray-50 border rounded text-sm">
                        </div>
                        <textarea name="message" rows="3" placeholder="Lời nhắn..." class="w-full p-2 bg-gray-50 border rounded text-sm"></textarea>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="wantChat" name="chat" checked class="accent-green-600 w-4 h-4">
                            <label for="wantChat" class="text-xs text-gray-700 font-bold">Chat ngay sau khi gửi</label>
                        </div>
                        <button type="submit" class="w-full bg-green-700 text-white py-3 rounded font-bold uppercase text-sm mt-auto">Gửi & Bắt đầu</button>
                    </form>
                </div>

                <div id="chat-window" class="hidden flex-col h-full">
                    <div id="chat-history" class="flex-grow overflow-y-auto p-4 bg-slate-50 flex flex-col"></div>
                    <div class="p-3 bg-white border-t flex gap-2">
                        <input id="chat-input" type="text" placeholder="Nhập tin nhắn..." class="flex-grow p-2 bg-gray-100 rounded-full text-sm outline-none">
                        <button onclick="sendChatMessage()" class="w-9 h-9 bg-green-600 text-white rounded-full flex items-center justify-center"><i class="fas fa-paper-plane text-xs"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: "vi", layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false }, "google_translate_element");
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        // CONFIG
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw_Ih8E_HgzASgrFb1COnArwG18Xb-59AkDDHApWJir2x62mETjuBERXl9-IHoXrOViIA/exec'; 

        let configData = null;
        let bizData = null;
        let chatHistory = [];
        let currentQRLink = "";

        // --- 1. SUPER SCALE MOBILE (Fix: 100% Width) ---
        function resizeCards() {
            const isMobile = window.innerWidth < 768;
            // FIX #1: Mobile padding = 0 tuyệt đối để full width
            const padding = isMobile ? 0 : 32; 
            const screenW = window.innerWidth - padding; 
            const cardBaseW = 500; 
            
            // Tính toán tỷ lệ scale
            let scale = Math.min(screenW / cardBaseW, 1);

            const frames = document.querySelectorAll('.bizcard-frame');
            frames.forEach(frame => {
                frame.style.transform = `scale(${scale})`;
                // Điều chỉnh height container cha để không bị khoảng trắng thừa
                frame.parentElement.style.height = `${300 * scale}px`;
                frame.parentElement.style.width = `${500 * scale}px`; 
            });
        }
        window.addEventListener('resize', resizeCards);
        window.addEventListener('load', resizeCards);

        // --- 2. EXPORT (FORCE DESKTOP VIEW) ---
        async function captureCard(type) {
            const frames = document.querySelectorAll('.bizcard-frame');
            const originalStyles = [];
            frames.forEach(f => {
                originalStyles.push(f.style.transform);
                f.style.transform = 'scale(1)'; 
            });

            const captureElement = document.getElementById('capture-area');
            
            try {
                const canvas = await html2canvas(captureElement, { 
                    scale: 4, 
                    useCORS: true, 
                    backgroundColor: null,
                    windowWidth: 1200 
                });

                if (type === 'png') {
                    const link = document.createElement('a');
                    link.download = `${bizData.bizcardPersonName}_Bizcard.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else if (type === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('l', 'mm', 'a4');
                    const pdfW = pdf.internal.pageSize.getWidth();
                    const pdfH = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const ratio = imgProps.width / imgProps.height;
                    const renderW = pdfW - 20; 
                    const renderH = renderW / ratio;
                    const yPos = (renderH < (pdfH-20)) ? (pdfH - renderH) / 2 : 10;
                    pdf.addImage(imgData, 'JPEG', 10, yPos, renderW, renderH);
                    pdf.save(`${bizData.bizcardPersonName}_Bizcard.pdf`);
                }
            } catch (err) { alert("Lỗi xuất file!"); } 
            finally { frames.forEach((f, index) => { f.style.transform = originalStyles[index]; }); }
        }
        function exportPNG() { captureCard('png'); }
        function exportPDF() { captureCard('pdf'); }

        // --- 3. DATA LOGIC ---
        async function init() {
            try {
                const response = await fetch(`${GAS_WEB_APP_URL}?action=getData`);
                const result = await response.json();
                configData = result.config;
                bizData = result.biz;
                applyData();
            } catch (err) { console.error("API Error", err); }
        }

        function applyData() {
            if (!bizData) return;
            document.body.classList.remove('loading-mode');

            document.title = bizData.htmlTitle;
            document.getElementById('favicon').href = bizData.htmlFavicon;
            const r = document.documentElement.style;
            r.setProperty('--primary', bizData.primaryColor);
            r.setProperty('--secondary', bizData.secondaryColor);
            r.setProperty('--text', bizData.textColor);
            r.setProperty('--font', bizData.fontFamily);

            const vid = document.getElementById('bg-video');
            vid.src = bizData.backgroundVideo;
            // FIX #4: Gán poster bằng ảnh nền thẻ để làm placeholder khi load
            vid.poster = bizData.bizcardBackgroundImage1;
            vid.style.backgroundColor = bizData.backgroundColor;
            
            setText('intro-name', bizData.bizcardPersonName);
            setText('intro-pos', bizData.bizcardPersonPosition);

            setBg('card-front', bizData.bizcardBackgroundImage1);
            setSrc('logo-f', bizData.bizcardLogoURL);
            setLink('link-logo-f', bizData.bizcardPompanyWebsite); 
            
            setText('name-f', bizData.bizcardPersonName);
            setText('pos-f', bizData.bizcardPersonPosition);
            
            setText('comp-f', bizData.bizcardCompanyName);
            
            setText('phone-f', bizData.bizcardPersonMobile);
            setLink('link-phone-f', `tel:${bizData.bizcardPersonMobile}`);
            
            setText('email-f', bizData.bizcardPersonEmail);
            setLink('link-email-f', `mailto:${bizData.bizcardPersonEmail}`);
            
            setText('web-f', bizData.bizcardPompanyWebsite.replace('https://',''));
            setLink('link-web-f', bizData.bizcardPompanyWebsite);
            
            setText('addr1-f', bizData.bizcardCompanyAddress);
            setLink('link-addr1-f', bizData.bizcardCompanyAddressURL);
            
            setText('addr2-f', bizData.bizcardCompanyAddress2);
            setLink('link-addr2-f', bizData.bizcardCompanyAddress2URL);

            const socials = document.getElementById('socials-f');
            socials.innerHTML = '';
            // MÀU THƯƠNG HIỆU
            const links = [
                { u: bizData.bizcardLinkZalo, i: 'fas fa-comment-dots', c: '#0068FF' }, 
                { u: bizData.bizcardLinkWhatsapp, i: 'fab fa-whatsapp', c: '#25D366' }, 
                { u: bizData.bizcardLinkViber, i: 'fab fa-viber', c: '#7360f2' }, 
                { u: bizData.bizcardLinkWechat, i: 'fab fa-weixin', c: '#7BB32E' } 
            ];
            
            links.forEach(l => {
                if(l.u) {
                    const a = document.createElement('a');
                    a.href = l.u; 
                    a.target = "_blank"; 
                    a.className = "social-icon";
                    a.innerHTML = `<i class="${l.i}" style="color: ${l.c}"></i>`;
                    a.onclick = () => updateQR(l.u, null);
                    socials.appendChild(a);
                }
            });

            setBg('card-back', bizData.bizcardBackgroundImage2);
            setSrc('logo-b', bizData.bizcardLogoURL);
            setLink('link-logo-b', bizData.bizcardPompanyWebsite);

            for(let i=1; i<=6; i++) setHTML(`biz${i}`, `<i class="fas fa-check-circle"></i><span>${bizData[`bizcardBusiness${i}`]}</span>`);

            setText('comp-b', bizData.bizcardCompanyName);
            setText('phone-b', bizData.bizcardPersonMobile);
            setLink('link-phone-b', `tel:${bizData.bizcardPersonMobile}`);
            setText('email-b', bizData.bizcardPersonEmail);
            setLink('link-email-b', `mailto:${bizData.bizcardPersonEmail}`);
            setText('web-b', bizData.bizcardPompanyWebsite.replace('https://',''));
            setLink('link-web-b', bizData.bizcardPompanyWebsite);
            setText('addr1-b', bizData.bizcardCompanyAddress);
            setLink('link-addr1-b', bizData.bizcardCompanyAddressURL);
            setText('addr2-b', bizData.bizcardCompanyAddress2);
            setLink('link-addr2-b', bizData.bizcardCompanyAddress2URL);

            setText('bot-name', bizData.chatbotName);
            setText('bot-pos', bizData.chatbotPosition);
            setSrc('bot-avatar', bizData.chatbotAvatar);

            currentQRLink = bizData.bizcardQRText || window.location.href;
            updateQR(currentQRLink, bizData.bizcardQRImage);

            setTimeout(resizeCards, 100);
        }

        function setText(id, t) { const el = document.getElementById(id); if(el) el.innerText = t || ''; }
        function setHTML(id, h) { const el = document.getElementById(id); if(el) el.innerHTML = h || ''; }
        function setSrc(id, s) { const el = document.getElementById(id); if(el) el.src = s || ''; }
        function setLink(id, h) { const el = document.getElementById(id); if(el) el.href = h || '#'; }
        function setBg(id, u) { document.getElementById(id).style.backgroundImage = `url('${u}')`; }
        
        function updateQR(text, imgUrl) {
            currentQRLink = text;
            setLink('link-qr-f', text);
            setLink('link-qr-b', text);

            ['qr-f', 'qr-b'].forEach(id => {
                const box = document.getElementById(id);
                box.innerHTML = '';
                if(imgUrl && imgUrl.includes('.')) {
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.onerror = () => new QRCode(box, { text: text, width: 68, height: 68 });
                    box.appendChild(img);
                } else {
                    new QRCode(box, { text: text, width: 68, height: 68 });
                }
            });
        }

        function toggleChat() {
            const p = document.getElementById('interaction-panel');
            p.classList.toggle('hidden');
            if(!p.classList.contains('hidden')) p.scrollIntoView({behavior:'smooth'});
        }

        function shareLink() {
            if(navigator.share) navigator.share({title: document.title, url: location.href});
            else prompt("Link:", location.href);
        }

        function downloadVCard() {
             const vCard = `BEGIN:VCARD
VERSION:3.0
FN:${bizData.bizcardPersonName}
ORG:${bizData.bizcardCompanyName}
TITLE:${bizData.bizcardPersonPosition}
TEL;TYPE=WORK,VOICE:${bizData.bizcardPersonMobile}
EMAIL:${bizData.bizcardPersonEmail}
URL:${bizData.bizcardPompanyWebsite}
ADR;TYPE=WORK:;;${bizData.bizcardCompanyAddress}
END:VCARD`;
            const blob = new Blob([vCard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${bizData.bizcardPersonName}.vcf`;
            a.click();
        }

        document.getElementById('lead-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const old = btn.innerText;
            btn.disabled = true; btn.innerText = "ĐANG GỬI...";
            
            const fd = new FormData(e.target);
            const payload = {
                action: 'submitForm',
                name: fd.get('name'), company: fd.get('company'),
                phone: fd.get('phone'), email: fd.get('email'),
                message: fd.get('message'), chat: document.getElementById('wantChat').checked
            };

            try {
                const res = await fetch(GAS_WEB_APP_URL, {method:'POST', body: JSON.stringify(payload)});
                const data = await res.json();
                if(payload.chat) {
                    document.getElementById('form-container').classList.add('hidden');
                    document.getElementById('chat-window').classList.remove('hidden');
                    document.getElementById('chat-window').classList.add('flex');
                    appendMsg('user', payload.message || `Xin chào ${bizData.chatbotName}`);
                    appendMsg('bot', data.botResponse || `Chào anh/chị ${payload.name}, em giúp gì được cho mình ạ?`);
                } else {
                    alert("Gửi thành công!"); toggleChat();
                }
            } catch(e) { alert("Lỗi kết nối!"); } 
            finally { btn.disabled = false; btn.innerText = old; }
        };

        function appendMsg(role, text) {
            const box = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role==='user'?'chat-bubble-user':'chat-bubble-bot'}`;
            div.innerHTML = role==='bot' ? marked.parse(text) : text;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
            chatHistory.push({role: role==='user'?'user':'assistant', content: text});
        }

        async function sendChatMessage() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;
            appendMsg('user', txt); inp.value = '';
            
            const box = document.getElementById('chat-history');
            const loader = document.createElement('div');
            loader.id = 'chat-loader';
            loader.className = 'chat-bubble chat-bubble-bot text-xs italic text-gray-400';
            loader.innerText = `${bizData.chatbotName} đang soạn...`;
            box.appendChild(loader); box.scrollTop = box.scrollHeight;

            try {
                const res = await fetch(GAS_WEB_APP_URL, {method:'POST', body: JSON.stringify({action:'chat', messages: chatHistory})});
                const data = await res.json();
                document.getElementById('chat-loader').remove();
                appendMsg('bot', data.response || "Lỗi phản hồi.");
            } catch(e) {
                document.getElementById('chat-loader').remove();
                appendMsg('bot', "Mất kết nối.");
            }
        }
        document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key==='Enter') sendChatMessage(); });

        init();
    </script>
</body>
</html>