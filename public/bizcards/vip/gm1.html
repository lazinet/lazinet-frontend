<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p-color: #187752; --s-color: #B91C1C; --t-color: #FF6300; --font: 'Tahoma', sans-serif; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font); overflow-x: hidden; background: #fafafa; }
        
        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: -1; }

        .wrapper { max-width: 1100px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; display: flex; justify-content: space-between; align-items: flex-start; color: #fff; margin-bottom: 30px; }
        .intro-txt { max-width: 70%; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .lang-btn { background: rgba(255,255,255,0.25); border: 1px solid #fff; color: #fff; padding: 6px 12px; cursor: pointer; border-radius: 4px; }

        .bizcard-container { display: flex; gap: 30px; width: 100%; justify-content: center; margin-bottom: 40px; }
        .card-box { 
            width: 500px; aspect-ratio: 90/54; background: #fff; border-radius: 10px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); position: relative; overflow: hidden;
            background-size: cover; background-position: center;
        }

        /* Card Interior */
        .card-content { padding: 5%; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }
        .card-logo { height: 18%; margin-bottom: 15px; object-fit: contain; align-self: flex-start; }
        .c-name { font-size: 1.6rem; font-weight: bold; color: var(--p-color); }
        .c-pos { font-size: 1rem; color: var(--s-color); margin-bottom: 10px; }
        .c-info { font-size: 0.85rem; margin-top: auto; line-height: 1.6; }
        .c-info div { display: flex; align-items: center; gap: 8px; color: #333; }

        .back-grid { display: grid; grid-template-columns: 1.2fr 1fr; height: 100%; padding: 5%; gap: 15px; }
        .biz-list { font-size: 0.8rem; line-height: 1.8; color: #333; }
        .qr-side { display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid #eee; }
        .qr-img { width: 100px; height: 100px; border: 4px solid #fff; }

        .action-bar { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .btn { 
            padding: 12px 20px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 8px; transition: 0.3s; background: var(--p-color); color: #fff;
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }

        /* Modal & Form */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 999; padding: 15px; }
        .modal-body { background: #fff; width: 100%; max-width: 450px; border-radius: 15px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-m { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }

        /* Chat Window */
        #chat-box { display: none; flex-direction: column; height: 450px; }
        .messages { flex: 1; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .msg { margin: 8px 0; padding: 10px; border-radius: 10px; max-width: 85%; font-size: 0.9rem; }
        .bot { background: #e2f3ed; align-self: flex-start; }
        .user { background: var(--p-color); color: #fff; align-self: flex-end; margin-left: auto; }
        
        .bot-profile { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--p-color); }
        .status-on { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; }

        /* Mobile */
        @media (max-width: 850px) {
            .bizcard-container { flex-direction: column; align-items: center; }
            .card-box { width: 100%; }
            header { flex-direction: column; align-items: center; text-align: center; gap: 15px; }
        }
    </style>
</head>
<body>

    <video autoplay muted loop id="bg-video"><source id="v-src" src="" type="video/mp4"></video>
    <div class="overlay"></div>

    <div class="wrapper">
        <header>
            <div class="intro-txt">
                <h1 id="h-title">...</h1>
                <p id="h-desc">Hân hạnh được hợp tác cùng Quý khách!</p>
            </div>
            <button class="lang-btn" onclick="alert('Language toggled')">Tiếng Việt <i class="fas fa-chevron-down"></i></button>
        </header>

        <div class="bizcard-container" id="capture-zone">
            <div class="card-box" id="card-f-bg">
                <div class="card-content">
                    <img src="" class="card-logo" id="l-f">
                    <div class="c-name" id="n-f">...</div>
                    <div class="c-pos" id="p-f">...</div>
                    <div class="c-info">
                        <div><i class="fas fa-phone"></i> <span id="ph-f"></span></div>
                        <div><i class="fas fa-envelope"></i> <span id="em-f"></span></div>
                        <div><i class="fas fa-globe"></i> <span id="wb-f"></span></div>
                    </div>
                </div>
            </div>
            <div class="card-box" id="card-b-bg">
                <div class="back-grid">
                    <div class="biz-list">
                        <img src="" style="height:35px; margin-bottom:10px;" id="l-b">
                        <div style="font-weight:bold; color:var(--p-color); font-size:0.75rem;">DỊCH VỤ CỐT LÕI:</div>
                        <ul id="b-items" style="padding-left:15px;"></ul>
                    </div>
                    <div class="qr-side">
                        <img src="" class="qr-img" id="qr">
                        <span style="font-size:0.6rem; margin-top:5px; color:#666;">SCAN TO CONNECT</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn" onclick="openModal()"><i class="fas fa-comments"></i> CHAT</button>
            <button class="btn" onclick="share()"><i class="fas fa-share"></i> SHARE</button>
            <button class="btn" onclick="download('png')"><i class="fas fa-image"></i> PNG</button>
            <button class="btn" onclick="download('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
            <button class="btn" onclick="download('vcf')"><i class="fas fa-address-book"></i> vCARD</button>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-body">
            <span class="close-m" onclick="closeModal()">&times;</span>
            
            <div id="contact-form">
                <div class="bot-profile">
                    <img src="" class="avatar" id="bot-avt">
                    <div>
                        <strong id="bot-n">...</strong> <span class="status-on"></span><br>
                        <small id="bot-p">...</small>
                    </div>
                </div>
                <h3>Để lại lời nhắn</h3>
                <input type="text" id="f-name" placeholder="Họ và tên">
                <input type="text" id="f-comp" placeholder="Công ty">
                <input type="text" id="f-phone" placeholder="Số điện thoại">
                <input type="email" id="f-email" placeholder="Email">
                <textarea id="f-msg" rows="3" placeholder="Nội dung cần tư vấn..."></textarea>
                <label style="font-size:0.85rem;"><input type="checkbox" id="f-chat" checked> Muốn tư vấn trực tiếp qua Chatbot</label>
                <button class="btn" style="width:100%; margin-top:15px; justify-content:center;" onclick="submitForm()">GỬI THÔNG TIN</button>
            </div>

            <div id="chat-box">
                <div class="messages" id="ms-box"></div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="chat-input" placeholder="Hỏi tôi bất cứ điều gì...">
                    <button class="btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwY4SLeT9YFBV9369-mrLWpDj1KxRWDdBUbrl6QbxigC-AziHMfdQsJzrE3dzwNU8lbFQ/exec";
        let bizData = {};
        let configData = {};
        let history = [];

        async function init() {
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
                const data = await res.json();
                bizData = data.biz;
                configData = data.config;
                render();
            } catch (e) { alert("Lỗi kết nối API Backend!"); }
        }

        function render() {
            document.title = bizData.htmlTitle;
            document.documentElement.style.setProperty('--p-color', bizData.primaryColor);
            document.documentElement.style.setProperty('--s-color', bizData.secondaryColor);
            document.documentElement.style.setProperty('--t-color', bizData.textColor);
            
            document.getElementById('v-src').src = bizData.backgroundVideo;
            document.getElementById('bg-video').load();
            document.getElementById('h-title').innerText = bizData.bizcardPersonName;
            
            // Card Front
            document.getElementById('card-f-bg').style.backgroundImage = `url(${bizData.bizcardBackgroundImage1})`;
            document.getElementById('l-f').src = bizData.bizcardLogoURL;
            document.getElementById('n-f').innerText = bizData.bizcardPersonName;
            document.getElementById('p-f').innerText = bizData.bizcardPersonPosition;
            document.getElementById('ph-f').innerText = bizData.bizcardPersonMobile;
            document.getElementById('em-f').innerText = bizData.bizcardPersonEmail;
            document.getElementById('wb-f').innerText = bizData.bizcardPompanyWebsite;

            // Card Back
            document.getElementById('card-b-bg').style.backgroundImage = `url(${bizData.bizcardBackgroundImage2})`;
            document.getElementById('l-b').src = bizData.bizcardLogoURL;
            const items = [bizData.bizcardBusiness1, bizData.bizcardBusiness2, bizData.bizcardBusiness3, bizData.bizcardBusiness4, bizData.bizcardBusiness5, bizData.bizcardBusiness6];
            document.getElementById('b-items').innerHTML = items.filter(i => i).map(i => `<li>${i}</li>`).join('');
            document.getElementById('qr').src = bizData.bizcardQRImage || `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(bizData.bizcardQRText)}`;

            // Bot
            document.getElementById('bot-avt').src = bizData.chatbotAvatar;
            document.getElementById('bot-n').innerText = bizData.chatbotName;
            document.getElementById('bot-p').innerText = bizData.chatbotPosition;
        }

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        async function submitForm() {
            const payload = {
                name: document.getElementById('f-name').value,
                company: document.getElementById('f-comp').value,
                phone: document.getElementById('f-phone').value,
                email: document.getElementById('f-email').value,
                message: document.getElementById('f-msg').value,
                consult: document.getElementById('f-chat').checked
            };
            if(!payload.name || !payload.phone) return alert("Vui lòng nhập Tên và SĐT");

            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveContact', payload }) });

            if(payload.consult && configData.chatbotValidity) {
                document.getElementById('contact-form').style.display = 'none';
                document.getElementById('chat-box').style.display = 'flex';
                addMsg('bot', `Xin chào ${payload.name}! Tôi là ${bizData.chatbotName}. Dựa trên thông tin bạn vừa gửi, tôi rất sẵn lòng hỗ trợ bạn về các dịch vụ của NECS. Bạn cần tôi tư vấn chi tiết hơn về phần nào ạ?`);
            } else {
                alert("Cảm ơn bạn! Chúng tôi sẽ liên hệ lại sớm.");
                closeModal();
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;
            
            addMsg('user', txt);
            input.value = '';

            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'chat', message: txt, history }) 
            });
            const data = await res.json();
            addMsg('bot', data.reply);
            history.push({role:'user', content:txt}, {role:'assistant', content:data.reply});
        }

        function addMsg(sender, text) {
            const box = document.getElementById('ms-box');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function download(type) {
            const zone = document.getElementById('capture-zone');
            if(type === 'png') {
                const canvas = await html2canvas(zone, { scale: 3, useCORS: true });
                const link = document.createElement('a');
                link.download = 'Bizcard.png';
                link.href = canvas.toDataURL();
                link.click();
            } else if(type === 'pdf') {
                const canvas = await html2canvas(zone, { scale: 2, useCORS: true });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 280, 0);
                pdf.save('Bizcard.pdf');
            } else if(type === 'vcf') {
                const vcfData = `BEGIN:VCARD\nVERSION:3.0\nFN:${bizData.bizcardPersonName}\nORG:${bizData.bizcardCompanyName}\nTEL:${bizData.bizcardPersonMobile}\nEMAIL:${bizData.bizcardPersonEmail}\nEND:VCARD`;
                const blob = new Blob([vcfData], { type: 'text/vcard' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'contact.vcf'; a.click();
            }
        }

        function share() {
            if (navigator.share) navigator.share({ title: document.title, url: window.location.href });
            else alert("Copy link: " + window.location.href);
        }

        window.onload = init;
    </script>
</body>
</html>