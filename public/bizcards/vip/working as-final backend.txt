// https://script.google.com/macros/s/AKfycbzMMdxj3huhoglG5n6EC_BKvK4JyeWPLsxyptboXD86zxz_g6zqw7-iDbsN9ASfYVN9pQ/exec
/**
 * BACKEND FOR BIZCARD SYSTEM
 * Set this up in Google Apps Script and deploy as a Web App (Executes as me, access: anyone).
 */

const SS = SpreadsheetApp.getActiveSpreadsheet();

function doGet(e) {
  const action = e.parameter.action;
  
  if (action === 'getData') {
    return ContentService.createTextOutput(JSON.stringify(getAllData()))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  // Default: return error
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    if (action === 'submitForm') {
      return handleFormSubmission(data);
    } else if (action === 'chat') {
      return handleChat(data);
    }
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getAllData() {
  const configSheet = SS.getSheetByName('Config');
  const bizSheet = SS.getSheetByName('Bizcard');
  
  const configData = configSheet.getRange(2, 1, configSheet.getLastRow() - 1, 2).getValues();
  const bizData = bizSheet.getRange(2, 1, bizSheet.getLastRow() - 1, 2).getValues();
  
  const config = {};
  configData.forEach(row => config[row[0]] = row[1]);
  
  const biz = {};
  bizData.forEach(row => biz[row[0]] = row[1]);
  
  return { config, biz };
}

function handleFormSubmission(payload) {
  const dataSheet = SS.getSheetByName('Data');
  const timestamp = new Date();
  
  // Columns: Time, Company, Phone, Email, Message, Chat (Boolean)
  dataSheet.appendRow([
    timestamp,
    payload.company,
    payload.phone,
    payload.email,
    payload.message,
    payload.chat // This is the "Consultation" boolean
  ]);
  
  // Send Email
  const bizData = getAllData().biz;
  const subject = `Xác nhận thông tin từ ${bizData.bizcardPersonName}`;
  const body = `Chào ${payload.name},\n\nCảm ơn bạn đã quan tâm và để lại lời nhắn. Tôi sẽ sớm phản hồi lại bạn.\n\nTrân trọng,\n${bizData.bizcardPersonName}\n${bizData.bizcardPersonPosition}\n${bizData.bizcardCompanyName}`;
  
  try {
    MailApp.sendEmail(payload.email, subject, body);
  } catch (e) {
    console.log("Email error: " + e.message);
  }

  // If chat requested and valid, prepare initial bot response
  let botResponse = null;
  const config = getAllData().config;
  if (payload.chat && config.chatbotValidity === true) {
    botResponse = generateInitialGreeting(payload, bizData);
  }

  return ContentService.createTextOutput(JSON.stringify({
    success: true, 
    botResponse: botResponse
  })).setMimeType(ContentService.MimeType.JSON);
}

function generateInitialGreeting(user, biz) {
  return `Chào ${user.name}! Rất vui được gặp bạn từ công ty ${user.company}. Tôi là ${biz.chatbotName}, ${biz.chatbotPosition} của ${biz.bizcardPersonName}. Tôi đã nhận được yêu cầu tư vấn của bạn. Bạn quan tâm đến dịch vụ nào của chúng tôi? Tôi luôn sẵn sàng hỗ trợ bạn ngay đây!`;
}

function handleChat(payload) {
  const config = getAllData().config;
  const biz = getAllData().biz;
  
  if (!config.chatbotValidity) {
    return ContentService.createTextOutput(JSON.stringify({response: "Chatbot hiện đang bảo trì."})).setMimeType(ContentService.MimeType.JSON);
  }

  const model = config.llmModel;
  const apiKey = config.llmAPI;
  const systemPrompt = `${biz.chatBotGuide}\n\nThông tin chủ thể:\n${biz.personProfile}\n\nDịch vụ cung cấp:\n1. ${biz.bizcardBusiness1}\n2. ${biz.bizcardBusiness2}\n3. ${biz.bizcardBusiness3}\n4. ${biz.bizcardBusiness4}\n5. ${biz.bizcardBusiness5}\n6. ${biz.bizcardBusiness6}`;

  let responseText = "";
  
  if (model === 'Gemini') {
    responseText = callGemini(apiKey, systemPrompt, payload.messages);
  } else if (model === 'DeepSeek' || model === 'Grok') {
    responseText = callOpenAICompatible(model, apiKey, systemPrompt, payload.messages);
  }

  return ContentService.createTextOutput(JSON.stringify({response: responseText})).setMimeType(ContentService.MimeType.JSON);
}

function callGemini(key, system, history) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`;
  const contents = [
    { role: "user", parts: [{ text: "System Instructions: " + system }] },
    ...history.map(m => ({
      role: m.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: m.content }]
    }))
  ];
  
  const payload = { contents };
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());
  return json.candidates[0].content.parts[0].text;
}

function callOpenAICompatible(model, key, system, history) {
  const url = model === 'DeepSeek' ? 'https://api.deepseek.com/v1/chat/completions' : 'https://api.x.ai/v1/chat/completions';
  const payload = {
    model: model === 'DeepSeek' ? "deepseek-chat" : "grok-beta",
    messages: [
      { role: "system", content: system },
      ...history
    ],
    temperature: 0.7
  };
  
  const options = {
    method: 'post',
    headers: { "Authorization": "Bearer " + key },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());
  return json.choices[0].message.content;
}
