<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card</title>
    <!-- Google Translate -->
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Video Background */
        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
            object-fit: cover;
        }
        
        /* Business Card Dimensions */
        .bizcard {
            width: 100%;
            max-width: 450px;
            aspect-ratio: 90 / 54;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .bizcard:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        /* Social Media Buttons */
        .social-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .social-btn:hover {
            transform: scale(1.1);
        }
        
        .zalo-btn { background: #0068FF; }
        .whatsapp-btn { background: #25D366; }
        .viber-btn { background: #7360F2; }
        .wechat-btn { background: #09B83E; }
        
        /* Chat Interface */
        .chat-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        
        .chat-container.open {
            max-height: 500px;
        }
        
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            margin-bottom: 8px;
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .bot-bubble {
            background: #f1f5f9;
            color: #334155;
            border-bottom-left-radius: 4px;
        }
        
        /* Typing Animation */
        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-600 font-medium">Đang tải dữ liệu...</p>
    </div>

    <!-- Video Background -->
    <video autoplay muted loop playsinline id="bg-video"></video>
    <div id="bg-overlay" class="fixed inset-0 z-0"></div>

    <!-- Main Content -->
    <div id="main-content" class="relative z-10 min-h-screen opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 py-4 px-6">
            <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1 id="header-name" class="text-xl font-bold text-gray-800"></h1>
                    <p id="header-position" class="text-sm text-gray-600"></p>
                    <p class="text-xs text-blue-600 font-medium mt-1">
                        <i class="fas fa-handshake mr-1"></i>Hân hạnh hợp tác cùng quý khách
                    </p>
                </div>
                
                <div class="flex items-center gap-3">
                    <div id="google_translate_element"></div>
                    <div class="flex gap-1">
                        <button onclick="changeLanguage('vi')" class="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-l">VN</button>
                        <button onclick="changeLanguage('en')" class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded-r">EN</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Business Cards -->
        <main class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col lg:flex-row gap-8 items-center justify-center">
                <!-- Front Card -->
                <div class="bizcard" id="front-card">
                    <div class="absolute inset-0 bg-gradient-to-br from-white via-white to-gray-50"></div>
                    <img id="front-bg" class="absolute inset-0 w-full h-full object-cover opacity-10" src="" alt="" crossorigin="anonymous">
                    
                    <div class="relative z-10 h-full p-6 flex flex-col">
                        <!-- Logo and QR -->
                        <div class="flex justify-between items-start mb-4">
                            <img id="front-logo" class="h-10 object-contain" src="" alt="Logo" crossorigin="anonymous" onerror="this.style.display='none'">
                            <div id="front-qr" class="w-20 h-20 bg-white p-1 rounded shadow-md"></div>
                        </div>
                        
                        <!-- Person Info -->
                        <div class="flex-grow">
                            <h2 id="front-name" class="text-2xl font-bold text-gray-800 mb-1"></h2>
                            <p id="front-position" class="text-sm text-blue-600 font-semibold mb-1"></p>
                            <p id="front-company" class="text-sm text-gray-600 font-medium mb-6"></p>
                            
                            <!-- Social Media -->
                            <div class="flex gap-2 mb-6" id="social-buttons">
                                <!-- Social buttons will be added dynamically -->
                            </div>
                            
                            <!-- Contact Info -->
                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-phone text-xs text-gray-500"></i>
                                    <a id="front-phone" href="#" class="text-sm text-gray-700 hover:text-blue-600"></a>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-envelope text-xs text-gray-500"></i>
                                    <a id="front-email" href="#" class="text-sm text-gray-700 hover:text-blue-600"></a>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-globe text-xs text-gray-500"></i>
                                    <a id="front-website" href="#" target="_blank" class="text-sm text-gray-700 hover:text-blue-600"></a>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-building text-xs text-gray-500 mt-1"></i>
                                    <a id="front-address1" href="#" target="_blank" class="text-xs text-gray-600 hover:text-blue-600"></a>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-warehouse text-xs text-gray-500 mt-1"></i>
                                    <a id="front-address2" href="#" target="_blank" class="text-xs text-gray-600 hover:text-blue-600"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Back Card -->
                <div class="bizcard" id="back-card">
                    <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900"></div>
                    <img id="back-bg" class="absolute inset-0 w-full h-full object-cover opacity-20" src="" alt="" crossorigin="anonymous">
                    
                    <div class="relative z-10 h-full p-6 flex flex-col text-white">
                        <!-- Logo and QR -->
                        <div class="flex justify-between items-start mb-6">
                            <img id="back-logo" class="h-8 object-contain invert brightness-0" src="" alt="Logo" crossorigin="anonymous" onerror="this.style.display='none'">
                            <div id="back-qr" class="w-16 h-16 bg-white p-1 rounded"></div>
                        </div>
                        
                        <!-- Services -->
                        <div class="flex-grow">
                            <h3 class="text-center text-lg font-bold mb-4">DỊCH VỤ CUNG CẤP</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <ul id="services-col1" class="space-y-2 text-xs">
                                    <!-- Services will be added dynamically -->
                                </ul>
                                <ul id="services-col2" class="space-y-2 text-xs">
                                    <!-- Services will be added dynamically -->
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Footer Contact -->
                        <div class="mt-4 pt-4 border-t border-white/20">
                            <div class="flex flex-wrap justify-center gap-3 text-[10px]">
                                <span id="back-phone"></span>
                                <span class="opacity-50">|</span>
                                <span id="back-email"></span>
                                <span class="opacity-50">|</span>
                                <span id="back-website"></span>
                            </div>
                            <p id="back-address" class="text-[9px] text-center mt-2 opacity-70"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Function Buttons -->
            <div class="mt-8 grid grid-cols-2 md:grid-cols-5 gap-3 max-w-2xl mx-auto">
                <button onclick="openChatForm()" class="col-span-2 md:col-span-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl shadow-lg hover:shadow-xl transition flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-comments text-lg"></i>
                    <span class="text-xs font-bold uppercase">Chat AI</span>
                </button>
                
                <button onclick="shareCard()" class="bg-white text-gray-700 py-3 rounded-xl shadow hover:bg-gray-50 flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-share-alt text-lg"></i>
                    <span class="text-xs font-bold">Share</span>
                </button>
                
                <button onclick="exportCard('png')" class="bg-white text-gray-700 py-3 rounded-xl shadow hover:bg-gray-50 flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-image text-lg"></i>
                    <span class="text-xs font-bold">PNG</span>
                </button>
                
                <button onclick="downloadVCard()" class="bg-white text-gray-700 py-3 rounded-xl shadow hover:bg-gray-50 flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-address-card text-lg"></i>
                    <span class="text-xs font-bold">vCard</span>
                </button>
                
                <button onclick="exportCard('pdf')" class="bg-white text-gray-700 py-3 rounded-xl shadow hover:bg-gray-50 flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-file-pdf text-lg"></i>
                    <span class="text-xs font-bold">PDF</span>
                </button>
            </div>

            <!-- Chat/Form Section -->
            <div id="chat-section" class="chat-container mt-8 max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <!-- Contact Form -->
                    <div id="contact-form" class="p-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="relative">
                                <img id="chatbot-avatar" class="w-16 h-16 rounded-full object-cover border-4 border-white shadow" src="" alt="" crossorigin="anonymous">
                                <span class="absolute bottom-1 right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></span>
                            </div>
                            <div>
                                <h3 id="chatbot-name" class="font-bold text-lg text-gray-800"></h3>
                                <p id="chatbot-position" class="text-sm text-gray-600"></p>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-clock mr-1"></i>Online - Sẵn sàng hỗ trợ
                                </p>
                            </div>
                        </div>
                        
                        <form id="contact-form-element" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Họ tên *</label>
                                    <input type="text" id="form-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Công ty</label>
                                    <input type="text" id="form-company" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">SĐT *</label>
                                    <input type="tel" id="form-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <input type="email" id="form-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nội dung</label>
                                <textarea id="form-message" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Tôi cần tư vấn về..."></textarea>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="form-consult" checked class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                <label for="form-consult" class="text-sm text-gray-700">Muốn được tư vấn thêm qua chatbot</label>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition">
                                    GỬI THÔNG TIN
                                </button>
                                <button type="button" onclick="closeChatForm()" class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50">
                                    HỦY
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Chat Interface -->
                    <div id="chat-interface" class="hidden flex-col h-[400px]">
                        <div class="flex-1 p-4 overflow-y-auto bg-gray-50" id="chat-messages">
                            <div class="chat-bubble bot-bubble">
                                Xin chào! Tôi là <span id="chat-bot-name"></span>, <span id="chat-bot-pos"></span>. Tôi có thể giúp gì cho bạn?
                            </div>
                        </div>
                        
                        <div class="p-4 bg-white border-t flex gap-2">
                            <input type="text" id="chat-input" placeholder="Nhập câu hỏi của bạn..." class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <button onclick="sendChatMessage()" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Export Container (hidden) -->
    <div id="export-container" class="fixed top-0 left-0 -z-50 opacity-0 pointer-events-none"></div>

    <script>
        // Configuration
        let CONFIG = {};
        let currentSocialQR = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbydsAeeXp9VVBKPsrkhITuJkIWU7zC0-s018HqU46Vg7DhzBHuBzAHVWz2Kr-1iJGeqtQ/exec'; // Thay bằng URL Web App của bạn
        
        // CORS Proxy để tránh lỗi khi chạy từ localhost
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const USE_PROXY = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
        
        // Helper function để gọi API với CORS handling
        async function callAPI(action, payload = null) {
            const url = USE_PROXY ? `${CORS_PROXY}${API_URL}` : API_URL;
            
            try {
                // Sử dụng GET để tránh CORS preflight
                let requestUrl = `${url}?action=${action}`;
                if (payload) {
                    requestUrl += `&payload=${encodeURIComponent(JSON.stringify(payload))}`;
                }
                
                // Thêm timestamp để tránh cache
                requestUrl += `&_t=${Date.now()}`;
                
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error(`API call failed for ${action}:`, error);
                
                // Thử dùng JSONP nếu fetch thất bại
                return callAPIWithJSONP(action, payload);
            }
        }
        
        // Fallback: Sử dụng JSONP nếu CORS vẫn lỗi
        function callAPIWithJSONP(action, payload = null) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_callback_${Date.now()}`;
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };
                
                let url = `${API_URL}?action=${action}&callback=${callbackName}`;
                if (payload) {
                    url += `&payload=${encodeURIComponent(JSON.stringify(payload))}`;
                }
                
                script.src = url;
                script.onerror = () => {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONP request failed'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Initialize
        window.onload = async () => {
            try {
                const result = await callAPI('getConfig');
                
                if (result.status === 'success') {
                    CONFIG = result.data;
                    initializePage();
                } else {
                    alert('Lỗi tải dữ liệu: ' + (result.message || 'Không rõ'));
                }
            } catch (error) {
                console.error('Load error:', error);
                
                // Thử load dữ liệu mẫu nếu không kết nối được
                loadSampleData();
                alert('Không thể kết nối đến server. Đang sử dụng dữ liệu mẫu.');
            }
        };

        function initializePage() {
            // Set favicon
            const favicon = document.createElement('link');
            favicon.rel = 'icon';
            favicon.href = CONFIG.htmlFavicon || 'https://lazinet.com/assets/img/logo-lazinet/lazinet_LogoOnly.ico';
            document.head.appendChild(favicon);

            // Set title
            document.title = CONFIG.htmlTitle || 'Business Card';

            // Set font family
            document.body.style.fontFamily = CONFIG.fontFamily || 'Tahoma, Arial, sans-serif';

            // Set colors
            const root = document.documentElement;
            const primaryColor = CONFIG.primaryColor || '#187752';
            const secondaryColor = CONFIG.secondaryColor || '#B91C1C';
            const textColor = CONFIG.textColor || '#FF6300';
            
            root.style.setProperty('--primary-color', primaryColor);
            root.style.setProperty('--secondary-color', secondaryColor);
            root.style.setProperty('--text-color', textColor);

            // Set video background
            const video = document.getElementById('bg-video');
            const videoUrl = CONFIG.backgroundVideo || 'https://lazinet.com/assets/videos/Wms-01.mp4';
            video.src = videoUrl;
            video.poster = CONFIG.bizcardBackgroundImage1 || '';
            
            // Set overlay color
            document.getElementById('bg-overlay').style.backgroundColor = CONFIG.backgroundColor || '#FAFAFA';

            // Update header
            document.getElementById('header-name').textContent = CONFIG.bizcardPersonName || 'Lê Minh Phụng';
            document.getElementById('header-position').textContent = 
                `${CONFIG.bizcardPersonPosition || 'Phó Tổng Giám đốc'} - ${CONFIG.bizcardCompanyName || 'NECS'}`;

            // Render front card
            renderFrontCard();
            
            // Render back card
            renderBackCard();
            
            // Update chatbot info
            document.getElementById('chatbot-name').textContent = CONFIG.chatbotName || 'Mai Anh Đào';
            document.getElementById('chatbot-position').textContent = CONFIG.chatbotPosition || 'Thư ký PTGĐ';
            document.getElementById('chatbot-avatar').src = CONFIG.chatbotAvatar || 'https://lazinet.com/assets/img/avatars/lady02.jpg';
            document.getElementById('chat-bot-name').textContent = CONFIG.chatbotName || 'Mai Anh Đào';
            document.getElementById('chat-bot-pos').textContent = CONFIG.chatbotPosition || 'Thư ký PTGĐ';

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-content').style.opacity = '1';
                
                // Auto-play video
                video.play().catch(e => console.log('Video autoplay failed:', e));
            }, 500);
        }

        function renderFrontCard() {
            // Set background
            const frontBgUrl = CONFIG.bizcardBackgroundImage1 || 'https://lazinet.com/assets/img/background/LAZINET_BG_001_W2048.webp';
            document.getElementById('front-bg').src = frontBgUrl;
            
            // Set logo
            const logoUrl = CONFIG.bizcardLogoURL || 'https://necs.vn/wp-content/uploads/2021/06/necs-log-vi.svg';
            document.getElementById('front-logo').src = logoUrl;
            
            // Set QR code
            const qrDiv = document.getElementById('front-qr');
            qrDiv.innerHTML = '';
            if (CONFIG.bizcardQRImage && CONFIG.bizcardQRImage.trim() !== '') {
                const img = document.createElement('img');
                img.src = CONFIG.bizcardQRImage;
                img.className = 'w-full h-full object-contain';
                img.onerror = () => generateTextQR(qrDiv);
                qrDiv.appendChild(img);
                currentSocialQR = CONFIG.bizcardQRImage;
            } else {
                generateTextQR(qrDiv);
            }
            
            // Set person info
            document.getElementById('front-name').textContent = CONFIG.bizcardPersonName || 'Lê Minh Phụng';
            document.getElementById('front-position').textContent = CONFIG.bizcardPersonPosition || 'Phó Tổng Giám đốc';
            document.getElementById('front-company').textContent = CONFIG.bizcardCompanyName || 'Công ty Cổ phần Kho Lạnh Kỷ Nguyên Mới (NECS)';
            
            // Set contact info
            const phone = CONFIG.bizcardPersonMobile || '0901494666';
            const email = CONFIG.bizcardPersonEmail || 'phunglm@necs.vn';
            const website = CONFIG.bizcardPompanyWebsite || 'https://necs.vn';
            const address1 = CONFIG.bizcardCompanyAddress || 'Lầu 8, 262 Nam Kỳ Khởi Nghĩa, phường Xuân Hòa, TP.HCM';
            const address2 = CONFIG.bizcardCompanyAddress2 || 'B28-2 Đường Dọc 2, KCN Phú An Thạnh, Bến Lức, Long An';
            
            document.getElementById('front-phone').textContent = phone;
            document.getElementById('front-phone').href = `tel:${phone}`;
            document.getElementById('front-email').textContent = email;
            document.getElementById('front-email').href = `mailto:${email}`;
            document.getElementById('front-website').textContent = website.replace(/^https?:\/\//, '');
            document.getElementById('front-website').href = website;
            document.getElementById('front-address1').textContent = address1;
            document.getElementById('front-address1').href = CONFIG.bizcardCompanyAddressURL || '#';
            document.getElementById('front-address2').textContent = address2;
            document.getElementById('front-address2').href = CONFIG.bizcardCompanyAddress2URL || '#';
            
            // Create social media buttons
            const socialButtons = document.getElementById('social-buttons');
            socialButtons.innerHTML = '';
            
            const socialLinks = [
                { platform: 'Zalo', url: CONFIG.bizcardLinkZalo, icon: 'comment-dots', color: 'zalo-btn' },
                { platform: 'WhatsApp', url: CONFIG.bizcardLinkWhatsapp, icon: 'whatsapp', color: 'whatsapp-btn' },
                { platform: 'Viber', url: CONFIG.bizcardLinkViber, icon: 'phone', color: 'viber-btn' },
                { platform: 'WeChat', url: CONFIG.bizcardLinkWechat, icon: 'weixin', color: 'wechat-btn' }
            ];
            
            socialLinks.forEach(social => {
                if (social.url && social.url.trim() !== '') {
                    const btn = document.createElement('button');
                    btn.className = `social-btn ${social.color}`;
                    btn.title = social.platform;
                    btn.innerHTML = `<i class="fab fa-${social.icon} text-white"></i>`;
                    btn.onclick = (e) => {
                        e.preventDefault();
                        updateQRForSocial(social.url);
                        window.open(social.url, '_blank');
                    };
                    socialButtons.appendChild(btn);
                }
            });
        }
        
        function generateTextQR(qrDiv) {
            const qrText = CONFIG.bizcardQRText || 'https://lazinet.com/bizcards/vip/leminhphung-necs';
            try {
                new QRCode(qrDiv, {
                    text: qrText,
                    width: 80,
                    height: 80,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                currentSocialQR = qrText;
            } catch (error) {
                console.error('QR generation failed:', error);
                qrDiv.innerHTML = '<div class="text-xs text-center p-2">QR Code</div>';
            }
        }

        function renderBackCard() {
            // Set background
            const backBgUrl = CONFIG.bizcardBackgroundImage2 || 'https://lazinet.com/assets/img/background/LAZINET_BG_001_W2048.webp';
            document.getElementById('back-bg').src = backBgUrl;
            
            // Set logo
            const logoUrl = CONFIG.bizcardLogoURL || 'https://necs.vn/wp-content/uploads/2021/06/necs-log-vi.svg';
            document.getElementById('back-logo').src = logoUrl;
            
            // Set QR code
            const qrDiv = document.getElementById('back-qr');
            qrDiv.innerHTML = '';
            if (CONFIG.bizcardQRImage && CONFIG.bizcardQRImage.trim() !== '') {
                const img = document.createElement('img');
                img.src = CONFIG.bizcardQRImage;
                img.className = 'w-full h-full object-contain';
                qrDiv.appendChild(img);
            } else if (CONFIG.bizcardQRText) {
                try {
                    new QRCode(qrDiv, {
                        text: CONFIG.bizcardQRText,
                        width: 64,
                        height: 64,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (error) {
                    qrDiv.innerHTML = '<div class="text-xs text-center text-white p-1">QR</div>';
                }
            }
            
            // Set services
            const servicesCol1 = document.getElementById('services-col1');
            const servicesCol2 = document.getElementById('services-col2');
            servicesCol1.innerHTML = '';
            servicesCol2.innerHTML = '';
            
            const services = [
                CONFIG.bizcardBusiness1 || 'Cho thuê kho lạnh, kho mát, kho khô',
                CONFIG.bizcardBusiness2 || 'Kho ngoại quan lạnh lớn nhất VN',
                CONFIG.bizcardBusiness3 || 'Chia chọn, phân loại/ size hàng hóa',
                CONFIG.bizcardBusiness4 || 'Cảng quốc tế',
                CONFIG.bizcardBusiness5 || 'Đại lý hải quan',
                CONFIG.bizcardBusiness6 || 'Hỗ trợ tài chính'
            ];
            
            services.forEach((service, index) => {
                if (service && service.trim() !== '') {
                    const li = document.createElement('li');
                    li.className = 'flex items-start gap-2';
                    li.innerHTML = `
                        <i class="fas fa-check text-green-400 mt-0.5 text-xs"></i>
                        <span>${service}</span>
                    `;
                    
                    if (index < 3) {
                        servicesCol1.appendChild(li);
                    } else {
                        servicesCol2.appendChild(li);
                    }
                }
            });
            
            // Set contact info
            document.getElementById('back-phone').textContent = CONFIG.bizcardPersonMobile || '0901494666';
            document.getElementById('back-email').textContent = CONFIG.bizcardPersonEmail || 'phunglm@necs.vn';
            const websiteText = (CONFIG.bizcardPompanyWebsite || 'https://necs.vn').replace(/^https?:\/\//, '');
            document.getElementById('back-website').textContent = websiteText;
            document.getElementById('back-address').textContent = CONFIG.bizcardCompanyAddress || 'Lầu 8, 262 Nam Kỳ Khởi Nghĩa, phường Xuân Hòa, TP.HCM';
        }

        function updateQRForSocial(url) {
            const qrDiv = document.getElementById('front-qr');
            qrDiv.innerHTML = '';
            
            // Generate QR for the social media URL
            try {
                new QRCode(qrDiv, {
                    text: url,
                    width: 80,
                    height: 80,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Revert back to original QR after 10 seconds
                setTimeout(() => {
                    if (currentSocialQR) {
                        qrDiv.innerHTML = '';
                        if (currentSocialQR.includes('http') || currentSocialQR.includes('.')) {
                            const img = document.createElement('img');
                            img.src = currentSocialQR;
                            img.className = 'w-full h-full object-contain';
                            qrDiv.appendChild(img);
                        } else {
                            generateTextQR(qrDiv);
                        }
                    }
                }, 10000);
            } catch (error) {
                console.error('QR update failed:', error);
            }
        }

        // Chat Functions
        function openChatForm() {
            const chatSection = document.getElementById('chat-section');
            chatSection.classList.add('open');
            setTimeout(() => {
                chatSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function closeChatForm() {
            const chatSection = document.getElementById('chat-section');
            chatSection.classList.remove('open');
        }

        document.getElementById('contact-form-element').onsubmit = async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('form-name').value,
                company: document.getElementById('form-company').value,
                phone: document.getElementById('form-phone').value,
                email: document.getElementById('form-email').value,
                message: document.getElementById('form-message').value,
                wantConsult: document.getElementById('form-consult').checked
            };
            
            // Validate
            if (!formData.name || !formData.phone || !formData.email) {
                alert('Vui lòng nhập đầy đủ thông tin bắt buộc (Họ tên, SĐT, Email)');
                return;
            }
            
            try {
                const result = await callAPI('submitForm', formData);
                
                if (result.status === 'success') {
                    alert('Đã gửi thông tin thành công! Chúng tôi sẽ liên hệ với bạn sớm.');
                    
                    if (formData.wantConsult) {
                        // Switch to chat interface
                        document.getElementById('contact-form').classList.add('hidden');
                        document.getElementById('chat-interface').classList.remove('hidden');
                        document.getElementById('chat-interface').classList.add('flex');
                        
                        // Add initial message
                        addChatMessage('user', formData.message || 'Tôi muốn được tư vấn');
                        simulateBotResponse(formData);
                    } else {
                        closeChatForm();
                        // Reset form
                        this.reset();
                    }
                } else {
                    alert('Lỗi: ' + (result.message || 'Không rõ'));
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Không thể gửi thông tin. Vui lòng thử lại sau.');
            }
        };

        function simulateBotResponse(userData) {
            setTimeout(async () => {
                const greeting = `Xin chào ${userData.name}! Tôi là ${CONFIG.chatbotName || 'Mai Anh Đào'}, ${CONFIG.chatbotPosition || 'Thư ký PTGĐ'} của ${CONFIG.bizcardCompanyName || 'NECS'}. Rất vui được hỗ trợ bạn!`;
                addChatMessage('bot', greeting);
                
                if (userData.message && userData.message.trim() !== '') {
                    // If user had a message in form, respond to it
                    await sendToAI(userData.message);
                }
            }, 1000);
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
            messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-bubble bot-bubble';
            typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            document.getElementById('chat-messages').appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Send to AI
            await sendToAI(message);
            
            // Remove typing indicator
            typingDiv.remove();
        }

        async function sendToAI(message) {
            try {
                const result = await callAPI('chatAI', { message: message });
                
                if (result.status === 'success') {
                    addChatMessage('bot', result.reply);
                } else {
                    addChatMessage('bot', result.reply || 'Xin lỗi, tôi không thể trả lời ngay lúc này. Vui lòng liên hệ trực tiếp qua số điện thoại.');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addChatMessage('bot', 'Kết nối AI đang gặp sự cố. Vui lòng thử lại sau hoặc liên hệ trực tiếp.');
            }
        }

        // Export Functions
        async function exportCard(type) {
            const container = document.getElementById('export-container');
            container.innerHTML = '';
            
            // Create high-res version for export
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 20px;
                width: 600px;
                padding: 20px;
                background: white;
            `;
            
            // Clone front card
            const frontClone = document.getElementById('front-card').cloneNode(true);
            frontClone.style.cssText = `
                width: 540px;
                height: 324px;
                transform: none;
                box-shadow: none;
                margin: 0;
            `;
            
            // Clone back card
            const backClone = document.getElementById('back-card').cloneNode(true);
            backClone.style.cssText = `
                width: 540px;
                height: 324px;
                transform: none;
                box-shadow: none;
                margin: 0;
            `;
            
            wrapper.appendChild(frontClone);
            wrapper.appendChild(backClone);
            container.appendChild(wrapper);
            
            // Wait for images to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            try {
                const canvas = await html2canvas(wrapper, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true
                });
                
                if (type === 'png') {
                    const link = document.createElement('a');
                    link.download = `${CONFIG.bizcardPersonName || 'business-card'}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } else {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${CONFIG.bizcardPersonName || 'business-card'}.pdf`);
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Lỗi xuất file! Vui lòng thử lại.');
            } finally {
                container.innerHTML = '';
            }
        }

        function downloadVCard() {
            const vCard = `BEGIN:VCARD
VERSION:3.0
N:${CONFIG.bizcardPersonName || ''}
FN:${CONFIG.bizcardPersonName || ''}
ORG:${CONFIG.bizcardCompanyName || ''}
TITLE:${CONFIG.bizcardPersonPosition || ''}
TEL;TYPE=WORK,VOICE:${CONFIG.bizcardPersonMobile || ''}
EMAIL:${CONFIG.bizcardPersonEmail || ''}
URL:${CONFIG.bizcardPompanyWebsite || ''}
ADR;TYPE=WORK:;;${CONFIG.bizcardCompanyAddress || ''}
NOTE:${CONFIG.bizcardCompanyName || ''}
END:VCARD`;
            
            const blob = new Blob([vCard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${CONFIG.bizcardPersonName || 'contact'}.vcf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function shareCard() {
            const shareData = {
                title: CONFIG.bizcardPersonName || 'Business Card',
                text: `${CONFIG.bizcardPersonName} - ${CONFIG.bizcardPersonPosition} tại ${CONFIG.bizcardCompanyName}`,
                url: window.location.href
            };
            
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                navigator.share(shareData);
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Đã sao chép link vào clipboard!');
            }
        }

        // Language Functions
        function changeLanguage(lang) {
            // Simple translation example
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                if (lang === 'en') {
                    // Add English translations here
                    if (key === 'header-greeting') {
                        el.textContent = 'Pleased to cooperate with you';
                    }
                } else {
                    if (key === 'header-greeting') {
                        el.textContent = 'Hân hạnh hợp tác cùng quý khách';
                    }
                }
            });
        }

        // Load sample data if API fails
        function loadSampleData() {
            CONFIG = {
                bizcardPersonName: 'Lê Minh Phụng',
                bizcardPersonPosition: 'Phó Tổng Giám đốc',
                bizcardCompanyName: 'Công ty Cổ phần Kho Lạnh Kỷ Nguyên Mới (NECS)',
                bizcardPersonMobile: '0901494666',
                bizcardPersonEmail: 'phunglm@necs.vn',
                bizcardPompanyWebsite: 'https://necs.vn',
                bizcardCompanyAddress: 'Lầu 8, 262 Nam Kỳ Khởi Nghĩa, phường Xuân Hòa, TP.HCM',
                bizcardCompanyAddress2: 'B28-2 Đường Dọc 2, KCN Phú An Thạnh, Bến Lức, Long An',
                bizcardBusiness1: 'Cho thuê kho lạnh, kho mát, kho khô',
                bizcardBusiness2: 'Kho ngoại quan lạnh lớn nhất VN',
                bizcardBusiness3: 'Chia chọn, phân loại/ size hàng hóa',
                bizcardBusiness4: 'Cảng quốc tế',
                bizcardBusiness5: 'Đại lý hải quan',
                bizcardBusiness6: 'Hỗ trợ tài chính',
                chatbotName: 'Mai Anh Đào',
                chatbotPosition: 'Thư ký PTGĐ',
                htmlTitle: 'Mr. Lê Minh Phụng - Phó Tổng Giám đốc Công ty Cổ phần Kho Lạnh Kỷ Nguyên Mới (NECS)'
            };
            
            initializePage();
        }

        // Handle Enter key in chat
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Google Translate
        function googleTranslateElementInit() {
            if (typeof google !== 'undefined' && google.translate) {
                new google.translate.TranslateElement({
                    pageLanguage: CONFIG.htmlPrimaryLanguage || 'vi',
                    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
                }, 'google_translate_element');
            }
        }
    </script>
</body>
</html>