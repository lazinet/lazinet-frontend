<!DOCTYPE html>
<html lang="vi-VN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh mục Sản phẩm - LAZINET</title>
    <style>
        /* CSS từ lazinet-support-pricing.html và products_done.html */
        .filter-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            color: #ff6500;
            border-radius: 8px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #0052FF;
            background: white;
            color: #0052FF;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #0052FF;
            color: white;
        }
        
        .filter-btn:hover {
            background: #0052FF;
            color: white;
        }
        
        .product-description {
            margin: 20px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #0052FF;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .pricing-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            background: white;
        }
        
        .pricing-card.popular {
            border: 2px solid #0052FF;
            transform: scale(1.05);
        }
        
        .popular-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #0052FF;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .pricing-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #0052FF;
        }
        
        .features-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .features-list li {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-btn {
            width: 100%;
            padding: 10px;
            background: #0052FF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .order-btn:hover {
            background: #003cb3;
        }
        
        /* Popup styles */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            z-index: 1001;
            min-width: 400px;
            max-width: 90vw;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .close-popup {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Filter Section -->
        <div class="filter-container">
            <div class="filter-row" id="product-filters">
                <!-- Product type filters will be loaded here -->
            </div>
            <div class="filter-row" id="group-filters">
                <!-- Group filters will be loaded here -->
            </div>
        </div>
        
        <!-- Product Description -->
        <div class="product-description" id="product-description">
            <!-- Product description will be loaded here -->
        </div>
        
        <!-- Pricing Grid -->
        <div class="pricing-grid" id="pricing-grid">
            <!-- Product cards will be loaded here -->
        </div>
    </div>
    
    <!-- Order Popup -->
    <div class="popup-overlay" id="order-popup-overlay">
        <div class="popup-content">
            <button class="close-popup" onclick="closeOrderPopup()">×</button>
            <h3 id="popup-product-name">Đặt hàng</h3>
            <div id="popup-product-info"></div>
            
            <form id="order-form">
                <input type="hidden" id="product-code" name="productCode">
                
                <div class="form-group">
                    <label for="customer-name">Quý danh *</label>
                    <input type="text" id="customer-name" name="customerName" required>
                </div>
                
                <div class="form-group">
                    <label for="customer-email">Email *</label>
                    <input type="email" id="customer-email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="customer-mobile">Số điện thoại *</label>
                    <input type="tel" id="customer-mobile" name="mobile" required>
                </div>
                
                <div class="form-group">
                    <label for="customer-notes">Ghi chú</label>
                    <textarea id="customer-notes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="order-btn">Gửi đơn hàng</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbx9RrGnD1YS8sUi-vneCa1NLT75134vANge5al4oP5qD7KLZeScJ9FYxjeiUpwr5j3HNw/exec';

        // Proxy function để tránh CORS
        async function makeRequest(action, data = null) {
        const url = `${API_URL}?action=${action}`;
        
        try {
            if (data) {
            // POST request
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
            } else {
            // GET request - sử dụng no-cors nếu cần
            const response = await fetch(url, {
                method: 'GET',
                mode: 'no-cors' // Thêm dòng này để tránh CORS
            });
            
            // Với no-cors, response sẽ bị limited
            // Chúng ta cần một cách tiếp cận khác
            return await fetchWithJSONP(action);
            }
        } catch (error) {
            console.error('Request failed:', error);
            throw error;
        }
        }

        // Fallback sử dụng JSONP cho GET requests
        function fetchWithJSONP(action) {
        return new Promise((resolve, reject) => {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            
            window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve(data);
            };

            const script = document.createElement('script');
            script.src = `${API_URL}?action=${action}&callback=${callbackName}`;
            script.onerror = reject;
            document.body.appendChild(script);
        });
        }

        // Hoặc sử dụng XMLHttpRequest thay vì fetch
        function makeXHRRequest(action, data = null) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const url = data ? `${API_URL}?action=${action}` : `${API_URL}?action=${action}`;
            
            xhr.open(data ? 'POST' : 'GET', url, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    resolve(response);
                } catch (e) {
                    reject(new Error('Invalid JSON response'));
                }
                } else {
                reject(new Error(`Request failed with status ${xhr.status}`));
                }
            }
            };
            
            xhr.onerror = function() {
            reject(new Error('Network error'));
            };
            
            if (data) {
            xhr.send(JSON.stringify(data));
            } else {
            xhr.send();
            }
        });
        }

        // Sửa hàm loadProducts
        async function loadProducts() {
        try {
            // Thử XMLHttpRequest trước
            const products = await makeXHRRequest('getProducts');
            allProducts = products;
            initializeFilters();
            applyFilters();
        } catch (error) {
            console.error('Error loading products:', error);
            
            // Fallback: thử fetch với no-cors
            try {
            const response = await fetch(`${API_URL}?action=getProducts`, {
                method: 'GET',
                mode: 'no-cors',
                cache: 'no-cache'
            });
            
            // Với no-cors, chúng ta không thể đọc response
            // Cần có giải pháp khác như server proxy
            showError('Không thể tải danh mục sản phẩm. Vui lòng thử lại sau.');
            } catch (fallbackError) {
            showError('Lỗi kết nối: ' + fallbackError.message);
            }
        }
        }

        // Sửa hàm submitOrder
        async function submitOrder(formData) {
        try {
            const result = await makeXHRRequest('submitOrder', formData);
            
            if (result.status === 'success') {
            alert('Đơn hàng đã được gửi thành công! Chúng tôi sẽ liên hệ với bạn trong thời gian sớm nhất.');
            closeOrderPopup();
            } else {
            throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error submitting order:', error);
            
            // Fallback: sử dụng form submission truyền thống
            submitOrderFallback(formData);
        }
        }

        // Fallback cho submit order
        function submitOrderFallback(formData) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = API_URL + '?action=submitOrder';
        form.style.display = 'none';
        
        Object.keys(formData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = formData[key];
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        }

        function setupEventListeners() {
            // Order form submission
            document.getElementById('order-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    productCode: document.getElementById('product-code').value,
                    customerName: document.getElementById('customer-name').value,
                    email: document.getElementById('customer-email').value,
                    mobile: document.getElementById('customer-mobile').value,
                    notes: document.getElementById('customer-notes').value
                };
                
                await submitOrder(formData);
            });
            
            // Close popup when clicking outside
            document.getElementById('order-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'order-popup-overlay') {
                    closeOrderPopup();
                }
            });
        }

        function showError(message) {
            const pricingGrid = document.getElementById('pricing-grid');
            pricingGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>