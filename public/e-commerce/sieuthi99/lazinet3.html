<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management</title>
  <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #E6ECF5;
      color: #0A3161;
      font-family: 'Roboto', sans-serif;
    }
    .container {
      width: 100%;
      padding: 0 1rem;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #FFFFFF;
      color: #0A3161;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #0A3161;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 90%;
      max-width: 600px;
      padding: 2rem;
    }
    .popup.active {
      display: block;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .overlay.active {
      display: block;
    }
    table {
      background-color: #FFFFFF;
      color: #0A3161;
      table-layout: fixed;
      width: 100%;
      margin: 0 auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #0A3161;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #0A3161;
      color: #FFFFFF;
      font-weight: 700;
    }
    .image-cell {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 80px;
      padding: 4px;
    }
    .table-img {
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
      border-radius: 4px;
    }
    .popup-img {
      width: 90%;
      max-height: 200px;
      object-fit: contain;
      margin: 0 auto;
      display: block;
    }
    .hover\:bg-red-700:hover {
      background-color: #B31942;
      color: #FFFFFF;
    }
    .tab {
      padding: 0.5rem 1rem;
      font-weight: 600;
      border: 1px solid #0A3161;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      margin-right: 0.25rem;
    }
    .tab.active {
      background-color: #0A3161;
      color: white;
    }
    .tab.inactive {
      background-color: white;
      color: #0A3161;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .pagination button, .pagination select {
      padding: 0.25rem 0.5rem;
      border: 1px solid #0A3161;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
    }
    .pagination button.active {
      background-color: #0A3161;
      color: white;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .error-message {
      color: #B31942;
      text-align: center;
      margin: 1rem 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container py-6">
    <h1 class="text-center font-bold mb-6 text-[#0A3161]">Product Management</h1>

    <!-- Tabs -->
    <div id="tabs" class="flex border-b border-[#0A3161] mb-4"></div>

    <!-- Tab Contents -->
    <div id="tab-contents" class="mt-4"></div>

    <!-- Popup Overlay -->
    <div id="popup-overlay" class="overlay"></div>

    <!-- Popup -->
    <div id="popup" class="popup">
      <button id="close-popup" class="absolute top-2 right-2 text-[#0A3161] font-bold text-xl">Ã—</button>
      <h2 id="popup-title" class="font-bold mb-2"></h2>
      <img id="popup-image" class="popup-img mb-4" src="" alt="Product Image" style="display: none;">
      <div id="popup-details" class="space-y-2">
        <table class="w-full">
          <tbody id="popup-details-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbxhxNuS-jp70oyke_nwsEKlueIQorpNbnggL6pZ1w5SLXE6sDtU8rIsxrrBNoIKFkw6iA/exec';
    let allProducts = [];
    let currentProductIndex = -1;
    let paginationConfig = {
      currentPage: 1,
      itemsPerPage: 10,
      itemsPerPageOptions: [10, 20, 30]
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadProducts();
        setupEventListeners();
      } catch (error) {
        showError('Failed to initialize application: ' + error.message);
      }
    });

    // Load products from API
    async function loadProducts() {
      try {
        const response = await fetch(`${API_URL}?action=getProducts`);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        allProducts = Array.isArray(data) ? data : [];
        displayProducts(allProducts);
      } catch (error) {
        console.error('Error loading products:', error);
        showError('Error loading products: ' + error.message);
      }
    }

    // Display products with tabs and pagination
    function displayProducts(products) {
      const origins = [...new Set(products.map(p => p.origin || 'Unknown'))];
      const tabsContainer = document.getElementById('tabs');
      const tabContentsContainer = document.getElementById('tab-contents');

      tabsContainer.innerHTML = '';
      tabContentsContainer.innerHTML = '';

      origins.forEach((origin, index) => {
        // Create tab
        const tab = document.createElement('button');
        tab.className = `tab ${index === 0 ? 'active' : 'inactive'}`;
        tab.textContent = origin;
        tab.onclick = () => switchTab(origin);
        tabsContainer.appendChild(tab);

        // Create tab content
        const tabContent = document.createElement('div');
        tabContent.id = `tab-${origin}`;
        tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
        tabContentsContainer.appendChild(tabContent);

        // Render products for this tab
        const filteredProducts = products.filter(p => (p.origin || 'Unknown') === origin);
        renderProducts(tabContent, filteredProducts);
      });
    }

    // Render products table with pagination
    function renderProducts(container, products) {
      container.innerHTML = '';

      if (products.length === 0) {
        container.innerHTML = '<p class="text-center py-4">No products found</p>';
        return;
      }

      const totalPages = Math.ceil(products.length / paginationConfig.itemsPerPage);
      const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.itemsPerPage;
      const endIndex = Math.min(startIndex + paginationConfig.itemsPerPage, products.length);
      const paginatedProducts = products.slice(startIndex, endIndex);

      renderTable(container, paginatedProducts);
      renderPagination(container, products.length, totalPages);
    }

    // Render products table
    function renderTable(container, products) {
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width: 8%">ID</th>
            <th style="width: 15%">Image</th>
            <th style="width: 15%">Code</th>
            <th style="width: 25%">Name</th>
            <th style="width: 12%">Weight</th>
            <th style="width: 12%">Unit Price</th>
            <th style="width: 13%">Case Price</th>
          </tr>
        </thead>
        <tbody>
          ${products.map(product => `
            <tr class="hover:bg-red-700 cursor-pointer" onclick="showProductDetail(${allProducts.indexOf(product)})">
              <td class="text-center">${product.id}</td>
              <td class="image-cell">
                ${product.image_url ? `<img src="${product.image_url}" alt="${product.product_name}" class="table-img" onerror="this.style.display='none'">` : 'No Image'}
              </td>
              <td>${product.product_code || '-'}</td>
              <td>${product.product_name || '-'}</td>
              <td>${product.net_weight || '-'}</td>
              <td>${product.unit_price || '-'}</td>
              <td>${product.case_price || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      `;
      container.appendChild(table);
    }

    // Render pagination controls
    function renderPagination(container, totalItems, totalPages) {
      const paginationDiv = document.createElement('div');
      paginationDiv.className = 'pagination';

      // Items per page dropdown
      const select = document.createElement('select');
      select.className = 'mr-4';
      select.innerHTML = paginationConfig.itemsPerPageOptions.map(option => 
        `<option value="${option}" ${option === paginationConfig.itemsPerPage ? 'selected' : ''}>${option} per page</option>`
      ).join('');
      
      select.addEventListener('change', (e) => {
        paginationConfig.itemsPerPage = parseInt(e.target.value);
        paginationConfig.currentPage = 1;
        const origin = container.id.replace('tab-', '');
        const filteredProducts = allProducts.filter(p => (p.origin || 'Unknown') === origin);
        renderProducts(container, filteredProducts);
      });

      // Previous button
      const prevButton = document.createElement('button');
      prevButton.textContent = 'Previous';
      prevButton.disabled = paginationConfig.currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (paginationConfig.currentPage > 1) {
          paginationConfig.currentPage--;
          const origin = container.id.replace('tab-', '');
          const filteredProducts = allProducts.filter(p => (p.origin || 'Unknown') === origin);
          renderProducts(container, filteredProducts);
        }
      });

      // Page buttons
      const pageButtons = [];
      const startPage = Math.max(1, paginationConfig.currentPage - 1);
      const endPage = Math.min(totalPages, paginationConfig.currentPage + 1);

      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = i === paginationConfig.currentPage ? 'active' : '';
        pageButton.addEventListener('click', () => {
          paginationConfig.currentPage = i;
          const origin = container.id.replace('tab-', '');
          const filteredProducts = allProducts.filter(p => (p.origin || 'Unknown') === origin);
          renderProducts(container, filteredProducts);
        });
        pageButtons.push(pageButton);
      }

      // Next button
      const nextButton = document.createElement('button');
      nextButton.textContent = 'Next';
      nextButton.disabled = paginationConfig.currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (paginationConfig.currentPage < totalPages) {
          paginationConfig.currentPage++;
          const origin = container.id.replace('tab-', '');
          const filteredProducts = allProducts.filter(p => (p.origin || 'Unknown') === origin);
          renderProducts(container, filteredProducts);
        }
      });

      // Info text
      const infoText = document.createElement('span');
      const startItem = (paginationConfig.currentPage - 1) * paginationConfig.itemsPerPage + 1;
      const endItem = Math.min(paginationConfig.currentPage * paginationConfig.itemsPerPage, totalItems);
      infoText.textContent = `Showing ${startItem}-${endItem} of ${totalItems}`;
      infoText.className = 'ml-4';

      // Assemble pagination controls
      paginationDiv.appendChild(select);
      paginationDiv.appendChild(prevButton);
      pageButtons.forEach(button => paginationDiv.appendChild(button));
      paginationDiv.appendChild(nextButton);
      paginationDiv.appendChild(infoText);

      container.appendChild(paginationDiv);
    }

    // Switch between tabs
    function switchTab(origin) {
      // Reset pagination when switching tabs
      paginationConfig.currentPage = 1;

      // Update active tab
      document.querySelectorAll('#tabs button').forEach(tab => {
        tab.className = tab.textContent === origin ? 'tab active' : 'tab inactive';
      });

      // Update tab content visibility
      document.querySelectorAll('.tab-content').forEach(content => {
        content.className = content.id === `tab-${origin}` ? 'tab-content active' : 'tab-content';
      });

      // Re-render products for the active tab
      const activeTabContent = document.getElementById(`tab-${origin}`);
      const filteredProducts = allProducts.filter(p => (p.origin || 'Unknown') === origin);
      renderProducts(activeTabContent, filteredProducts);
    }

    // Show product details popup
    function showProductDetail(index) {
      currentProductIndex = index;
      const product = allProducts[index];
      const popup = document.getElementById('popup');
      const overlay = document.getElementById('popup-overlay');
      const popupTitle = document.getElementById('popup-title');
      const popupImage = document.getElementById('popup-image');
      const popupDetailsTable = document.getElementById('popup-details-table');

      // Set popup content
      popupTitle.textContent = product.product_name || 'Unknown Product';
      popupImage.src = product.image_url || '';
      popupImage.style.display = product.image_url ? 'block' : 'none';

      // Display product details
      popupDetailsTable.innerHTML = Object.entries(product)
        .filter(([key, value]) => 
          value !== undefined && 
          value !== '' && 
          !['id', 'image_url', 'product_name'].includes(key)
        )
        .map(([key, value]) => `
          <tr>
            <td class="font-medium py-1">${formatKey(key)}</td>
            <td class="py-1">${formatValue(value)}</td>
          </tr>
        `).join('');

      // Show popup
      popup.classList.remove('hidden');
      overlay.classList.remove('hidden');
    }

    // Format table key
    function formatKey(key) {
      return key.replace(/_/g, ' ')
               .replace(/\b\w/g, l => l.toUpperCase());
    }

    // Format table value
    function formatValue(value) {
      if (typeof value === 'string' && value.match(/^https?:\/\//)) {
        return `<a href="${value}" target="_blank" class="text-blue-600 hover:underline">Link</a>`;
      }
      return value || '-';
    }

    // Close popup
    function closePopup() {
      document.getElementById('popup').classList.add('hidden');
      document.getElementById('popup-overlay').classList.add('hidden');
      currentProductIndex = -1;
    }

    // Show error message
    function showError(message) {
      const tabContents = document.getElementById('tab-contents');
      tabContents.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Close popup buttons
      document.getElementById('close-popup').addEventListener('click', closePopup);
      document.getElementById('popup-overlay').addEventListener('click', closePopup);

      // Make functions available globally
      window.showProductDetail = showProductDetail;
    }
  </script>
</body>
</html>